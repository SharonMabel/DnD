<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ilio Xaenor - Charakterbogen</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&family=MedievalSharp&display=swap');

    :root {
      --bg-color: #4747cd; 
      --card-bg-color: #204d78; 
      --text-color: #f0f0f0; 
      --primary-color: #1771cb; 
      --secondary-color: #428fe1; 
      --accent-color: #c8d9e6; 
      --border-color: #44475a; 
      --font-sans-serif: 'Roboto', sans-serif;
      --font-serif: 'MedievalSharp', cursive;
    }

    body {
      font-family: var(--font-sans-serif);
      background-color: var(--bg-color);
      color: var(--text-color);
      margin: 0;
      padding: 15px;
      line-height: 1.6;
      font-size: 16px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 3fr 1fr;
      gap: 20px;
    }

    .main-column {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .sidebar {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    
    .char-portrait-container {
        background-color: var(--card-bg-color);
        padding: 15px;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        text-align: center;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }

    #char-portrait-img {
        max-width: 100%;
        height: auto;
        border-radius: 6px;
        border: 2px solid var(--accent-color);
    }
    
    .card {
      background-color: var(--card-bg-color);
      padding: 20px;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }

    h1, h2, h3 {
      font-family: var(--font-serif);
      color: var(--primary-color);
      margin-top: 0;
      margin-bottom: 15px;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
    }
    h1 { font-size: 2.5em; text-align: center; }
    h2 { font-size: 1.8em; border-bottom: 1px solid var(--accent-color); padding-bottom: 10px;}
    h3 { font-size: 1.4em; color: var(--accent-color); }

    p { margin-bottom: 10px; }
    ul { padding-left: 20px; margin-bottom: 10px; }

    button, input[type="button"], input[type="submit"] {
      font-family: var(--font-sans-serif);
      font-size: 1em;
      background-color: var(--primary-color);
      color: var(--text-color);
      border: none;
      padding: 10px 15px;
      margin: 5px;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s ease, transform 0.2s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    button:hover, input[type="button"]:hover, input[type="submit"]:hover {
      background-color: var(--secondary-color);
      transform: translateY(-2px);
    }
    button:active {
        transform: translateY(0px);
    }

    input[type="number"], input[type="text"], select {
      font-family: var(--font-sans-serif);
      font-size: 1em;
      background-color: rgba(255,255,255,0.1);
      color: var(--text-color);
      border: 1px solid var(--border-color);
      padding: 8px 12px;
      margin: 5px 0;
      border-radius: 5px;
      width: auto;
    }
    input[type="number"] { text-align: center; width: 60px; }

    .header-info { text-align: center; }
    .character-basics { font-size: 1.1em; margin-bottom: 15px; }
    .character-basics span { margin: 0 8px; }

    .attributes-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    .attribute {
      text-align: center;
      padding: 15px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      background-color: rgba(0,0,0,0.2);
    }
    .attribute-name { font-family:var(--font-serif); font-size: 1.3em; color: var(--primary-color); margin-bottom: 5px; }
    .attribute-value-container { display: flex; align-items: center; justify-content: center; margin: 5px 0; }
    .attribute-value { font-size: 1.8em; font-weight: bold; margin: 0 10px;}
    .attr-button {
        background-color: var(--secondary-color);
        color: var(--text-color);
        border: none;
        width: 25px;
        height: 25px;
        font-size: 1em;
        border-radius: 50%;
        cursor: pointer;
        line-height: 25px; /* Vertikal zentrieren */
        text-align: center;
    }
    .attr-button:hover { background-color: var(--primary-color); }
    .attribute-mod { font-size: 1.5em; color: var(--accent-color); }
    
    .hp-section { margin-bottom: 20px; }
    .hp-bar-container { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
    .hp-display { font-weight: bold; white-space: nowrap; font-size: 1.2em; }
    .hp-bar { flex-grow: 1; height: 25px; border: 1px solid var(--border-color); background: rgba(0,0,0,0.3); border-radius: 12px; position: relative; overflow: hidden;}
    .hp-fill { position: absolute; left: 0; top: 0; height: 100%; background: linear-gradient(90deg, var(--accent-color), var(--primary-color)); transition: width 0.3s ease; }
    .hp-buttons button { width: 40px; height: 40px; font-size: 1.2em; }
    .hp-extra-content { border: 1px dashed var(--border-color); padding: 10px; margin-top:10px; border-radius: 6px;}

    .tab-bar { display: flex; margin-bottom: 20px; border-radius: 6px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.2);}
    .tab { flex: 1; text-align: center; padding: 12px 10px; background: var(--secondary-color); cursor: pointer; font-size: 1em; font-weight: bold; transition: background-color 0.3s ease;}
    .tab.active { background: var(--primary-color); }
    .tab:not(.active):hover { background: #5a1aa0; }
    .tab-content { display: none; }
    .tab-content.active { display: block; animation: fadeIn 0.5s; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    .toggle-container { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px; }
    .toggle { padding: 8px 15px; border: 1px solid var(--border-color); border-radius: 20px; cursor: pointer; font-size: 0.9em; background: rgba(255,255,255,0.1); transition: background-color 0.3s, color 0.3s;}
    .toggle.active { background: var(--accent-color); color: var(--bg-color); font-weight: bold;}
    .toggle.resource-limited.disabled { opacity: 0.5; cursor: default; background: #555; }
    
    .info-list { list-style: none; padding: 0; }
    .info-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border-color); }
    .info-item:last-child { border-bottom: none; }
    .info-label { opacity: 0.8; }
    .info-value { font-weight: bold; color: var(--accent-color); }
    .proficient::after { content: "âœ¶"; margin-left: 5px; color: var(--accent-color); }

    .dice-result-display { padding: 15px; text-align: center; margin-top:15px; background-color: rgba(0,0,0,0.2); border-radius: 6px; }
    .dice-result-value { font-size: 2em; font-weight: bold; margin: 10px 0; min-height: 40px; color: var(--accent-color); }
    .dice-buttons button { background-color: var(--secondary-color); }
    .dice-buttons button:hover { background-color: var(--primary-color); }
    #btn-roll-quarry.disabled { background-color: #555; color: #888; cursor:not-allowed; }
    #btn-roll-quarry:not(.disabled):hover { background-color: var(--primary-color); }
    
    .damage-input-section { margin-top: 15px; }
    .damage-input-section label { margin-right: 5px; }
    .damage-input-section input[type="number"] { width: 70px; margin-right: 10px;}


    .collapsible-header { background: var(--secondary-color); padding: 10px; cursor: pointer; font-weight: bold; border-radius: 4px; margin-bottom: 2px; transition: background-color 0.3s;}
    .collapsible-header:hover { background: var(--primary-color); }
    .collapsible-content { padding: 15px; display: none; background-color: rgba(0,0,0,0.1); border-radius: 0 0 4px 4px;}
    
    .inventory-table { width: 100%; border-collapse: collapse; font-size: 0.95em; margin-bottom: 15px; }
    .inventory-table th, .inventory-table td { border: 1px solid var(--border-color); padding: 10px; text-align: left; }
    .inventory-table th { background: var(--secondary-color); font-family: var(--font-serif); font-size:1.1em; }
    .inventory-add-form { display:flex; flex-wrap:wrap; gap:10px; align-items:flex-end; }
    .inventory-add-form label { display:block; margin-bottom:5px; font-size:0.9em; opacity:0.8;}
    .inventory-add-form div { flex:1 1 auto; }
    .inventory-summary { font-size: 0.9em; margin-top: 15px; padding: 10px; border: 1px solid var(--border-color); border-radius:6px; background-color:rgba(0,0,0,0.2);}
    .delete-button { background: #c0392b; color:white; padding: 3px 8px; border-radius:4px; text-decoration:none; font-size:0.9em;}
    .delete-button:hover { background: #e74c3c; }

    .action-table { width: 100%; border-collapse: collapse; font-size: 0.95em; margin-bottom: 15px; }
    .action-table th, .action-table td { border: 1px solid var(--border-color); padding: 10px; text-align: left; }
    .action-table th { background: var(--secondary-color); font-family: var(--font-serif); font-size:1.1em; }
    .action-checkbox { margin-left:10px; transform: scale(1.3); }


    @media (max-width: 900px) {
        .container {
            grid-template-columns: 1fr; /* Stack main and sidebar */
        }
        .sidebar {
            order: -1; /* Move sidebar to top on smaller screens */
        }
    }
     @media (max-width: 600px) {
        .attributes-grid {
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        }
        h1 { font-size: 2em; }
        .hp-bar-container { flex-direction: column; align-items: stretch; }
        .hp-buttons { justify-content: center; margin-top:10px; }
        .tab-bar { flex-direction:column; }
        .tab { border-bottom: 1px solid var(--border-color); border-left:none !important; }
    }

  </style>
</head>
<body>
  <div class="container">
    <div class="main-column">
      <div class="card header-info">
          <h1 id="char-name">Ilio Xaenor</h1>
          <div class="character-basics">
              <span id="char-details">Waldelf Gloom Stalker 4 / Rogue 1</span> |
              RK: <span id="ac-value">16</span> |
              Bewegung: <span id="speed-value">35</span>ft |
              Init: <span id="initiative-value">+7</span> | 
              PB: <span id="pb-value">+4</span>
          </div>
      </div>

      <div class="card attributes-grid">
          <div class="attribute">
              <div class="attribute-name">STR</div>
              <div class="attribute-value-container">
                <button class="attr-button" onclick="changeAttribute('str', -1)">-</button>
                <span class="attribute-value" id="str-value">10</span>
                <button class="attr-button" onclick="changeAttribute('str', 1)">+</button>
              </div>
              <div class="attribute-mod" id="str-mod">+0</div>
          </div>
           <div class="attribute">
              <div class="attribute-name">DEX</div>
              <div class="attribute-value-container">
                <button class="attr-button" onclick="changeAttribute('dex', -1)">-</button>
                <span class="attribute-value" id="dex-value">18</span>
                <button class="attr-button" onclick="changeAttribute('dex', 1)">+</button>
              </div>
              <div class="attribute-mod" id="dex-mod">+4</div>
          </div>
           <div class="attribute">
              <div class="attribute-name">CON</div>
              <div class="attribute-value-container">
                <button class="attr-button" onclick="changeAttribute('con', -1)">-</button>
                <span class="attribute-value" id="con-value">14</span>
                <button class="attr-button" onclick="changeAttribute('con', 1)">+</button>
              </div>
              <div class="attribute-mod" id="con-mod">+2</div>
          </div>
           <div class="attribute">
              <div class="attribute-name">INT</div>
              <div class="attribute-value-container">
                <button class="attr-button" onclick="changeAttribute('int', -1)">-</button>
                <span class="attribute-value" id="int-value">10</span>
                <button class="attr-button" onclick="changeAttribute('int', 1)">+</button>
              </div>
              <div class="attribute-mod" id="int-mod">+0</div>
          </div>
           <div class="attribute">
              <div class="attribute-name">WIS</div>
              <div class="attribute-value-container">
                <button class="attr-button" onclick="changeAttribute('wis', -1)">-</button>
                <span class="attribute-value" id="wis-value">14</span>
                <button class="attr-button" onclick="changeAttribute('wis', 1)">+</button>
              </div>
              <div class="attribute-mod" id="wis-mod">+2</div>
          </div>
           <div class="attribute">
              <div class="attribute-name">CHA</div>
              <div class="attribute-value-container">
                <button class="attr-button" onclick="changeAttribute('cha', -1)">-</button>
                <span class="attribute-value" id="cha-value">10</span>
                <button class="attr-button" onclick="changeAttribute('cha', 1)">+</button>
              </div>
              <div class="attribute-mod" id="cha-mod">+0</div>
          </div>
      </div>

      <div class="card hp-section">
        <h2>Trefferpunkte &amp; Heilung</h2>
        <div class="hp-bar-container">
            <span class="hp-display">
                TP: <span id="current-hp">21</span>/<span id="max-hp">21</span><span id="temp-hp-display"></span>
            </span>
            <div class="hp-bar">
                <div class="hp-fill" id="hp-fill"></div>
            </div>
        </div>
        <div class="hp-buttons">
            <button onclick="modifyHP(-1)" title="-1 TP">-1</button>
            <button onclick="modifyHP(-5)" title="-5 TP">-5</button>
            <button onclick="modifyHP(1)" title="+1 TP">+1</button>
            <button onclick="modifyHP(5)" title="+5 TP">+5</button>
        </div>
        <div class="hp-extra-content" id="hp-extra">
            <h3>Temp TP / Bonus TP</h3>
            <label for="temp-hp-source-input">Quelle:</label>
            <input type="text" id="temp-hp-source-input" size="15" placeholder="z.B. Aid">
            <label for="temp-hp-amount-input">Menge:</label>
            <input type="number" id="temp-hp-amount-input" value="1" min="0">
            <label for="temp-hp-type-select">Typ:</label>
            <select id="temp-hp-type-select">
                <option value="temp">Temp TP</option>
                <option value="max">Max TP Bonus</option>
            </select>
            <button onclick="addTempHPEffect()">HinzufÃ¼gen</button>
            <div id="temp-hp-effects-list" style="margin-top: 5px;"></div>
            <hr style="border: none; border-top: 1px dashed var(--border-color); margin: 10px 0;">
            <button onclick="resetHP()">HP Voll</button>
            <button onclick="takeShortRest()">Kurze Rast</button>
            <button onclick="takeLongRest()">Lange Rast</button>
            <div>TrefferwÃ¼rfel: <span id="hit-dice-current">5</span>/<span id="hit-dice-max">5</span> <span id="hit-dice-type">W10</span> 
                <span class="hp-extra-toggle" onclick="toggleCollapsibleContent(document.getElementById('hp-extra'))">[Details ein/aus]</span>
            </div>
        </div>
      </div>

      <div class="tab-bar">
          <div class="tab active" onclick="changeTab('main')">Kampf</div>
          <div class="tab" onclick="changeTab('skills')">Werte</div>
          <div class="tab" onclick="changeTab('abilities')">FÃ¤higkeiten</div>
          <div class="tab" onclick="changeTab('inventory')">Inventar</div>
          <div class="tab" onclick="changeTab('actions')">Aktionen</div>
      </div>

      <div id="main" class="tab-content active card">
          <h2>Kampf Status &amp; Schaden</h2>
          <div class="toggle-container">
              <span class="toggle" id="sneakattack" onclick="toggle('sneakattack')">Sneak Attack</span>
              <span class="toggle resource-limited" id="rangers-quarry" onclick="toggle('rangersQuarry', true)">Ranger's Quarry (<span id="rangers-quarry-uses">2</span>/<span id="rangers-quarry-max">2</span>)</span>
          </div>
          <div style="margin-top: 15px; margin-bottom:15px; font-size: 1.1em;">
              <div><b>Angriff (Langbogen):</b> <span id="attack-summary">+9</span></div>
              <div><b>Schadensformel (Langbogen):</b> <span id="damage-summary">1d8+6</span></div>
               <div id="extra-attack-info" style="display:none; font-size:0.9em; opacity:0.8;">(+1 Extra Angriff bei Angriffsaktion)</div>
          </div>
          
          <div class="dice-result-display">
            <h3>Angriff &amp; Schaden</h3>
            <div class="dice-buttons">
                 <button onclick="rollDice('1d20+' + getAttackBonus())">Angriffswurf</button>
                 <button id="btn-roll-quarry" class="disabled" onclick="rollQuarryDice()" title="W4 fÃ¼r Ranger's Quarry wÃ¼rfeln">Quarry W4</button>
            </div>
            <div class="damage-input-section">
                <label for="weapon-dice-roll">Waffenwurf (z.B. W8):</label>
                <input type="number" id="weapon-dice-roll" placeholder="z.B. 5">
                <br>
                <label for="other-bonus-damage">Sonst. Bonus Schaden:</label>
                <input type="number" id="other-bonus-damage" placeholder="z.B. 2">
                <br>
                <button onclick="calculateTotalDamageFromInputs()">Gesamtschaden berechnen</button>
            </div>
            <div class="dice-result-value" id="dice-result">-</div>
            <p style="font-size:0.9em; opacity:0.8;">Hinweis: FÃ¼r Quarry W4 oben klicken, das Ergebnis wird in die Schadensberechnung einbezogen, wenn Quarry aktiv ist.</p>
          </div>
      </div>

      <div id="skills" class="tab-content card">
        <h2>Fertigkeiten &amp; Werte</h2>
        <div class="two-column">
            <div class="column">
                <h3>Fertigkeiten</h3>
                <ul class="info-list" id="skills-list"></ul>
            </div>
            <div class="column">
                <h3>RettungswÃ¼rfe</h3>
                <ul class="info-list" id="saves-list"></ul>
                <h3>Sinne</h3>
                 <ul class="info-list">
                    <li class="info-item"><span class="info-label">Passive Wahrnehmung</span><span class="info-value" id="passive-perception">18</span></li>
                    <li class="info-item"><span class="info-label">Passive Investigation</span><span class="info-value" id="passive-investigation">10</span></li>
                    <li class="info-item"><span class="info-label">Passive Insight</span><span class="info-value" id="passive-insight">12</span></li>
                 </ul>
                <h3>Sprachen</h3>
                <div id="languages" style="font-size:1em; padding:5px 0;">Common, Elvish, Dwarvish, Sign Language, Halfling</div>
            </div>
        </div>
      </div>

      <div id="abilities" class="tab-content card">
        <h2>FÃ¤higkeiten &amp; Merkmale</h2>
        <div class="section">
            <h3>Rasse: Waldelf</h3>
            <div class="collapsible">
                <div class="collapsible-header" onclick="toggleCollapsible(this)">Details</div>
                <div class="collapsible-content">
                     <p><b>AttributswerterhÃ¶hung:</b> GES +2, WEI +1.</p>
                     <p><b>Dunkelsicht:</b> <span id="racial-darkvision">120</span> FuÃŸ (DM-Sheet Wert)</p>
                     <p><b>Feenblut (Fey Ancestry):</b> Vorteil bei RettungswÃ¼rfen gegen Bezauberung, Magie kann dich nicht einschlÃ¤fern.</p>
                     <p><b>Trance:</b> Meditiere 4 Stunden statt 8 Stunden Schlaf.</p>
                     <p><b>Waffentraining der Elfen:</b> GeÃ¼bt mit Langschwert, Kurzschwert, Kurzbogen, Langbogen.</p>
                     <p><b>Flinke FÃ¼ÃŸe (Fleet of Foot):</b> Bewegungsrate ist 35 FuÃŸ.</p>
                     <p><b>Maske der Wildnis (Mask of the Wild):</b> Kann versuchen, sich auch zu verstecken, wenn nur leicht durch Laub, Regen, Schnee, Nebel usw. verdeckt.</p>
                </div>
            </div>
        </div>
        <div class="section">
            <h3>Klasse: Ranger (Gloom Stalker Variante)</h3>
             <div class="collapsible">
                <div class="collapsible-header" onclick="toggleCollapsible(this)">Allgemein</div>
                <div class="collapsible-content">
                     <p><b>Kampfstil:</b> BogenschieÃŸen (+2 Bonus auf AngriffswÃ¼rfe mit Fernkampfwaffen).</p>
                     <p><b>Zauberwirken:</b> WEI-basiert. Zauberrettungswurf ZS 13, Zauberangriffsmodifikator +5. ZauberplÃ¤tze L1: 3.</p>
                     <p><b>Umbralblick (Umbral Sight):</b> Unsichtbar fÃ¼r Kreaturen, die auf Dunkelsicht angewiesen sind, um dich in Dunkelheit zu sehen.</p>
                </div>
             </div>
        </div>
         <div class="section">
            <h3>Klasse: Rogue</h3>
             <div class="collapsible">
                <div class="collapsible-header" onclick="toggleCollapsible(this)">Level 1</div>
                <div class="collapsible-content">
                     <p><b>Expertise:</b> Heimlichkeit, Wahrnehmung.</p>
                     <p><b>HinterhÃ¤ltiger Angriff (Sneak Attack):</b> Einmal pro Zug +1W6 Schaden.</p>
                     <p><b>Diebeszeichen (Thieves' Cant):</b> Geheime Sprache.</p>
                </div>
             </div>
         </div>
         <div class="section">
              <h3>Weitere FÃ¤higkeiten (DM Sheet & Feats)</h3>
              <div class="collapsible">
                  <div class="collapsible-header" onclick="toggleCollapsible(this)">Details</div>
                  <div class="collapsible-content" id="custom-features-list">
                    <p><b>Alert:</b> You gain the following benefits: </p>
                    <p><b>Initiative Profiency. </b> When you roll Initiative, you can add your Proficiency Bonus to the roll.</p>
                                    <p><b>Initiative Swap.</b> Immediately after you roll Initiative, you can swap your Initative with the Initiative 
                                    of one willing ally in the same combat. You can't make this swap if you or the ally has the <i>Incapacitated</i> condition.</p>
                     <p><b>Incapacitated: </b> You can't take actions or reactions.</p>
                     <p><b>Feral Senses:</b> You hunt with the skills of an apex predator. At 5th level, you can't have disadvantage on attack rolls against your Quarry. 
                                            When you reach 18th level, you cannot have disadvantage on attack rolls agains any target withing 30 feet of you.
                    <p><b>Extra Attack </b> Beginning at 5th level, you can attack twice, instead of once, whenever you take the Attack action on your turn.</p>
                      </div>
              </div>
         </div>
      </div>

      <div id="inventory" class="tab-content card">
        <h2>Inventar</h2>
        <table class="inventory-table">
            <thead>
                <tr><th>Gegenstand</th><th>Menge</th><th>Gew. (lbs)</th><th>Ort</th><th>Notizen</th><th>Aktion</th></tr>
            </thead>
            <tbody id="inventory-items"></tbody>
        </table>
        <div class="inventory-summary">
            Gewicht: <span id="current-weight">0</span> / <span id="weight-capacity">150</span> lbs |
            Gold: <span id="gold-total">0</span> GP
        </div>
        <h3>Gegenstand hinzufÃ¼gen</h3>
        <div class="inventory-add-form">
            <div><label for="item-name">Name:</label><input type="text" id="item-name"></div>
            <div><label for="item-quantity">Menge:</label><input type="number" id="item-quantity" value="1" min="1"></div>
            <div><label for="item-weight">Gewicht (lbs):</label><input type="number" id="item-weight" value="0" min="0" step="0.1"></div>
            <div><label for="item-location">Ort:</label>
            <select id="item-location">
                <option value="carried">Getragen</option>
                <option value="backpack">Rucksack</option>
                <option value="equipped">AusrÃ¼st.</option>
                <option value="other">Andere</option>
            </select></div>
            <button onclick="addInventoryItem()">+</button>
        </div>
      </div>

       <div id="actions" class="tab-content card">
         <h2>Aktionen im Kampf (pro Runde)</h2>
         <table class="action-table">
            <thead>
                <tr><th>Typ</th><th>Aktion</th><th>Benutzt?</th></tr>
            </thead>
             <tbody id="action-list"></tbody>
         </table>
         <button onclick="resetActions()" style="margin-top: 15px;">Aktionen zurÃ¼cksetzen</button>
       </div>
    </div> <div class="sidebar">
Â  Â  Â  Â  <div class="char-portrait-container">
Â  Â  Â  Â  Â  Â  <img id="char-portrait-img" src="https://sharonmabel.github.io/DnD/Ilio.png" alt="Charakterportrait Ilio Xaenor">
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="card">
Â  Â  Â  Â  Â  Â  <h3>Notizen</h3>
Â  Â  Â  Â  Â  Â  <textarea style="width: 95%; height: 150px; background:rgba(255,255,255,0.1); color:var(--text-color); border:1px solid var(--border-color); border-radius:4px; padding:10px;" placeholder="Deine Notizen hier..."></textarea>
Â  Â  Â  Â  </div>
Â  Â  </div> </div> <script>
Â  Â  Â  // --- Character Data ---
Â  Â  Â  const characterData = {
Â  Â  Â  Â  Â  name: "Ilio Xaenor",
Â  Â  Â  Â  Â  race: "Wood Elf",
Â  Â  Â  Â  Â  levels: { "Gloom Stalker Ranger": 4, "Rogue": 1 },
Â  Â  Â  Â  Â  alignment: "Chaotic Good",
Â  Â  Â  Â  Â  attributes: { str: 10, dex: 18, con: 14, int: 10, wis: 14, cha: 10 },
Â  Â  Â  Â  Â  hp: { baseMax: 21, current: 21, temp: 0, bonus: 0 },
Â  Â  Â  Â  Â  hitDice: { "d10": 5 }, // Sheet: 5x d10
Â  Â  Â  Â  Â  ac: 16,
Â  Â  Â  Â  Â  speed: 35,
Â  Â  Â  Â  Â  profBonus: 3,
Â  Â  Â  Â  Â  initiativeTotal: 7, // Neuer Gesamtwert fÃ¼r Initiative
Â  Â  Â  Â  Â  proficiencies: {
Â  Â  Â  Â  Â  Â  Â  saves: ["dex"],
Â  Â  Â  Â  Â  Â  Â  skills: ["Acrobatics", "Animal Handling", "Athletics", "Perception", "Stealth", "Survival"],
Â  Â  Â  Â  Â  Â  Â  armor: ["Light", "Medium", "Shields"],
Â  Â  Â  Â  Â  Â  Â  weapons: ["Simple", "Martial"],
Â  Â  Â  Â  Â  Â  Â  tools: ["Thieves' Tools"]
Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  expertise: ["Stealth", "Perception"],
Â  Â  Â  Â  Â  languages: ["Common", "Elvish", "Dwarvish", "Sign Language", "Halfling"],
Â  Â  Â  Â  Â  features: {
Â  Â  Â  Â  Â  Â  Â  "Darkvision": { value: 120, description: "Du kannst bei dÃ¤mmrigem Licht innerhalb von 120 FuÃŸ sehen, als wÃ¤re es helles Licht, und bei Dunkelheit, als wÃ¤re es dÃ¤mmriges Licht. Du kannst in der Dunkelheit keine Farben erkennen, nur Graustufen." },
Â  Â  Â  Â  Â  Â  Â  "Fey Ancestry": { value: true, description: "Du hast Vorteil auf RettungswÃ¼rfe gegen Bezauberung, und Magie kann dich nicht einschlÃ¤fern." },
Â  Â  Â  Â  Â  Â  Â  "Mask of the Wild": { value: true, description: "Du kannst versuchen, dich auch dann zu verstecken, wenn du nur leicht von Laub, starkem Regen, fallendem Schnee, Nebel und anderen natÃ¼rlichen PhÃ¤nomenen verdeckt bist." },
Â  Â  Â  Â  Â  Â  Â  "Fighting Style (Archery)": { value: true, description: "Du erhÃ¤ltst einen Bonus von +2 auf AngriffswÃ¼rfe, die du mit Fernkampfwaffen machst." },
Â  Â  Â  Â  Â  Â  Â  "Spellcasting (Ranger)": { value: true, description: "Du wirkst Ranger-Zauber basierend auf Weisheit." },
Â  Â  Â  Â  Â  Â  Â  "Ranger Conclave (Gloom Stalker Variant)": { value: true, description: "Du folgst dem Pfad des Gloom Stalkers (Variante)." },
Â  Â  Â  Â  Â  Â  Â  "Umbral Sight": { value: true, description: "Solange du dich in Dunkelheit befindest, bist du fÃ¼r jede Kreatur unsichtbar, die auf Dunkelsicht angewiesen ist, um dich in dieser Dunkelheit zu sehen." },
Â  Â  Â  Â  Â  Â  Â  "Amateur of the Drunkard": { value: true, description: "Regain 1d4+1 HP when drinking beer, ale, mead, or wine. Once per dawn." },
Â  Â  Â  Â  Â  Â  Â  "Campfolgrein (Ambuscade)": { value: true, description: "Reaction on initiative (if not surprised): Hide, Attack, or mark Quarry." },
Â  Â  Â  Â  Â  Â  Â  "Sneak Attack": { dice: "1d6", description: "Einmal pro Zug kannst du einer Kreatur, die du triffst und die Vorteil gegen dich hat oder wenn ein anderer Feind des Ziels innerhalb von 5 FuÃŸ von ihm steht, der nicht kampfunfÃ¤hig ist und du keinen Nachteil beim Angriffswurf hast, zusÃ¤tzliche 1W6 Schaden zufÃ¼gen. Der Angriff muss eine Finesse- oder eine Fernkampfwaffe verwenden." },
Â  Â  Â  Â  Â  Â  Â  "Strider I": { value: true, description: "Ignore difficult terrain (natural), can't get lost by night sky, party not slowed by natural difficult terrain." },
Â  Â  Â  Â  Â  Â  Â  "Alert Feat": { value: true, description: "Du erhÃ¤ltst einen +5 Bonus auf Initiative. Du kannst nicht Ã¼berrascht werden, solange du bei Bewusstsein bist. Andere Kreaturen erhalten keinen Vorteil bei AngriffswÃ¼rfen gegen dich, weil sie von dir ungesehen sind." }
Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  spellcasting: {
Â  Â  Â  Â  Â  Â  Â  ability: "wis",
Â  Â  Â  Â  Â  Â  Â  slots: { level1: 3 },
Â  Â  Â  Â  Â  Â  Â  spellsKnown: ["Expeditious Retreat", "Snare", "Disguise Self"], // Disguise Self von Gloom Stalker
Â  Â  Â  Â  Â  Â  Â  dc: 13,
Â  Â  Â  Â  Â  Â  Â  attackBonus: 5
Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  inventory: [
Â  Â  Â  Â  Â  Â  Â  { name: "Langbogen", weight: 2, quantity: 1, location: "equipped", type: "weapon", notes: "Sheet: Atk +9, Dmg 1d8+6" },
Â  Â  Â  Â  Â  Â  Â  { name: "Pfeile", weight: 1, quantity: 20, location: "carried", type: "ammo" }, 
Â  Â  Â  Â  Â  Â  Â  { name: "Rapier", weight: 2, quantity: 1, location: "carried", type: "weapon", notes: "Sheet: Atk +7, Dmg 1d8+4" },
Â  Â  Â  Â  Â  Â  Â  { name: "Sylvan Talon Dolch", weight: 1, quantity: 1, location: "carried", type: "weapon", notes: "Sheet: Atk +9, Dmg 1d4+4" },
Â  Â  Â  Â  Â  Â  Â  { name: "Beschlagene LederrÃ¼stung", weight: 13, quantity: 1, location: "equipped", type: "armor" }
Â  Â  Â  Â  Â  ],
Â  Â  Â  Â  Â  tempHPEffects: [],
Â  Â  Â  Â  Â  resources: {
Â  Â  Â  Â  Â  Â  Â  "rangersQuarry": { current: 2, max: 2, resetOn: "long", dice: "1d4", description: "Bonusaktion. +1W4 Schaden auf Quarry. Nutzungen = WEI Mod. Erholung bei langer Rast oder Zauberplatz." },
Â  Â  Â  Â  Â  Â  Â  "Amateur of the Drunkard": { current: 1, max: 1, resetOn: "dawn", description: "Erhalte 1W4+1 TP zurÃ¼ck, wenn Alkohol getrunken wird." }
Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  activeToggles: {
Â  Â  Â  Â  Â  Â  Â  rangersquarry: false,
Â  Â  Â  Â  Â  Â  Â  sneakattack: false
Â  Â  Â  Â  Â  Â  Â  // huntersmark wurde entfernt
Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â actions: [
Â  Â  Â  Â  Â  Â  Â  Â  { id: "action-attack", name: "Angriff", type: "action", desc: "Nutze deine Waffe" },
Â  Â  Â  Â  Â  Â  Â  Â  { id: "action-cast", name: "Zauber wirken", type: "action", desc: "Siehe Zauberliste" },
Â  Â  Â  Â  Â  Â  Â  Â  { id: "action-dash", name: "Spurt", type: "action", desc: "+Bewegung" },
Â  Â  Â  Â  Â  Â  Â  Â  { id: "action-disengage", name: "LÃ¶sen", type: "action", desc: "Keine Gelegenheitsangriffe provozieren"},
Â  Â  Â  Â  Â  Â  Â  Â  { id: "action-dodge", name: "Ausweichen", type: "action", desc: "Nachteil fÃ¼r Angreifer" },
Â  Â  Â  Â  Â  Â  Â  Â  { id: "action-help", name: "Helfen", type: "action", desc: "Vorteil fÃ¼r VerbÃ¼ndeten" },
Â  Â  Â  Â  Â  Â  Â  Â  { id: "action-hide", name: "Verstecken", type: "action", desc: "Heimlichkeitswurf" },
Â  Â  Â  Â  Â  Â  Â  Â  { id: "action-ready", name: "Vorbereiten", type: "action", desc: "Aktion/Reaktion spÃ¤ter" },
Â  Â  Â  Â  Â  Â  Â  Â  { id: "action-use-object", name: "Gegenstand nutzen", type: "action", desc: "Trank, Hebel, etc." },
Â  Â  Â  Â  Â  Â  Â  Â  { id: "bonus-rangers-quarry", name: "Ranger's Quarry", type: "bonus", desc: "Ziel markieren" },
Â  Â  Â  Â  Â  Â  Â  Â  { id: "bonus-cunning-hide", name: "Verstecken (Cunning)", type: "bonus", desc: "SchurkenfÃ¤higkeit" },
Â  Â  Â  Â  Â  Â  Â  Â  { id: "bonus-cunning-dash", name: "Spurt (Cunning)", type: "bonus", desc: "SchurkenfÃ¤higkeit" },
Â  Â  Â  Â  Â  Â  Â  Â  { id: "bonus-cunning-disengage", name: "LÃ¶sen (Cunning)", type: "bonus", desc: "SchurkenfÃ¤higkeit" },
Â  Â  Â  Â  Â  Â  Â  Â  { id: "reaction-opportunity", name: "Gelegenheitsangriff", type: "reaction", desc: "Feind verlÃ¤sst Reichweite" },
Â  Â  Â  Â  Â  Â  Â  Â  { id: "reaction-ambuscade", name: "Campfolgrein (Ambuscade)", type: "reaction", desc: "Bei Initiative: Verstecken, Angriff oder Quarry markieren" }
Â  Â  Â  Â  Â  Â  ]
Â  Â  Â  };

Â  Â  Â  let totalHitDice = 0;
Â  Â  Â  let currentHitDice = 0;
      let lastQuarryRoll = 0; // Globale Variable fÃ¼r den letzten Quarry-Wurf

Â  Â  Â  function getModifier(attribute) {
Â  Â  Â  Â  Â  const score = characterData.attributes[attribute];
Â  Â  Â  Â  Â  return Math.floor((score - 10) / 2);
Â  Â  Â  }

Â  Â  Â  function getProficiencyBonus() { return characterData.profBonus; }

Â  Â  Â  function getSkillBonus(skillName) {
Â  Â  Â  Â  Â  const skillsData = { 
Â  Â  Â  Â  Â  Â  Â  "Acrobatics": "dex", "Stealth": "dex", "Sleight of Hand": "dex",
Â  Â  Â  Â  Â  Â  Â  "Athletics": "str",
Â  Â  Â  Â  Â  Â  Â  "Insight": "wis", "Medicine": "wis", "Perception": "wis", "Survival": "wis", "Animal Handling": "wis",
Â  Â  Â  Â  Â  Â  Â  "Investigation": "int", "Arcana": "int", "History": "int", "Nature": "int", "Religion": "int",
Â  Â  Â  Â  Â  Â  Â  "Deception": "cha", "Intimidation": "cha", "Performance": "cha", "Persuasion": "cha"
Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  const attribute = skillsData[skillName];
Â  Â  Â  Â  Â  if (!attribute) return 0;

Â  Â  Â  Â  Â  let bonus = getModifier(attribute);
Â  Â  Â  Â  Â  let isProficient = characterData.proficiencies.skills.includes(skillName);
Â  Â  Â  Â  Â  let isExpertise = characterData.expertise.includes(skillName);

Â  Â  Â  Â  Â  if (isExpertise) { bonus += (getProficiencyBonus() * 2); } 
Â  Â  Â  Â  Â  else if (isProficient) { bonus += getProficiencyBonus(); }
Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  if (characterData.name === "Ilio Xaenor" && skillName === "Acrobatics") { return 5; } // DM Override
Â  Â  Â  Â  Â  return bonus;
Â  Â  Â  }

Â  Â  Â  function getSaveBonus(attribute) {
Â  Â  Â  Â  Â  let bonus = getModifier(attribute);
Â  Â  Â  Â  Â  if (characterData.proficiencies.saves.includes(attribute)) { bonus += getProficiencyBonus(); }
Â  Â  Â  Â  Â  return bonus;
Â  Â  Â  }

Â  Â  Â  Â function getAttackBonus(weaponType = "ranged") {
Â  Â  Â  Â  Â  Â  const dexMod = getModifier('dex');
Â  Â  Â  Â  Â  Â  let bonus = dexMod + getProficiencyBonus();
Â  Â  Â  Â  Â  Â  if (weaponType === "ranged" && characterData.features["Fighting Style (Archery)"].value) { bonus += 2; }
Â  Â  Â  Â  Â  Â  return bonus; // Sollte +9 fÃ¼r Langbogen ergeben (4 DEX + 3 PB + 2 Archery)
Â  Â  Â  Â }

Â  Â  Â  Â function getDamageBonus(weaponType = "ranged") { // Diese Funktion gibt den MODIFIKATOR zurÃ¼ck
Â  Â  Â  Â  Â  Â  const dexMod = getModifier('dex');
Â  Â  Â  Â  Â  Â  if (characterData.name === "Ilio Xaenor" && weaponType === "longbow") { return 6; } // DM Override fÃ¼r Langbogen Modifikator +6
Â  Â  Â  Â  Â  Â return dexMod; // StandardmÃ¤ÃŸig GES-Modifikator
Â  Â  Â  Â }

Â  Â  Â  function formatBonus(bonus) { return bonus >= 0 ? `+${bonus}` : bonus; }

Â  Â  Â  function toggleCollapsible(headerElement) {
Â  Â  Â  Â  Â  const content = headerElement.nextElementSibling;
Â  Â  Â  Â  Â  content.style.display = content.style.display === "block" ? "none" : "block";
Â  Â  Â  }
Â  Â  Â  Â function toggleCollapsibleContent(contentElement) {
Â  Â  Â  Â  Â  Â contentElement.style.display = contentElement.style.display === "block" ? "none" : "block";
Â  Â  Â  Â }

Â  Â  Â  window.onload = function() {
Â  Â  Â  Â  Â  document.getElementById('char-name').innerText = characterData.name;
Â  Â  Â  Â  Â  document.getElementById('char-details').innerText = `${characterData.race} ${Object.entries(characterData.levels).map(([cls, lvl]) => `${cls} ${lvl}`).join(' / ')}`;
Â  Â  Â  Â  Â  document.getElementById('ac-value').innerText = characterData.ac;
Â  Â  Â  Â  Â  document.getElementById('speed-value').innerText = characterData.speed;
Â  Â  Â  Â  Â  document.getElementById('pb-value').innerText = formatBonus(characterData.profBonus);
Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  totalHitDice = characterData.hitDice.d10;
Â  Â  Â  Â  Â  currentHitDice = totalHitDice; 

Â  Â  Â  Â  Â  document.getElementById('char-portrait-img').src = "https://sharonmabel.github.io/DnD/Ilio.png";


Â  Â  Â  Â  Â  populateUI();
Â  Â  Â  Â  Â  changeTab('main'); 
Â  Â  Â  Â  Â  document.getElementById('hp-extra').style.display = 'none'; 
Â  Â  Â  };

Â  Â  Â  function populateUI() {
Â  Â  Â  Â  Â  populateAttributes();
Â  Â  Â  Â  Â  populateSkillsAndSaves();
Â  Â  Â  Â  Â  populateSpellcastingInfo();
Â  Â  Â  Â  Â  updateHPDisplay(); 
Â  Â  Â  Â  Â  updateCombatSummary();
Â  Â  Â  Â  Â  renderInventory(); 
Â  Â  Â  Â  Â  renderActionList();
Â  Â  Â  Â  Â  updateResourceCounters(); 
Â  Â  Â  Â  Â  populateCustomFeatures();
Â  Â  Â  }

Â  Â  Â  function populateAttributes() {
Â  Â  Â  Â  Â  Â Object.keys(characterData.attributes).forEach(attr => {
              const valueSpan = document.getElementById(`${attr}-value`);
              const modSpan = document.getElementById(`${attr}-mod`);
              if (valueSpan) valueSpan.innerText = characterData.attributes[attr];
              if (modSpan) modSpan.innerText = formatBonus(getModifier(attr));
Â  Â  Â  Â  Â  Â });
Â  Â  Â  Â  Â  Â document.getElementById('initiative-value').innerText = formatBonus(characterData.initiativeTotal);
Â  Â  Â  }

Â  Â  Â  Â function populateSkillsAndSaves() {
Â  Â  Â  Â  Â  const skillsContainer = document.getElementById('skills-list');
Â  Â  Â  Â  Â  const savesContainer = document.getElementById('saves-list');
Â  Â  Â  Â  Â  skillsContainer.innerHTML = '';
Â  Â  Â  Â  Â  savesContainer.innerHTML = '';
Â  Â  Â  Â  Â  Â const allSkills = ["Acrobatics", "Animal Handling", "Arcana", "Athletics", "Deception", "History", "Insight", "Intimidation", "Investigation", "Medicine", "Nature", "Perception", "Performance", "Persuasion", "Religion", "Sleight of Hand", "Stealth", "Survival"];
Â  Â  Â  Â  Â  Â allSkills.sort().forEach(skill => {
Â  Â  Â  Â  Â  Â  Â  const bonus = getSkillBonus(skill);
Â  Â  Â  Â  Â  Â  Â  const isProficient = characterData.proficiencies.skills.includes(skill);
Â  Â  Â  Â  Â  Â  Â  const isExpertise = characterData.expertise.includes(skill);
Â  Â  Â  Â  Â  Â  Â  skillsContainer.innerHTML += `<li class="info-item"><span class="info-label ${isExpertise ? 'proficient' : (isProficient ? 'proficient' : '')}">${skill}</span><span class="info-value">${formatBonus(bonus)}</span></li>`;
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â const allSaves = ["str", "dex", "con", "int", "wis", "cha"];
Â  Â  Â  Â  Â  Â allSaves.forEach(save => {
Â  Â  Â  Â  Â  Â  Â  Â const bonus = getSaveBonus(save);
Â  Â  Â  Â  Â  Â  Â  Â const isProficient = characterData.proficiencies.saves.includes(save);
Â  Â  Â  Â  Â  Â  Â  Â savesContainer.innerHTML += `<li class="info-item"><span class="info-label ${isProficient ? 'proficient' : ''}">${save.toUpperCase()} Save</span><span class="info-value">${formatBonus(bonus)}</span></li>`;
Â  Â  Â  Â  Â  Â });
Â  Â  Â  Â  Â  Â  document.getElementById('passive-perception').innerText = 10 + getSkillBonus('Perception');
Â  Â  Â  Â  Â  Â  document.getElementById('passive-investigation').innerText = 10 + getSkillBonus('Investigation');
Â  Â  Â  Â  Â  Â  document.getElementById('passive-insight').innerText = 10 + getSkillBonus('Insight');
Â  Â  Â  Â  Â  Â  document.getElementById('languages').innerText = characterData.languages.join(', ');
Â  Â  Â  Â  Â  Â  if(document.getElementById('racial-darkvision')) { 
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('racial-darkvision').innerText = characterData.features.Darkvision.value;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  Â  
Â  Â  Â  function populateCustomFeatures() {
Â  Â  Â  Â  const container = document.getElementById('custom-features-list');
        if (!container) return;
Â  Â  Â  Â  container.innerHTML = ''; 
Â  Â  Â  Â  const customFeatureKeys = ["Amateur of the Drunkard", "Campfolgrein (Ambuscade)", "Strider I", "Alert Feat"];
Â  Â  Â  Â  customFeatureKeys.forEach(key => {
Â  Â  Â  Â  Â  Â  if (characterData.features[key] && characterData.features[key].description) {
Â  Â  Â  Â  Â  Â  Â  Â  const feature = characterData.features[key];
Â  Â  Â  Â  Â  Â  Â  Â  const p = document.createElement('p');
Â  Â  Â  Â  Â  Â  Â  Â  p.innerHTML = `<b>${key.replace(/Feat/g, 'Feat')}:</b> ${feature.description}`;
Â  Â  Â  Â  Â  Â  Â  Â  container.appendChild(p);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  }

Â  Â  Â  function populateSpellcastingInfo() {
Â  Â  Â  Â  Â  document.getElementById('spell-dc').innerText = characterData.spellcasting.dc;
Â  Â  Â  Â  Â  document.getElementById('spell-attack').innerText = formatBonus(characterData.spellcasting.attackBonus);
Â  Â  Â  Â  Â  document.getElementById('spell-slots').innerText = `Level 1: ${characterData.spellcasting.slots.level1}/${characterData.spellcasting.slots.level1}`;
Â  Â  Â  }

Â  Â  Â  Â function updateResourceCounters() {
Â  Â  Â  Â  Â  Â if (characterData.resources.rangersQuarry) {
Â  Â  Â  Â  Â  Â  Â  Â const uses = characterData.resources.rangersQuarry.current;
Â  Â  Â  Â  Â  Â  Â  Â const max = characterData.resources.rangersQuarry.max;
                const usesSpan = document.getElementById('rangers-quarry-uses');
                const maxSpan = document.getElementById('rangers-quarry-max');
                if(usesSpan) usesSpan.innerText = uses;
                if(maxSpan) maxSpan.innerText = max;

Â  Â  Â  Â  Â  Â  Â  Â  const toggleEl = document.getElementById('rangers-quarry');
Â  Â  Â  Â  Â  Â  Â  Â  if (toggleEl) { 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  toggleEl.classList.toggle('disabled', uses <= 0);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â }

Â  Â  Â  function toggle(id, isResourceLimited = false) {
Â  Â  Â  Â  Â  const el = document.getElementById(id === "rangersQuarry" ? "rangers-quarry" : id);
Â  Â  Â  Â  Â  if (!el) { return; }
Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  const resourceKey = id; 
Â  Â  Â  Â  Â  const resource = characterData.resources[resourceKey];

Â  Â  Â  Â  Â  Â if (isResourceLimited && resource && resource.current <= 0 && !el.classList.contains('active')) {
Â  Â  Â  Â  Â  Â  Â  Â return; 
Â  Â  Â  Â  Â  Â }

Â  Â  Â  Â  Â  const isActive = el.classList.toggle('active');
Â  Â  Â  Â  Â  characterData.activeToggles[resourceKey] = isActive;
Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  const quarryDiceButton = document.getElementById('btn-roll-quarry');
Â  Â  Â  Â  Â  if (resourceKey === 'rangersQuarry') {
Â  Â  Â  Â  Â  Â  Â  quarryDiceButton.classList.toggle('disabled', !isActive);
              if (!isActive) { lastQuarryRoll = 0; } // Reset quarry roll if toggled off
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  updateCombatSummary();
Â  Â  Â  Â }

Â  Â  Â  Â function updateCombatSummary() {
Â  Â  Â  Â  Â  Â const longbowAttackBonus = formatBonus(9); 
Â  Â  Â  Â  Â  Â let longbowDamageBase = "1W8" + formatBonus(getDamageBonus("longbow")); 

Â  Â  Â  Â  Â  Â let damageParts = [];
Â  Â  Â  Â  Â  Â if (characterData.activeToggles.sneakattack) { damageParts.push(characterData.features["Sneak Attack"].dice); }
Â  Â  Â  Â  Â  Â // Hunter's Mark entfernt
            if (characterData.activeToggles.rangersquarry && characterData.resources.rangersQuarry.current > 0) {
                 damageParts.push(characterData.resources.rangersQuarry.dice); // Zeigt "1d4" in der Formel an
            }


Â  Â  Â  Â  Â  Â document.getElementById('attack-summary').innerText = longbowAttackBonus;
Â  Â  Â  Â  Â  Â document.getElementById('damage-summary').innerText = longbowDamageBase + (damageParts.length > 0 ? " + " + damageParts.join(" + ") : "");
Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â document.getElementById('extra-attack-info').style.display = (characterData.levels["Gloom Stalker Ranger"] >= 5) ? 'block' : 'none';
Â  Â  Â  Â  Â  Â updateResourceCounters();
Â  Â  Â  Â }
Â  Â  Â  Â 
Â  Â  Â  function rollQuarryDice() {
Â  Â  Â  Â  if (characterData.activeToggles.rangersquarry) {
Â  Â  Â  Â  Â  Â  const roll = Math.floor(Math.random() * 4) + 1;
            lastQuarryRoll = roll; // Speichere den Wurf fÃ¼r die Schadensberechnung
Â  Â  Â  Â  Â  Â  document.getElementById('dice-result').innerText = `Quarry W4: ${roll}`;
Â  Â  Â  Â  } else {
            lastQuarryRoll = 0;
Â  Â  Â  Â  Â  Â  document.getElementById('dice-result').innerText = "Quarry nicht aktiv";
Â  Â  Â  Â  }
Â  Â  Â  }

      function calculateTotalDamageFromInputs() {
        const weaponDiceRoll = parseInt(document.getElementById('weapon-dice-roll').value) || 0;
        const otherBonusDamage = parseInt(document.getElementById('other-bonus-damage').value) || 0;
        
        let totalDamage = weaponDiceRoll;
        totalDamage += getDamageBonus("longbow"); // Fester Langbogen-Schadensbonus (+6)

        if (characterData.activeToggles.sneakattack) {
            totalDamage += Math.floor(Math.random() * 6) + 1; // WÃ¼rfle Sneak Attack 1W6
        }
        if (characterData.activeToggles.rangersquarry && lastQuarryRoll > 0) {
            totalDamage += lastQuarryRoll; // FÃ¼ge den gespeicherten Quarry-Wurf hinzu
        }
        totalDamage += otherBonusDamage;

        document.getElementById('dice-result').innerText = `Gesamtschaden: ${totalDamage}`;
        lastQuarryRoll = 0; // Setze Quarry-Wurf zurÃ¼ck nach Berechnung
        document.getElementById('weapon-dice-roll').value = ''; // Felder leeren
        document.getElementById('other-bonus-damage').value = '';
      }


Â  Â  Â  let currentHP = characterData.hp.current;
Â  Â  Â  let maxHP = characterData.hp.baseMax + characterData.hp.bonus;
Â  Â  Â  let tempHP = characterData.hp.temp;

Â  Â  Â  function modifyHP(amount) {
Â  Â  Â  Â  Â  if (amount < 0) { 
Â  Â  Â  Â  Â  Â  Â  let damageTaken = Math.abs(amount);
Â  Â  Â  Â  Â  Â  Â  if (tempHP > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  const tempDamage = Math.min(damageTaken, tempHP);
Â  Â  Â  Â  Â  Â  Â  Â  Â  tempHP -= tempDamage;
Â  Â  Â  Â  Â  Â  Â  Â  Â  damageTaken -= tempDamage;
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  if (damageTaken > 0) { currentHP = Math.max(0, currentHP - damageTaken); }
Â  Â  Â  Â  Â  } else { currentHP = Math.min(maxHP, currentHP + amount); }
Â  Â  Â  Â  Â  updateHPDisplay();
Â  Â  Â  }

Â  Â  Â  Â function updateHPDisplay() {
Â  Â  Â  Â  Â  Â characterData.hp.current = currentHP;
Â  Â  Â  Â  Â  Â characterData.hp.temp = tempHP;
Â  Â  Â  Â  Â  Â maxHP = characterData.hp.baseMax + characterData.hp.bonus; 

Â  Â  Â  Â  Â  Â document.getElementById('current-hp').innerText = currentHP;
Â  Â  Â  Â  Â  Â document.getElementById('max-hp').innerText = maxHP;
Â  Â  Â  Â  Â  Â document.getElementById('temp-hp-display').innerText = tempHP > 0 ? ` (+${tempHP} Temp)` : '';
Â  Â  Â  Â  Â  Â document.getElementById('hp-fill').style.width = `${maxHP > 0 ? (currentHP / maxHP) * 100 : 0}%`;
Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  const hitDiceType = Object.keys(characterData.hitDice)[0];
Â  Â  Â  Â  Â  Â  document.getElementById('hit-dice-current').innerText = currentHitDice;
Â  Â  Â  Â  Â  Â  document.getElementById('hit-dice-max').innerText = totalHitDice;
Â  Â  Â  Â  Â  Â  document.getElementById('hit-dice-type').innerText = "W" + hitDiceType.substring(1);
Â  Â  Â  Â  Â  Â renderTempHPEffects(); 
Â  Â  Â  Â }

Â  Â  Â  Â function addTempHPEffect() {
Â  Â  Â  Â  Â  Â const source = document.getElementById('temp-hp-source-input').value.trim() || "Quelle?";
Â  Â  Â  Â  Â  Â const amount = parseInt(document.getElementById('temp-hp-amount-input').value) || 0;
Â  Â  Â  Â  Â  Â const type = document.getElementById('temp-hp-type-select').value; 
Â  Â  Â  Â  Â  Â if (amount <= 0) return;
Â  Â  Â  Â  Â  Â characterData.tempHPEffects.push({ id: Date.now(), source, amount, type });
Â  Â  Â  Â  Â  Â applyTempHPEffects(); 
Â  Â  Â  Â  Â  Â document.getElementById('temp-hp-source-input').value = '';
Â  Â  Â  Â  Â  Â document.getElementById('temp-hp-amount-input').value = '1';
Â  Â  Â  Â }

Â  Â  Â  Â function removeTempHPEffect(id) {
Â  Â  Â  Â  Â  Â characterData.tempHPEffects = characterData.tempHPEffects.filter(effect => effect.id !== id);
Â  Â  Â  Â  Â  Â applyTempHPEffects();
Â  Â  Â  Â }

Â  Â  Â  Â function applyTempHPEffects() {
Â  Â  Â  Â  Â  Â let currentMaxTempHP = 0; let currentTotalBonusHP = 0;
Â  Â  Â  Â  Â  Â characterData.tempHPEffects.forEach(effect => {
Â  Â  Â  Â  Â  Â  Â  Â if (effect.type === 'temp') { currentMaxTempHP = Math.max(currentMaxTempHP, effect.amount); } 
Â  Â  Â  Â  Â  Â  Â  Â else if (effect.type === 'max') { currentTotalBonusHP += effect.amount; }
Â  Â  Â  Â  Â  Â });
Â  Â  Â  Â  Â  Â tempHP = currentMaxTempHP; characterData.hp.bonus = currentTotalBonusHP; 
Â  Â  Â  Â  Â  Â maxHP = characterData.hp.baseMax + characterData.hp.bonus; 
Â  Â  Â  Â  Â  Â currentHP = Math.min(currentHP, maxHP); 
Â  Â  Â  Â  Â  Â updateHPDisplay(); 
Â  Â  Â  Â }

Â  Â  Â  Â  function renderTempHPEffects() {
Â  Â  Â  Â  Â  Â  const list = document.getElementById('temp-hp-effects-list');
Â  Â  Â  Â  Â  Â  list.innerHTML = ''; 
Â  Â  Â  Â  Â  Â  characterData.tempHPEffects.forEach(effect => {
Â  Â  Â  Â  Â  Â  Â  Â  list.innerHTML += `<div class="temp-hp-effect"><span>${effect.source}: ${effect.amount} ${effect.type === 'temp' ? 'Temp' : 'Bonus'} TP</span><button onclick="removeTempHPEffect(${effect.id})">X</button></div>`;
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â function resetHP() { currentHP = maxHP; updateHPDisplay(); }

Â  Â  Â  Â  function takeShortRest() {
Â  Â  Â  Â  Â  Â  Â const diceToSpendPrompt = prompt(`Kurze Rast. Wieviele TrefferwÃ¼rfel ausgeben? (Max ${currentHitDice}, Typ W${Object.keys(characterData.hitDice)[0].substring(1)})`, "0");
Â  Â  Â  Â  Â  Â  Â if (diceToSpendPrompt === null) return;
Â  Â  Â  Â  Â  Â  Â const numDice = parseInt(diceToSpendPrompt);
Â  Â  Â  Â  Â  Â  Â if (numDice > 0 && numDice <= currentHitDice) {
Â  Â  Â  Â  Â  Â  Â  Â  let totalHealed = 0; const conMod = getModifier('con'); const dieType = parseInt(Object.keys(characterData.hitDice)[0].substring(1));
Â  Â  Â  Â  Â  Â  Â  Â  for (let i = 0; i < numDice; i++) { totalHealed += Math.floor(Math.random() * dieType) + 1 + conMod; }
Â  Â  Â  Â  Â  Â  Â  Â  currentHitDice -= numDice; modifyHP(totalHealed); 
Â  Â  Â  Â  Â  Â  Â  Â  alert(`Du gibst ${numDice}W${dieType} aus und heilst ${totalHealed} TP.`);
Â  Â  Â  Â  Â  Â  Â  Â  updateHPDisplay(); 
Â  Â  Â  Â  Â  Â  Â } else if (numDice > currentHitDice) { alert("Nicht genug TrefferwÃ¼rfel verfÃ¼gbar."); }
Â  Â  Â  Â  }

Â  Â  Â  Â  function takeLongRest() {
Â  Â  Â  Â  Â  Â  currentHP = maxHP; tempHP = 0; characterData.hp.bonus = 0; characterData.tempHPEffects = [];
Â  Â  Â  Â  Â  Â  const diceRegained = Math.max(1, Math.floor(totalHitDice / 2));
Â  Â  Â  Â  Â  Â  currentHitDice = Math.min(totalHitDice, currentHitDice + diceRegained);
Â  Â  Â  Â  Â  Â  Object.keys(characterData.resources).forEach(key => {
Â  Â  Â  Â  Â  Â  Â  Â  Â if (characterData.resources[key].resetOn === 'long' || characterData.resources[key].resetOn === 'dawn') { 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â characterData.resources[key].current = characterData.resources[key].max;
Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â });
Â  Â  Â  Â  Â  Â  alert(`Lange Rast beendet. HP voll (${maxHP}). ${diceRegained} TrefferwÃ¼rfel wiederhergestellt. Ressourcen zurÃ¼ckgesetzt.`);
Â  Â  Â  Â  Â  Â  populateUI(); 
Â  Â  Â  Â  }

      function changeAttribute(attr, amount) {
          const valueSpan = document.getElementById(`${attr}-value`);
          if (!valueSpan) return;

          let currentValue = parseInt(valueSpan.innerText);
          let newValue = currentValue + amount;
          newValue = Math.max(1, Math.min(30, newValue)); // Clamp

          characterData.attributes[attr] = newValue; // Update data model
          // No full populateUI() here to avoid loops if other functions also call populateUI
          valueSpan.innerText = newValue;
          document.getElementById(`${attr}-mod`).innerText = formatBonus(getModifier(attr));
          
          // Specific updates if needed (e.g. AC for DEX/CON, weight for STR)
          if (attr === 'dex' || attr === 'con') updateHPDisplay(); // AC and HP might depend on these
          if (attr === 'str') renderInventory(); // For weight capacity
          populateSkillsAndSaves(); // Skills and saves depend on all attributes
          updateCombatSummary(); // Attack/damage might change
      }


Â  Â  Â  function rollDice(dice) { // This is for general dice rolls, not the new damage calculation specifically
Â  Â  Â  Â  Â  let resultText = "UngÃ¼ltiger Wurf"; let rollValue = 0;
Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â if (typeof dice === 'number') { rollValue = Math.floor(Math.random() * dice) + 1; resultText = `W${dice}: ${rollValue}`; } 
Â  Â  Â  Â  Â  Â  Â  Â else if (typeof dice === 'string') { 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const match = dice.match(/(\d+)d(\d+)(?:([+-])(\d+))?/);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â if (match) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let total = 0; let rolls = []; const numDice = parseInt(match[1]); const sides = parseInt(match[2]); const modifier = parseInt(match[4] || '0'); const operator = match[3];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  for (let i = 0; i < numDice; i++) { const roll = Math.floor(Math.random() * sides) + 1; rolls.push(roll); total += roll; }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (operator === '+') total += modifier; else if (operator === '-') total -= modifier;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  rollValue = total; resultText = `${dice}: ${rolls.join('+')}${operator ? operator + modifier : ''} = ${total}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  } catch(e) { console.error("Dice roll error:", e); }
Â  Â  Â  Â  Â  document.getElementById('dice-result').innerText = resultText; // Display in general dice result area
Â  Â  Â  Â  Â  return rollValue; 
Â  Â  Â  }

Â  Â  Â  Â function addInventoryItem() {
Â  Â  Â  Â  Â  Â const name = document.getElementById('item-name').value.trim();
Â  Â  Â  Â  Â  Â const quantity = parseInt(document.getElementById('item-quantity').value) || 1;
Â  Â  Â  Â  Â  Â const weight = parseFloat(document.getElementById('item-weight').value) || 0;
Â  Â  Â  Â  Â  Â const location = document.getElementById('item-location').value;
Â  Â  Â  Â  Â  Â const type = name.toLowerCase().includes("gold") || name.toLowerCase().includes("gp") ? "currency" : ["langbogen", "rapier", "sylvan talon dolch"].includes(name.toLowerCase()) ? "weapon" : ["beschlagene lederrÃ¼stung"].includes(name.toLowerCase()) ? "armor" : "gear";
Â  Â  Â  Â  Â  Â if (!name || quantity < 1 || weight < 0) { alert('GÃ¼ltigen Namen, Menge (>=1) und Gewicht (>=0) eingeben.'); return; }
Â  Â  Â  Â  Â  Â const existingIdx = characterData.inventory.findIndex(i=>i.name.toLowerCase()===name.toLowerCase()&&i.location===location&&i.type!=='currency');
Â  Â  Â  Â  Â  Â if (existingIdx > -1) { characterData.inventory[existingIdx].quantity += quantity; } 
Â  Â  Â  Â  Â  Â else { characterData.inventory.push({ name, weight, quantity, location, type, equipped: location === 'equipped', notes:'' }); }
Â  Â  Â  Â  Â  Â document.getElementById('item-name').value = ''; document.getElementById('item-quantity').value = '1'; document.getElementById('item-weight').value = '0';
Â  Â  Â  Â  Â  Â renderInventory();
Â  Â  Â  Â }

Â  Â  Â  Â function removeInventoryItem(index) {
Â  Â  Â  Â  Â  Â if (index >= 0 && index < characterData.inventory.length && confirm(`"${characterData.inventory[index].name}" entfernen?`)) {
Â  Â  Â  Â  Â  Â  Â  Â characterData.inventory.splice(index, 1); renderInventory();
Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â }

Â  Â  Â  Â function renderInventory() {
Â  Â  Â  Â  Â  Â const tbody = document.getElementById('inventory-items');
Â  Â  Â  Â  Â  Â tbody.innerHTML = ''; let totalWeight = 0; let totalGold = 0;
Â  Â  Â  Â  Â  Â characterData.inventory.forEach((item, index) => {
Â  Â  Â  Â  Â  Â  Â  Â const itemTotalWeight = item.type !== 'currency' ? (item.weight * item.quantity) : 0;
Â  Â  Â  Â  Â  Â  Â  Â totalWeight += itemTotalWeight;
Â  Â  Â  Â  Â  Â  Â  Â if (item.type === 'currency' && item.name.toLowerCase().includes('gold')) { totalGold += item.quantity; }
Â  Â  Â  Â  Â  Â  Â  Â if (item.type !== 'currency') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â tbody.innerHTML += `<tr><td>${item.name}</td><td>${item.quantity}</td><td>${itemTotalWeight.toFixed(1)}</td><td>${item.location}</td><td>${item.notes || ''}</td><td><button class="delete-button" onclick="removeInventoryItem(${index})">X</button></td></tr>`;
Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â });
Â  Â  Â  Â  Â  Â document.getElementById('current-weight').textContent = totalWeight.toFixed(1);
Â  Â  Â  Â  Â  Â document.getElementById('weight-capacity').textContent = characterData.attributes.str * 15;
Â  Â  Â  Â  Â  Â document.getElementById('gold-total').textContent = totalGold;
Â  Â  Â  Â }

Â  Â  Â  Â  function renderActionList() {
Â  Â  Â  Â  Â  Â  const tbody = document.getElementById('action-list');
Â  Â  Â  Â  Â  Â  tbody.innerHTML = ''; 
Â  Â  Â  Â  Â  Â  characterData.actions.forEach(action => {
Â  Â  Â  Â  Â  Â  Â  Â  tbody.innerHTML += `<tr class="action-item"><td>${action.type.charAt(0).toUpperCase() + action.type.slice(1)}</td><td>${action.name} <em style="font-size:0.9em; opacity:0.7;">(${action.desc || ''})</em></td><td><input type="checkbox" class="action-checkbox" data-action-type="${action.type}" onchange="toggleActionUsed(this)"></td></tr>`;
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  function toggleActionUsed(checkbox) {
Â  Â  Â  Â  Â  Â  const actionType = checkbox.dataset.actionType; const isChecked = checkbox.checked;
Â  Â  Â  Â  Â  Â  document.querySelectorAll(`.action-checkbox[data-action-type="${actionType}"]`).forEach(cb => {
Â  Â  Â  Â  Â  Â  Â  Â  if (cb !== checkbox) { cb.disabled = isChecked; cb.closest('tr').style.opacity = isChecked ? '0.5' : '1'; }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  function resetActions() {
Â  Â  Â  Â  Â  Â  document.querySelectorAll('.action-checkbox').forEach(cb => { cb.checked = false; cb.disabled = false; cb.closest('tr').style.opacity = '1'; });
Â  Â  Â  Â  }

Â  Â  Â  function changeTab(tabId) {
Â  Â  Â  Â  Â  document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
Â  Â  Â  Â  Â  document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
Â  Â  Â  Â  Â  document.getElementById(tabId).classList.add('active');
Â  Â  Â  Â  Â  event.currentTarget.classList.add('active');
Â  Â  Â  }
Â  </script>
</body>
</html>