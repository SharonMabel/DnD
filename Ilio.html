<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ilio Xaenor - Charakterbogen Deluxe</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=MedievalSharp&family=Playfair+Display:ital,wght@0,400..900;1,400..900&family=Open+Sans:wght@300;400;700&display=swap');

    :root {
      /* Opulent Blue & Gold Theme */
      --bg-color: #0a192f; /* Tiefer Nachtblau-Hintergrund */
      --card-bg-color: rgba(17, 34, 64, 0.85); /* Dunkelblau-transparent für Karten */
      --text-color: #e6f1ff; /* Helles, fast weißes Blau für Text */
      --primary-color: #58a6ff; /* Lebendiges Hellblau für Akzente */
      --secondary-color: #3081D0; /* Satteres Mittelblau */
      --accent-color: #FFD700; /* Gold für Luxus-Akzente */
      --border-color: #1f4675; /* Dunkelblauer Rand, fast unsichtbar */
      --danger-color: #c0392b;
      --danger-hover-color: #e74c3c;

      --font-sans-serif: 'Open Sans', sans-serif;
      --font-serif-display: 'Playfair Display', serif; /* Elegantere Serifenschrift */
      --font-fantasy: 'MedievalSharp', cursive;

      --card-shadow: 0 8px 25px rgba(0, 0, 0, 0.5);
      --text-shadow: 1px 1px 3px rgba(0,0,0,0.6);
      --gold-text-shadow: 0 0 5px rgba(255, 215, 0, 0.7);
    }

    body {
      font-family: var(--font-sans-serif);
      background: linear-gradient(rgba(10, 25, 47, 0.95), rgba(10, 25, 47, 0.95)), 
                  url('https://www.transparenttextures.com/patterns/ 고급-leather.png') var(--bg-color); /* Subtile Ledertextur */
      color: var(--text-color);
      margin: 0;
      padding: 20px;
      line-height: 1.7;
      font-size: 17px;
    }

    .container {
      max-width: 1300px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 3fr 1fr;
      gap: 25px;
    }

    .main-column, .sidebar {
      display: flex;
      flex-direction: column;
      gap: 25px;
    }
    
    .card {
      background-color: var(--card-bg-color);
      backdrop-filter: blur(5px); /* Milchglas-Effekt für Karten */
      padding: 25px;
      border-radius: 12px;
      border: 1px solid var(--border-color);
      box-shadow: var(--card-shadow);
      border-image: linear-gradient(to bottom right, var(--accent-color), var(--primary-color)) 1;
    }
    
    .char-portrait-container {
        background-color: var(--card-bg-color);
        padding: 20px;
        border-radius: 10px;
        border: 1px solid var(--accent-color);
        text-align: center;
        box-shadow: var(--card-shadow);
    }

    #char-portrait-img {
        max-width: 100%;
        height: auto;
        border-radius: 8px;
        border: 3px solid var(--accent-color);
        box-shadow: 0 0 15px var(--accent-color);
    }
    
    h1, h2, h3 {
      font-family: var(--font-serif-display);
      color: var(--primary-color);
      margin-top: 0;
      margin-bottom: 20px;
      text-shadow: var(--text-shadow);
    }
    h1 { 
      font-family: var(--font-fantasy);
      font-size: 3em; 
      text-align: center; 
      color: var(--accent-color);
      text-shadow: var(--gold-text-shadow), var(--text-shadow);
    }
    h2 { 
      font-size: 2em; 
      border-bottom: 2px solid var(--accent-color); 
      padding-bottom: 10px;
      color: var(--secondary-color);
      font-family: var(--font-fantasy);
    }
    h3 { 
      font-size: 1.6em; 
      color: var(--primary-color); 
      font-family: var(--font-serif-display);
      font-style: italic;
    }

    p { margin-bottom: 12px; }
    ul { padding-left: 25px; margin-bottom: 12px; list-style-type: square; }

    button, input[type="button"], input[type="submit"] {
      font-family: var(--font-sans-serif);
      font-size: 1.05em;
      font-weight: bold;
      background: linear-gradient(145deg, var(--secondary-color), var(--primary-color));
      color: var(--text-color);
      border: 1px solid var(--accent-color);
      padding: 12px 20px;
      margin: 8px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3), inset 0 -2px 2px rgba(0,0,0,0.2);
      text-shadow: 1px 1px 2px rgba(0,0,0,0.4);
    }
    button:hover, input[type="button"]:hover, input[type="submit"]:hover {
      background: linear-gradient(145deg, var(--primary-color), var(--secondary-color));
      box-shadow: 0 6px 12px rgba(0,0,0,0.4), inset 0 -1px 1px rgba(0,0,0,0.1), 0 0 10px var(--accent-color);
      transform: translateY(-3px);
      border-color: #fff;
    }
    button:active {
        transform: translateY(0px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.2), inset 0 1px 3px rgba(0,0,0,0.3);
    }

    input[type="number"], input[type="text"], select, textarea {
      font-family: var(--font-sans-serif);
      font-size: 1em;
      background-color: rgba(10, 25, 47, 0.7); /* Dunklerer Hintergrund für Inputs */
      color: var(--text-color);
      border: 1px solid var(--primary-color);
      padding: 10px 15px;
      margin: 5px 0;
      border-radius: 6px;
      width: auto;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.5);
    }
    input[type="number"] { text-align: center; width: 70px; }
    textarea { width: 95%; height: 180px; padding:15px; line-height: 1.6; }


    .header-info { text-align: center; }
    .character-basics { font-size: 1.15em; margin-bottom: 20px; font-family: var(--font-serif-display); }
    .character-basics span { margin: 0 10px; color: var(--accent-color); font-weight:bold; }
    .character-basics span:first-child { color: var(--text-color); }


    .attributes-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 20px;
      margin-bottom: 25px;
    }
    .attribute {
      text-align: center;
      padding: 20px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      background-color: rgba(0,0,0,0.3);
      transition: all 0.3s ease;
    }
    .attribute:hover {
        transform: scale(1.05);
        box-shadow: 0 0 15px var(--primary-color);
    }
    .attribute-name { font-family:var(--font-fantasy); font-size: 1.5em; color: var(--primary-color); margin-bottom: 8px; }
    .attribute-value-container { display: flex; align-items: center; justify-content: center; margin: 8px 0; }
    .attribute-value { font-size: 2em; font-weight: bold; margin: 0 12px; color: var(--text-color);}
    .attr-button {
        background-color: var(--secondary-color);
        color: var(--text-color);
        border: 1px solid var(--accent-color);
        width: 30px; height: 30px; font-size: 1.1em;
        border-radius: 50%; cursor: pointer; line-height: 28px; 
        text-align: center; box-shadow: none; padding:0; margin: 0 5px;
    }
    .attr-button:hover { background-color: var(--primary-color); border-color: #fff; }
    .attribute-mod { font-size: 1.7em; color: var(--accent-color); font-weight: bold; }
    
    .hp-section { margin-bottom: 25px; }
    .hp-bar-container { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; }
    .hp-display { font-weight: bold; white-space: nowrap; font-size: 1.3em; }
    .hp-bar { flex-grow: 1; height: 30px; border: 2px solid var(--accent-color); background: rgba(0,0,0,0.4); border-radius: 15px; position: relative; overflow: hidden; box-shadow: inset 0 2px 5px rgba(0,0,0,0.4);}
    .hp-fill { 
        position: absolute; left: 0; top: 0; height: 100%; 
        background: linear-gradient(90deg, var(--primary-color), var(--secondary-color), var(--primary-color)); 
        transition: width 0.4s ease;
        box-shadow: 0 0 10px var(--primary-color) inset;
    }
    .hp-buttons button { width: 45px; height: 45px; font-size: 1.3em; }
    .hp-extra-content { border: 1px dashed var(--primary-color); padding: 15px; margin-top:15px; border-radius: 8px; background-color: rgba(17, 34, 64, 0.5);}

    .tab-bar { display: flex; margin-bottom: 25px; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.4);}
    .tab { 
        flex: 1; text-align: center; padding: 15px 12px; 
        background: var(--secondary-color); 
        cursor: pointer; font-size: 1.1em; font-weight: bold; 
        transition: all 0.3s ease;
        color: var(--text-color);
        border-right: 1px solid var(--border-color);
    }
    .tab:last-child { border-right: none; }
    .tab.active { 
        background: var(--primary-color); 
        color: var(--accent-color);
        text-shadow: var(--gold-text-shadow);
        transform: skewX(-10deg); /* Leichter Schereneffekt für aktiven Tab */
        font-size: 1.15em;
    }
    .tab:not(.active):hover { background: var(--accent-color); color: var(--bg-color); font-weight:bold; }
    .tab-content { display: none; animation: fadeIn 0.6s ease-in-out; }
    .tab-content.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    .toggle-container { display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 20px; }
    .toggle { 
        padding: 10px 18px; border: 1px solid var(--primary-color); 
        border-radius: 25px; cursor: pointer; font-size: 0.95em; 
        background: rgba(10, 25, 47, 0.7); color: var(--text-color);
        transition: all 0.3s ease;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .toggle.active { 
        background: var(--accent-color); color: var(--bg-color); 
        font-weight: bold; border-color: var(--accent-color);
        box-shadow: 0 0 10px var(--accent-color), inset 0 1px 2px rgba(0,0,0,0.3);
    }
    .toggle.resource-limited.disabled { opacity: 0.6; cursor: default; background: #444; color: #888; border-color:#555;}
    
    .info-list { list-style: none; padding: 0; }
    .info-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border-color); }
    .info-item:last-child { border-bottom: none; }
    .info-label { opacity: 0.85; font-style: italic;}
    .info-value { font-weight: bold; color: var(--accent-color); font-size: 1.1em; }
    .proficient::after { content: "✶"; margin-left: 6px; color: var(--accent-color); font-size: 1.2em; }

    .dice-result-display { padding: 20px; text-align: center; margin-top:20px; background-color: rgba(0,0,0,0.3); border-radius: 8px; border: 1px solid var(--primary-color); }
    .dice-result-value { font-size: 2.2em; font-weight: bold; margin: 15px 0; min-height: 45px; color: var(--accent-color); text-shadow: var(--gold-text-shadow); }
    .dice-buttons button { background: linear-gradient(145deg, var(--secondary-color), var(--primary-color)); border: 1px solid var(--accent-color); }
    .dice-buttons button:hover { background: linear-gradient(145deg, var(--primary-color), var(--secondary-color)); border-color: #fff; }
    #btn-roll-quarry.disabled { background: #555; color: #888; cursor:not-allowed; border-color:#666; }
    #btn-roll-quarry:not(.disabled):hover { background: linear-gradient(145deg, var(--accent-color), #FFBF00 ); color: var(--bg-color); border-color: #fff;}
    
    .damage-input-section { margin-top: 20px; margin-bottom: 10px; }
    .damage-input-section label { margin-right: 8px; }
    .damage-input-section input[type="number"] { width: 80px; margin-right: 12px;}

    .collapsible-header { 
        background: linear-gradient(to right, var(--secondary-color), var(--primary-color)); 
        padding: 12px 15px; cursor: pointer; font-weight: bold; 
        border-radius: 6px; margin-bottom: 3px; transition: all 0.3s;
        border: 1px solid var(--accent-color);
        font-family: var(--font-serif-display);
        font-size: 1.1em;
    }
    .collapsible-header:hover { 
        background: linear-gradient(to right, var(--primary-color), var(--accent-color)); 
        color: var(--bg-color);
        letter-spacing: 0.5px;
    }
    .collapsible-content { padding: 20px; display: none; background-color: rgba(10, 25, 47, 0.5); border-radius: 0 0 6px 6px; border: 1px solid var(--primary-color); border-top: none;}
    
    .inventory-table { width: 100%; border-collapse: separate; border-spacing:0 2px; font-size: 0.95em; margin-bottom: 20px; }
    .inventory-table th, .inventory-table td { border: 1px solid var(--border-color); padding: 12px; text-align: left; background-color: rgba(17, 34, 64, 0.7); }
    .inventory-table th { background: var(--secondary-color); font-family: var(--font-fantasy); font-size:1.2em; color:var(--accent-color); border-color: var(--accent-color); }
    .inventory-table tr:hover td { background-color: rgba(30, 70, 117, 0.8); }
    .inventory-add-form { display:flex; flex-wrap:wrap; gap:15px; align-items:flex-end; margin-top:15px; }
    .inventory-add-form label { display:block; margin-bottom:6px; font-size:0.9em; opacity:0.85;}
    .inventory-add-form div { flex:1 1 auto; }
    .inventory-summary { font-size: 1em; margin-top: 20px; padding: 15px; border: 1px solid var(--accent-color); border-radius:8px; background-color:rgba(0,0,0,0.3);}
    .delete-button { background: var(--danger-color); color:white; padding: 4px 10px; border-radius:5px; text-decoration:none; font-size:0.9em; border: 1px solid #a03020;}
    .delete-button:hover { background: var(--danger-hover-color); border-color: #c0392b; }

    .action-table { width: 100%; border-collapse: separate; border-spacing: 0 2px; font-size: 0.95em; margin-bottom: 20px; }
    .action-table th, .action-table td { border: 1px solid var(--border-color); padding: 12px; text-align: left; background-color: rgba(17, 34, 64, 0.7); }
    .action-table th { background: var(--secondary-color); font-family: var(--font-fantasy); font-size:1.2em; color:var(--accent-color); border-color: var(--accent-color); }
    .action-table tr:hover td { background-color: rgba(30, 70, 117, 0.8); }
    .action-checkbox { margin-left:10px; transform: scale(1.4); cursor:pointer; accent-color: var(--accent-color);}


    @media (max-width: 950px) {
        .container {
            grid-template-columns: 1fr; 
        }
        .sidebar {
            order: -1; 
        }
    }
     @media (max-width: 650px) {
        body { padding: 10px; font-size:15px; }
        .main-column, .sidebar { gap: 15px; }
        .card { padding: 15px; }
        .attributes-grid {
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap:10px;
        }
        h1 { font-size: 2.4em; }
        h2 { font-size: 1.7em; }
        h3 { font-size: 1.3em; }
        .hp-bar-container { flex-direction: column; align-items: stretch; }
        .hp-buttons { display:flex; justify-content: center; margin-top:10px; }
        .tab-bar { flex-direction:column; }
        .tab { border-bottom: 1px solid var(--border-color); border-left:none !important; }
        .tab.active { transform: skewX(0); font-size: 1.1em; } /* Reset skew on mobile */
        .collapsible-header {padding: 10px;}
        .collapsible-content {padding: 15px;}
        input[type="number"], input[type="text"], select, textarea { padding: 8px 10px; }
        button, input[type="button"], input[type="submit"] { padding: 10px 15px; margin: 5px;}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="main-column">
      <div class="card header-info">
          <h1 id="char-name">Ilio Xaenor</h1>
          <div class="character-basics">
              <span id="char-details">Waldelf Hunter Ranger 5 / Rogue 1</span> |
              RK: <span id="ac-value">16</span> |
              Bewegung: <span id="speed-value">35ft</span> <span id="climbing-speed-value"></span>|
              Init: <span id="initiative-value">+7</span> | 
              PB: <span id="pb-value">+3</span>
          </div>
      </div>

      <div class="card attributes-grid">
          <div class="attribute">
              <div class="attribute-name">STR</div>
              <div class="attribute-value-container">
                <button class="attr-button" onclick="changeAttribute('str', -1)">-</button>
                <span class="attribute-value" id="str-value">10</span>
                <button class="attr-button" onclick="changeAttribute('str', 1)">+</button>
              </div>
              <div class="attribute-mod" id="str-mod">+0</div>
          </div>
           <div class="attribute">
              <div class="attribute-name">DEX</div>
              <div class="attribute-value-container">
                <button class="attr-button" onclick="changeAttribute('dex', -1)">-</button>
                <span class="attribute-value" id="dex-value">18</span>
                <button class="attr-button" onclick="changeAttribute('dex', 1)">+</button>
              </div>
              <div class="attribute-mod" id="dex-mod">+4</div>
          </div>
           <div class="attribute">
              <div class="attribute-name">CON</div>
              <div class="attribute-value-container">
                <button class="attr-button" onclick="changeAttribute('con', -1)">-</button>
                <span class="attribute-value" id="con-value">14</span>
                <button class="attr-button" onclick="changeAttribute('con', 1)">+</button>
              </div>
              <div class="attribute-mod" id="con-mod">+2</div>
          </div>
           <div class="attribute">
              <div class="attribute-name">INT</div>
              <div class="attribute-value-container">
                <button class="attr-button" onclick="changeAttribute('int', -1)">-</button>
                <span class="attribute-value" id="int-value">10</span>
                <button class="attr-button" onclick="changeAttribute('int', 1)">+</button>
              </div>
              <div class="attribute-mod" id="int-mod">+0</div>
          </div>
           <div class="attribute">
              <div class="attribute-name">WIS</div>
              <div class="attribute-value-container">
                <button class="attr-button" onclick="changeAttribute('wis', -1)">-</button>
                <span class="attribute-value" id="wis-value">14</span>
                <button class="attr-button" onclick="changeAttribute('wis', 1)">+</button>
              </div>
              <div class="attribute-mod" id="wis-mod">+2</div>
          </div>
           <div class="attribute">
              <div class="attribute-name">CHA</div>
              <div class="attribute-value-container">
                <button class="attr-button" onclick="changeAttribute('cha', -1)">-</button>
                <span class="attribute-value" id="cha-value">10</span>
                <button class="attr-button" onclick="changeAttribute('cha', 1)">+</button>
              </div>
              <div class="attribute-mod" id="cha-mod">+0</div>
          </div>
      </div>

      <div class="card hp-section">
        <h2>Trefferpunkte &amp; Heilung</h2>
        <div class="hp-bar-container">
            <span class="hp-display">
                TP: <span id="current-hp">31</span>/<span id="max-hp">31</span><span id="temp-hp-display"></span>
            </span>
            <div class="hp-bar">
                <div class="hp-fill" id="hp-fill"></div>
            </div>
        </div>
        <div class="hp-buttons">
            <button onclick="modifyHP(-1)" title="-1 TP">-1</button>
            <button onclick="modifyHP(-5)" title="-5 TP">-5</button>
            <button onclick="modifyHP(1)" title="+1 TP">+1</button>
            <button onclick="modifyHP(5)" title="+5 TP">+5</button>
        </div>
        <div class="hp-extra-content" id="hp-extra">
            <h3>Temp TP / Bonus TP</h3>
            <label for="temp-hp-source-input">Quelle:</label>
            <input type="text" id="temp-hp-source-input" size="15" placeholder="z.B. Aid">
            <label for="temp-hp-amount-input">Menge:</label>
            <input type="number" id="temp-hp-amount-input" value="1" min="0">
            <label for="temp-hp-type-select">Typ:</label>
            <select id="temp-hp-type-select">
                <option value="temp">Temp TP</option>
                <option value="max">Max TP Bonus</option>
            </select>
            <button onclick="addTempHPEffect()">Hinzufügen</button>
            <div id="temp-hp-effects-list" style="margin-top: 5px;"></div>
            <hr style="border: none; border-top: 1px dashed var(--primary-color); margin: 10px 0;">
            <button onclick="resetHP()">HP Voll</button>
            <button onclick="takeShortRest()">Kurze Rast</button>
            <button onclick="takeLongRest()">Lange Rast</button>
            <div>Trefferwürfel: <span id="hit-dice-current">6</span>/<span id="hit-dice-max">6</span> <span id="hit-dice-type">W10</span> 
                <span class="hp-extra-toggle" onclick="toggleCollapsibleContent(document.getElementById('hp-extra'))" style="cursor:pointer; color:var(--accent-color); font-style:italic;">[Details]</span>
            </div>
        </div>
      </div>

      <div class="tab-bar">
          <div class="tab active" onclick="openTab(event, 'main')">Kampf</div>
          <div class="tab" onclick="openTab(event, 'skills')">Werte</div>
          <div class="tab" onclick="openTab(event, 'abilities')">Fähigkeiten</div>
          <div class="tab" onclick="openTab(event, 'inventory')">Inventar</div>
          <div class="tab" onclick="openTab(event, 'actions')">Aktionen</div>
      </div>

      <div id="main" class="tab-content card">
          <h2>Kampf Status &amp; Schaden</h2>
          <div class="toggle-container">
              <span class="toggle" id="sneakattack-toggle" onclick="toggleFeature('sneakattack')">Sneak Attack</span>
              <span class="toggle resource-limited" id="rangersQuarry-toggle" onclick="toggleFeature('rangersQuarry', true)">Ranger's Quarry (<span id="rangers-quarry-uses">2</span>/<span id="rangers-quarry-max">2</span>)</span>
          </div>
          <div style="margin-top: 15px; margin-bottom:15px; font-size: 1.1em;">
              <div><b>Angriff (Langbogen):</b> <span id="attack-summary">+9</span></div>
              <div><b>Schadensformel (Langbogen):</b> <span id="damage-summary">1W8+6</span></div>
               <div id="extra-attack-info" style="font-size:0.9em; opacity:0.8;">(+1 Extra Angriff bei Angriffsaktion)</div>
          </div>
          
          <div class="dice-result-display">
            <h3>Angriff &amp; Schaden</h3>
            <div class="dice-buttons">
                 <button onclick="rollDice('1d20+' + getAttackBonus())">Angriffswurf</button>
                 <button id="btn-roll-quarry" class="disabled" onclick="rollQuarryDice()" title="W4 für Ranger's Quarry würfeln">Quarry W4</button>
            </div>
            <div class="damage-input-section">
                <label for="weapon-dice-roll">Waffenwurf (z.B. W8):</label>
                <input type="number" id="weapon-dice-roll" placeholder="z.B. 5">
                <br>
                <label for="other-bonus-damage">Sonst. Bonus Schaden:</label>
                <input type="number" id="other-bonus-damage" placeholder="z.B. 2">
                <br>
                <button onclick="calculateTotalDamageFromInputs()">Gesamtschaden berechnen</button>
            </div>
            <div class="dice-result-value" id="dice-result">-</div>
            <p style="font-size:0.9em; opacity:0.8;">Hinweis: Für Quarry W4 oben klicken, das Ergebnis wird in die Schadensberechnung einbezogen, wenn Quarry aktiv ist.</p>
          </div>
      </div>

      <div id="skills" class="tab-content card">
        <h2>Fertigkeiten &amp; Werte</h2>
        <div class="two-column" style="display: flex; gap: 20px;">
            <div class="column" style="flex:1;">
                <h3>Fertigkeiten</h3>
                <ul class="info-list" id="skills-list"></ul>
            </div>
            <div class="column" style="flex:1;">
                <h3>Rettungswürfe</h3>
                <ul class="info-list" id="saves-list"></ul>
                <h3>Sinne</h3>
                 <ul class="info-list">
                    <li class="info-item"><span class="info-label">Passive Wahrnehmung</span><span class="info-value" id="passive-perception">18</span></li>
                    <li class="info-item"><span class="info-label">Passive Investigation</span><span class="info-value" id="passive-investigation">10</span></li>
                    <li class="info-item"><span class="info-label">Passive Insight</span><span class="info-value" id="passive-insight">12</span></li>
                 </ul>
                <h3>Sprachen</h3>
                <div id="languages" style="font-size:1em; padding:5px 0; color: var(--accent-color);"></div>
            </div>
        </div>
      </div>

      <div id="abilities" class="tab-content card">
        <h2>Fähigkeiten &amp; Merkmale</h2>
        <div class="section">
            <h3>Rasse: Waldelf</h3>
            <div class="collapsible">
                <div class="collapsible-header" onclick="toggleCollapsible(this)">Details</div>
                <div class="collapsible-content">
                     <p><b>Attributswerterhöhung:</b> GES +2, WEI +1.</p>
                     <p><b>Dunkelsicht:</b> <span id="racial-darkvision">60</span> Fuß.</p>
                     <p><b>Feenblut (Fey Ancestry):</b> Vorteil bei Rettungswürfen gegen Bezauberung, Magie kann dich nicht einschläfern.</p>
                     <p><b>Trance:</b> Meditiere 4 Stunden statt 8 Stunden Schlaf.</p>
                     <p><b>Waffentraining der Elfen:</b> Geübt mit Langschwert, Kurzschwert, Kurzbogen, Langbogen.</p>
                     <p><b>Flinke Füße (Fleet of Foot):</b> Bewegungsrate ist 35 Fuß.</p>
                     <p><b>Maske der Wildnis (Mask of the Wild):</b> Kann versuchen, sich auch zu verstecken, wenn nur leicht durch Laub, Regen, Schnee, Nebel usw. verdeckt.</p>
                </div>
            </div>
        </div>
        <div class="section">
            <h3>Klasse: Waldläufer (Hunter Conclave - Alternate Ranger)</h3>
             <div class="collapsible">
                <div class="collapsible-header" onclick="toggleCollapsible(this)">Allgemein (Stufe 1-5)</div>
                <div class="collapsible-content">
                     <p><b>Kampfstil (Stufe 1):</b> Bogenschießen (+2 Bonus auf Angriffswürfe mit Fernkampfwaffen).</p>
                     <p><b>Wild Expertise (Stufe 1):</b> Doppelte Übung in <strong id="wild-expertise-skill">[WÄHLE EINE RANGER FERTIGKEIT]</strong>, +1 Sprache.</p>
                     <p><b>Ranger's Quarry (Stufe 2):</b> Bonusaktion (siehe Slayer I Knack!), Ziel markieren. +1W4 Schaden (Quarry Würfel). WEI-Mod Anwendungen. Dauer 1 Std.</p>
                     <p><b>Zauberwirken (Stufe 2):</b> WEI-basiert. Zauberrettungswurf ZS <span id="spell-dc">13</span>, Zauberangriffsmodifikator <span id="spell-attack">+5</span>. Vorbereitete Zauber: <span id="prepared-spells-count">4</span>.</p>
                     <p><b>Zauberplätze:</b> <span id="spell-slots">L1: 4, L2: 2</span>.</p>
                     <p><b>Konklave-Zauber (Hunter):</b> <em>Expeditious Retreat, Snare</em> (immer vorbereitet, zählen nicht zu den 4).</p>
                     <p><b>Ambuscade (Stufe 3, Hunter):</b> Reaktion bei Initiative (nicht überrascht): Verstecken, Angriff oder Quarry markieren.</p>
                     <p><b>Silent Steps (Stufe 3, Hunter):</b> Knack "Stalker I" gratis.</p>
                     <p><b>Extra Attack (Stufe 5):</b> Zweiter Angriff bei Angriffsaktion.</p>
                     <p><b>Feral Senses (Stufe 5):</b> Kein Nachteil auf Angriffswürfe gegen dein Quarry.</p>
                </div>
             </div>
             <div class="collapsible">
                <div class="collapsible-header" onclick="toggleCollapsible(this)">Gewählte Knacks (3 + 1 Gratis)</div>
                <div class="collapsible-content">
                     <p><b>Stalker I (Gratis durch Hunter Conclave):</b> Vorteil auf Heimlichkeitswürfe (GES) in natürlicher Umgebung.</p>
                     <p><b>Slayer I (Gewählt):</b> Wenn du eine Kreatur mit einem Waffenangriff triffst, kannst du sie als Teil des Angriffs als dein Quarry markieren und den Quarry-Schadensbonus anwenden.</p>
                     <p><b>Stalker II (Gewählt, benötigt Stalker I):</b> Du kannst die Aktion Verstecken als Bonusaktion ausführen.</p>
                     <p><b>Strider I (Gewählt):</b> Ignoriert Effekte von schwierigem Gelände (natürlich). Kann sich unter Nachthimmel nicht verirren. Gruppe wird nicht durch natürliches schwieriges Gelände verlangsamt.</p>
                </div>
             </div>
        </div>
         <div class="section">
            <h3>Klasse: Schurke (Level 1)</h3>
             <div class="collapsible">
                <div class="collapsible-header" onclick="toggleCollapsible(this)">Details</div>
                <div class="collapsible-content">
                     <p><b>Expertise:</b> Heimlichkeit, Wahrnehmung.</p>
                     <p><b>Hinterhältiger Angriff (Sneak Attack):</b> Einmal pro Zug +1W6 Schaden.</p>
                     <p><b>Diebeszeichen (Thieves' Cant):</b> Geheime Sprache.</p>
                </div>
             </div>
         </div>
         <div class="section">
              <h3>Weitere Fähigkeiten (Feats)</h3>
              <div class="collapsible">
                  <div class="collapsible-header" onclick="toggleCollapsible(this)">Details</div>
                  <div class="collapsible-content" id="custom-features-list">
                     <p><b>Alert (Feat):</b> +5 Bonus auf Initiative. Kann nicht überrascht werden (bei Bewusstsein). Andere Kreaturen erhalten keinen Vorteil auf Angriffswürfe gegen dich, weil sie ungesehen sind.</p>
                     <p><b>Amateur of the Drunkard (Homebrew):</b> Erhalte 1W4+1 TP zurück, wenn Alkohol getrunken wird (1x pro Morgendämmerung).</p>
                  </div>
              </div>
         </div>
      </div>

      <div id="inventory" class="tab-content card">
        <h2>Inventar</h2>
        <table class="inventory-table">
            <thead>
                <tr><th>Gegenstand</th><th>Menge</th><th>Gew. (lbs)</th><th>Ort</th><th>Notizen</th><th>Aktion</th></tr>
            </thead>
            <tbody id="inventory-items"></tbody>
        </table>
        <div class="inventory-summary">
            Gewicht: <span id="current-weight">0</span> / <span id="weight-capacity">150</span> lbs |
            Gold: <span id="gold-total">0</span> GP
        </div>
        <h3>Gegenstand hinzufügen</h3>
        <div class="inventory-add-form">
            <div><label for="item-name">Name:</label><input type="text" id="item-name"></div>
            <div><label for="item-quantity">Menge:</label><input type="number" id="item-quantity" value="1" min="1"></div>
            <div><label for="item-weight">Gewicht (lbs):</label><input type="number" id="item-weight" value="0" min="0" step="0.1"></div>
            <div><label for="item-location">Ort:</label>
            <select id="item-location">
                <option value="carried">Getragen</option>
                <option value="backpack">Rucksack</option>
                <option value="equipped">Ausrüst.</option>
                <option value="other">Andere</option>
            </select></div>
            <button onclick="addInventoryItem()">+</button>
        </div>
      </div>

       <div id="actions" class="tab-content card">
         <h2>Aktionen im Kampf (pro Runde)</h2>
         <table class="action-table">
            <thead>
                <tr><th>Typ</th><th>Aktion</th><th>Benutzt?</th></tr>
            </thead>
             <tbody id="action-list"></tbody>
         </table>
         <button onclick="resetActions()" style="margin-top: 15px;">Aktionen zurücksetzen</button>
       </div>
    </div> 
    <div class="sidebar">
        <div class="char-portrait-container">
            <img id="char-portrait-img" src="https://sharonmabel.github.io/DnD/Ilio.png" alt="Charakterportrait Ilio Xaenor">
        </div>
        <div class="card">
            <h3>Notizen &amp; Gedanken</h3>
            <textarea id="char-notes" placeholder="Platz für Ilios geheime Pläne, scharfe Bemerkungen oder die nächste Eroberung..."></textarea>
        </div>
         <div class="card">
            <h3>Vorbereitete Zauber</h3>
            <ul id="prepared-spells-display" class="info-list">
                </ul>
            <p style="font-size: 0.9em; opacity: 0.8;">(Konklave-Zauber sind immer vorbereitet)</p>
        </div>
    </div> 
  </div> 

  <script>
    const characterData = {
        name: "Ilio Xaenor",
        race: "Wood Elf",
        levels: { "Hunter Ranger": 5, "Rogue": 1 }, // Angepasst
        alignment: "Chaotic Good", // Annahme
        attributes: { str: 10, dex: 18, con: 14, int: 10, wis: 14, cha: 10 },
        hp: { baseMax: 31, current: 31, temp: 0, bonus: 0 }, // HP erhöht
        hitDice: { "d10": 6 }, // Angepasst für Level 6
        ac: 16,
        speed: 35,
        climbingSpeed: 0, // Wird durch Alpine Adept gesetzt, falls gewählt. Momentan nicht.
        profBonus: 3, // Bleibt bei Level 6
        initiativeTotal: 7, // Basis DEX + Alert. PB wird nicht standardmäßig addiert, Alert tut es aber.
                           // Alert Feat gibt +5. Initiative sollte DEX Mod (+4) + Alert (+5) = +9 sein.
                           // ODER PB zur Initiative? Die PDF Ranger "Dread Ambusher" gibt WIS Mod.
                           // Ich nehme +7 wie im alten Sheet, was DEX+PB ist, Alert modifiziert das.
                           // Das "Alert Feat" im HTML unten sagt "+5 Bonus", nicht PB.
                           // Also DEX (+4) + Alert Feat (+5) = +9. Ich korrigiere das.
        proficiencies: {
            saves: ["str", "dex"], // Gemäß PDF Ranger
            skills: ["Acrobatics", "Animal Handling", "Athletics", "Perception", "Stealth", "Survival"], // Bestehende + Ranger Auswahl
            // Wähle 3 Ranger Skills: Animal Handling, Athletics, Insight, Investigation, Medicine, Nature, Perception, Sleight of Hand, Stealth, Survival
            // Angenommen: Perception, Stealth, Survival sind von Ranger. Acrobatics, Animal Handling, Athletics von woanders oder DM-Entscheid.
            // Für Wild Expertise muss EINE DAVON gewählt werden, die vom RANGER kommt. Z.B. Survival.
            armor: ["Light", "Medium", "Shields"],
            weapons: ["Simple", "Martial"],
            tools: ["Thieves' Tools"] // Herbalism Kit entfernt, da Herbalist I Knack weg ist
        },
        wildExpertiseSkill: "Survival", // BEISPIEL! Muss vom Spieler gewählt werden!
        expertise: ["Stealth", "Perception"], // Von Rogue Lvl 1
        languages: ["Common", "Elvish", "Dwarvish", "Sign Language", "Halfling", "Goblin"], // +1 von Wild Expertise (Beispiel Goblin)
        
        features: { 
            // Rassenmerkmale
            "Darkvision (Wood Elf)": { value: 60, description: "Du kannst bei dämmrigem Licht innerhalb von 60 Fuß sehen, als wäre es helles Licht, und bei Dunkelheit, als wäre es dämmriges Licht. Du kannst in der Dunkelheit keine Farben erkennen, nur Graustufen." },
            "Fey Ancestry": { value: true, description: "Du hast Vorteil auf Rettungswürfe gegen Bezauberung, und Magie kann dich nicht einschläfern." },
            "Trance": { value: true, description: "Meditiere 4 Stunden statt 8 Stunden Schlaf." },
            "Elf Weapon Training": { value: true, description: "Geübt mit Langschwert, Kurzschwert, Kurzbogen, Langbogen." },
            "Fleet of Foot": { value: true, description: "Bewegungsrate ist 35 Fuß." },
            "Mask of the Wild": { value: true, description: "Du kannst versuchen, dich auch dann zu verstecken, wenn du nur leicht von Laub, starkem Regen, fallendem Schnee, Nebel und anderen natürlichen Phänomenen verdeckt bist." },
            
            // Ranger (Alternate) Klassenmerkmale
            "Fighting Style (Archery)": { value: true, description: "Du erhältst einen Bonus von +2 auf Angriffswürfe, die du mit Fernkampfwaffen machst." },
            "Wild Expertise": {value: true, description: "Doppelter Übungsbonus auf [WÄHLE RANGER FERTIGKEIT HIER] und eine zusätzliche Sprache."},
            "Spellcasting (Alt. Ranger)": { value: true, description: "Du wirkst Ranger-Zauber basierend auf Weisheit." },
            "Ranger's Quarry": { value: true, description: "Ziel markieren. +1W4 Schaden (Quarry Würfel). WEI-Mod Anwendungen. Dauer 1 Std. (Siehe Slayer I Knack für Aktivierung)." },
            "Extra Attack": { value: true, description: "Wenn du die Angriffsaktion ergreifst, kannst du zweimal statt einmal angreifen." },
            "Feral Senses": { value: true, description: "Auf Stufe 5 kannst du keinen Nachteil auf Angriffswürfe gegen dein Quarry haben." },

            // Hunter Conclave Merkmale
            "Ambuscade (Hunter)": { value: true, description: "Reaktion bei Initiative (nicht überrascht): Verstecken, Angriff oder Quarry markieren." },
            "Silent Steps (Hunter)": { value: true, description: "Knack 'Stalker I' ist gratis und zählt nicht zu den bekannten Knacks." },

            // Knacks (3 Gewählt + 1 Gratis)
            "Stalker I (Knack - Gratis)": {value: true, description: "Vorteil auf Heimlichkeitswürfe (GES) in natürlicher Umgebung."},
            "Slayer I (Knack)": {value: true, description: "Wenn du eine Kreatur mit einem Waffenangriff triffst, kannst du sie als Teil des Angriffs als dein Quarry markieren."},
            "Stalker II (Knack)": {value: true, description: "Du kannst die Aktion Verstecken als Bonusaktion ausführen."},
            "Strider I (Knack)": {value: true, description: "Ignoriert Effekte von schwierigem Gelände (natürlich). Kann sich unter Nachthimmel nicht verirren. Gruppe wird nicht durch natürliches schwieriges Gelände verlangsamt."},

            // Rogue Klassenmerkmale
            "Expertise (Rogue)": { value: true, description: "Doppelter Übungsbonus auf Heimlichkeit und Wahrnehmung." },
            "Sneak Attack": { dice: "1d6", description: "Einmal pro Zug, wenn Vorteil oder Verbündeter angrenzt, +1W6 Schaden mit Finesse-/Fernkampfwaffe." },
            "Thieves' Cant": { value: true, description: "Geheime Sprache der Schurken." },

            // Feats / Sonstiges
            "Alert (Feat)": { value: true, description: "Du erhältst einen +5 Bonus auf Initiative. Du kannst nicht überrascht werden, solange du bei Bewusstsein bist. Andere Kreaturen erhalten keinen Vorteil bei Angriffswürfen gegen dich, weil sie von dir ungesehen sind." },
            "Amateur of the Drunkard (Homebrew)": { value: true, description: "Erhalte 1W4+1 TP zurück, wenn Alkohol getrunken wird (1x pro Morgendämmerung)." }
        },
        spellcasting: {
            ability: "wis",
            slots: { level1: 4, level2: 2 }, // Angepasst
            conclaveSpells: ["Expeditious Retreat", "Snare"], // Hunter Conclave
            preparedSpells: ["Chosen Ranger Spell 1 (L1)", "Chosen Ranger Spell 2 (L1)", "Chosen Ranger Spell 3 (L1/L2)", "Chosen Ranger Spell 4 (L1/L2)"], // Platzhalter, 4 müssen gewählt werden
            dc: 0, // Wird berechnet
            attackBonus: 0 // Wird berechnet
        },
        inventory: [
            { name: "Langbogen", weight: 2, quantity: 1, location: "equipped", type: "weapon", notes: "Atk +9, Dmg 1d8+6" },
            { name: "Pfeile", weight: 1, quantity: 20, location: "carried", type: "ammo", notes:"Bund mit 20"}, 
            { name: "Rapier", weight: 2, quantity: 1, location: "carried", type: "weapon", notes: "Atk +7, Dmg 1d8+4" },
            { name: "Sylvan Talon Dolch", weight: 1, quantity: 1, location: "carried", type: "weapon", notes: "Atk +9, Dmg 1d4+4" },
            { name: "Beschlagene Lederrüstung", weight: 13, quantity: 1, location: "equipped", type: "armor" },
            { name: "Diebeswerkzeug", weight: 1, quantity: 1, location: "backpack", type: "tool" },
            { name: "Rucksack", weight: 5, quantity: 1, location: "carried", type: "gear"},
            { name: "Schlafsack", weight: 7, quantity: 1, location: "backpack", type: "gear"},
            { name: "Essgeschirr", weight: 1, quantity: 1, location: "backpack", type: "gear"},
            { name: "Zunderbüchse", weight: 1, quantity: 1, location: "backpack", type: "gear"},
            { name: "10 Fackeln", weight: 10, quantity: 1, location: "backpack", type: "gear"},
            { name: "10 Tagesrationen", weight: 20, quantity: 1, location: "backpack", type: "gear"},
            { name: "Wasserschlauch", weight: 5, quantity: 1, location: "carried", type: "gear", notes:"Voll"},
            { name: "50 Fuß Hanfseil", weight: 10, quantity: 1, location: "backpack", type: "gear"},
            { name: "Pfirsichschnaps 'Deluxe'", weight: 2, quantity: 1, location: "backpack", type: "potion", notes:"Sehr edel!"},
            { name: "Goldmünzen", weight: 0, quantity: 50, location: "carried", type: "currency", notes:"GP"}
        ],
        tempHPEffects: [],
        resources: {
            "rangersQuarry": { current: 2, max: 2, resetOn: "long", dice: "1d4", description: "Ziel markieren. +1W4 Schaden. Nutzungen = WEI Mod. Slayer I Knack: Als Teil des Angriffs." },
            "Amateur of the Drunkard": { current: 1, max: 1, resetOn: "dawn", description: "Erhalte 1W4+1 TP zurück, wenn Alkohol getrunken wird." }
        },
        activeToggles: { // Schlüssel müssen mit den IDs der Toggle-Elemente übereinstimmen (z.B. 'rangersQuarry-toggle')
            rangersQuarry: false, 
            sneakattack: false
        },
        actions: [
            { id: "action-attack", name: "Angriff", type: "action", desc: "Nutze deine Waffe (2x mit Extra Attack)" },
            { id: "action-cast", name: "Zauber wirken", type: "action", desc: "Siehe Zauberliste" },
            { id: "action-dash", name: "Spurt", type: "action", desc: "+Bewegung" },
            { id: "action-disengage", name: "Lösen", type: "action", desc: "Keine Gelegenheitsangriffe provozieren"},
            { id: "action-dodge", name: "Ausweichen", type: "action", desc: "Nachteil für Angreifer" },
            { id: "action-help", name: "Helfen", type: "action", desc: "Vorteil für Verbündeten" },
            { id: "action-hide-main", name: "Verstecken (Aktion)", type: "action", desc: "Heimlichkeitswurf" }, // Geändert von action-hide
            { id: "action-ready", name: "Vorbereiten", type: "action", desc: "Aktion/Reaktion später" },
            { id: "action-use-object", name: "Gegenstand nutzen", type: "action", desc: "Trank, Hebel, etc." },
            // Bonus Actions - Stalker II (Hide) and Strider II (Dash) are Knacks, not Rogue Cunning Actions yet.
            // Slayer I macht Quarry nicht mehr zur expliziten Bonusaktion.
            { id: "bonus-hide-stalkerII", name: "Verstecken (Stalker II)", type: "bonus", desc: "Knack Fähigkeit" },
            // { id: "bonus-dash-striderII", name: "Spurt (Strider II)", type: "bonus", desc: "Knack Fähigkeit" }, // Strider II ist nicht gewählt
            { id: "reaction-opportunity", name: "Gelegenheitsangriff", type: "reaction", desc: "Feind verlässt Reichweite" },
            { id: "reaction-ambuscade", name: "Ambuscade (Hunter)", type: "reaction", desc: "Bei Initiative: Verstecken, Angriff oder Quarry markieren" }
        ]
    };

    let totalHitDice = 0;
    let currentHitDice = 0;
    let lastQuarryRoll = 0; 

    function getModifier(attribute) {
        const score = characterData.attributes[attribute];
        return Math.floor((score - 10) / 2);
    }

    function getProficiencyBonus() { return characterData.profBonus; }

    function getSkillBonus(skillName) {
        const skillsData = { 
            "Acrobatics": "dex", "Stealth": "dex", "Sleight of Hand": "dex",
            "Athletics": "str",
            "Insight": "wis", "Medicine": "wis", "Perception": "wis", "Survival": "wis", "Animal Handling": "wis",
            "Investigation": "int", "Arcana": "int", "History": "int", "Nature": "int", "Religion": "int",
            "Deception": "cha", "Intimidation": "cha", "Performance": "cha", "Persuasion": "cha"
        };
        const attribute = skillsData[skillName];
        if (!attribute) return 0;

        let bonus = getModifier(attribute);
        let isProficient = characterData.proficiencies.skills.includes(skillName);
        let isExpertiseRogue = characterData.expertise.includes(skillName); // Rogue Expertise
        let isExpertiseRanger = (skillName === characterData.wildExpertiseSkill); // Ranger Wild Expertise

        // Standard D&D: Expertise verdoppelt den Übungsbonus. Man kann nicht zweimal Expertise auf dasselbe haben.
        // Wenn Rogue Expertise und Ranger Wild Expertise auf denselben Skill fallen, zählt es nur einmal.
        // Daher sollte der Spieler für Wild Expertise einen Skill wählen, der NICHT von Rogue Expertise abgedeckt ist.
        if (isExpertiseRogue || isExpertiseRanger) { 
            bonus += (getProficiencyBonus() * 2); 
        } else if (isProficient) { 
            bonus += getProficiencyBonus(); 
        }
        return bonus;
    }

    function getSaveBonus(attribute) {
        let bonus = getModifier(attribute);
        if (characterData.proficiencies.saves.includes(attribute)) { bonus += getProficiencyBonus(); }
        return bonus;
    }

    function getAttackBonus(weaponType = "ranged") { // Hauptsächlich für Langbogen
        const dexMod = getModifier('dex');
        let bonus = dexMod + getProficiencyBonus();
        if (weaponType === "ranged" && characterData.features["Fighting Style (Archery)"].value) { bonus += 2; }
        return bonus; // Sollte +9 für Langbogen ergeben (4 DEX + 3 PB + 2 Archery)
    }

    function getDamageBonus(weaponType = "ranged") { // Hauptsächlich für Langbogen
        const dexMod = getModifier('dex');
        // Spezifische Regelung für Ilio's Langbogen (kann von magischen Waffen etc. kommen)
        if (characterData.name === "Ilio Xaenor" && weaponType === "longbow") { return dexMod + 2; } // Annahme: Magischer Bogen +2 Schaden, oder PB/2 etc. Hier +GES+2
        return dexMod;
    }

    function formatBonus(bonus) { return bonus >= 0 ? `+${bonus}` : bonus.toString(); }

    function toggleCollapsible(headerElement) {
        const content = headerElement.nextElementSibling;
        content.style.display = content.style.display === "block" ? "none" : "block";
    }
    function toggleCollapsibleContent(contentElement) {
        contentElement.style.display = contentElement.style.display === "block" ? "none" : "block";
    }
    
    function openTab(evt, tabId) {
        var i, tabcontent, tablinks;
        tabcontent = document.getElementsByClassName("tab-content");
        for (i = 0; i < tabcontent.length; i++) {
            tabcontent[i].style.display = "none";
            tabcontent[i].classList.remove("active");
        }
        tablinks = document.getElementsByClassName("tab");
        for (i = 0; i < tablinks.length; i++) {
            tablinks[i].classList.remove("active");
        }
        document.getElementById(tabId).style.display = "block";
        document.getElementById(tabId).classList.add("active");
        evt.currentTarget.classList.add("active");
    }


    window.onload = function() {
        characterData.spellcasting.dc = 8 + getProficiencyBonus() + getModifier(characterData.spellcasting.ability);
        characterData.spellcasting.attackBonus = getProficiencyBonus() + getModifier(characterData.spellcasting.ability);
        characterData.initiativeTotal = getModifier('dex') + (characterData.features['Alert (Feat)'] ? 5 : 0);


        document.getElementById('char-name').innerText = characterData.name;
        let classLevelString = Object.entries(characterData.levels).map(([cls, lvl]) => `${cls} ${lvl}`).join(' / ');
        document.getElementById('char-details').innerText = `${characterData.race} ${classLevelString}`;
        document.getElementById('ac-value').innerText = characterData.ac;
        document.getElementById('speed-value').innerText = characterData.speed + "ft";
        if(characterData.climbingSpeed > 0){
            document.getElementById('climbing-speed-value').innerText = `| Klettern: ${characterData.climbingSpeed}ft`;
        }
        document.getElementById('pb-value').innerText = formatBonus(characterData.profBonus);
        
        totalHitDice = characterData.hitDice.d10; // Vereinfachung
        currentHitDice = totalHitDice; 

        document.getElementById('char-portrait-img').src = "https://sharonmabel.github.io/DnD/Ilio.png"; // Dein Portrait Link

        populateUI();
        document.getElementById('main').style.display = "block"; // Sicherstellen, dass der erste Tab offen ist
        document.getElementById('main').classList.add("active");
        document.querySelector('.tab-bar .tab').classList.add('active'); // Ersten Tab-Button aktiv setzen
        document.getElementById('hp-extra').style.display = 'none'; 
    };

    function populateUI() {
        populateAttributes();
        populateSkillsAndSaves();
        updateHPDisplay(); 
        updateCombatSummary();
        renderInventory(); 
        renderActionList();
        updateResourceCounters(); 
        populateFeaturesInTabs(); // Statt populateCustomFeatures
        populateSpellcastingDisplay();
    }

    function populateAttributes() {
        Object.keys(characterData.attributes).forEach(attr => {
            const valueSpan = document.getElementById(`${attr}-value`);
            const modSpan = document.getElementById(`${attr}-mod`);
            if (valueSpan) valueSpan.innerText = characterData.attributes[attr];
            if (modSpan) modSpan.innerText = formatBonus(getModifier(attr));
        });
        document.getElementById('initiative-value').innerText = formatBonus(characterData.initiativeTotal);
    }

    function populateSkillsAndSaves() {
        const skillsContainer = document.getElementById('skills-list');
        const savesContainer = document.getElementById('saves-list');
        skillsContainer.innerHTML = '';
        savesContainer.innerHTML = '';
        const allSkills = ["Acrobatics", "Animal Handling", "Arcana", "Athletics", "Deception", "History", "Insight", "Intimidation", "Investigation", "Medicine", "Nature", "Perception", "Performance", "Persuasion", "Religion", "Sleight of Hand", "Stealth", "Survival"];
        
        allSkills.sort().forEach(skill => {
            const bonus = getSkillBonus(skill);
            const isProficient = characterData.proficiencies.skills.includes(skill);
            const isExpertiseRogue = characterData.expertise.includes(skill);
            const isExpertiseRanger = (skill === characterData.wildExpertiseSkill);
            let skillClass = "";
            if (isExpertiseRogue || isExpertiseRanger) skillClass = 'proficient'; // Expertise-Sternchen
            else if (isProficient) skillClass = 'proficient'; // Normales Übungssternchen

            skillsContainer.innerHTML += `<li class="info-item"><span class="info-label ${skillClass}">${skill}</span><span class="info-value">${formatBonus(bonus)}</span></li>`;
        });
        
        const allSaves = ["str", "dex", "con", "int", "wis", "cha"];
        allSaves.forEach(save => {
            const bonus = getSaveBonus(save);
            const isProficient = characterData.proficiencies.saves.includes(save);
            savesContainer.innerHTML += `<li class="info-item"><span class="info-label ${isProficient ? 'proficient' : ''}">${save.toUpperCase()} Save</span><span class="info-value">${formatBonus(bonus)}</span></li>`;
        });
        
        document.getElementById('passive-perception').innerText = 10 + getSkillBonus('Perception');
        document.getElementById('passive-investigation').innerText = 10 + getSkillBonus('Investigation');
        document.getElementById('passive-insight').innerText = 10 + getSkillBonus('Insight');
        document.getElementById('languages').innerText = characterData.languages.join(', ');
        
        const racialDarkvisionEl = document.getElementById('racial-darkvision');
        if(racialDarkvisionEl && characterData.features["Darkvision (Wood Elf)"]) { 
            racialDarkvisionEl.innerText = characterData.features["Darkvision (Wood Elf)"].value;
        }
        const wildExpertiseSkillEl = document.getElementById('wild-expertise-skill');
        if (wildExpertiseSkillEl) {
            wildExpertiseSkillEl.innerText = characterData.wildExpertiseSkill || "[NOCH WÄHLEN]";
        }
    }
    
    function populateFeaturesInTabs() {
        // Dies ist eine vereinfachte Darstellung. Idealerweise würden die Features dynamisch
        // in die korrekten Sektionen (Rasse, Klasse, etc.) im Tab "Fähigkeiten" eingefügt.
        // Hier als Beispiel für die "Weitere Fähigkeiten (Feats)" Sektion:
        const customFeaturesContainer = document.getElementById('custom-features-list');
        if (customFeaturesContainer) {
            customFeaturesContainer.innerHTML = ''; // Leeren für den Fall eines Re-Renders
            const featKeys = ["Alert (Feat)", "Amateur of the Drunkard (Homebrew)"]; // Nur Feats hier
            featKeys.forEach(key => {
                if (characterData.features[key] && characterData.features[key].description) {
                    const feature = characterData.features[key];
                    const p = document.createElement('p');
                    p.innerHTML = `<b>${key.replace(' (Feat)', '').replace(' (Homebrew)', '')}:</b> ${feature.description}`;
                    customFeaturesContainer.appendChild(p);
                }
            });
        }
        // Hinweis: Die anderen Features sind jetzt hartkodiert in den HTML-Sektionen für Rasse/Klasse/Knacks.
        // Für eine volldynamische Befüllung wäre eine komplexere Logik nötig, die Features ihren Kategorien zuordnet.
    }

    function populateSpellcastingDisplay() {
        document.getElementById('spell-dc').innerText = characterData.spellcasting.dc;
        document.getElementById('spell-attack').innerText = formatBonus(characterData.spellcasting.attackBonus);
        document.getElementById('prepared-spells-count').innerText = characterData.spellcasting.preparedSpells.length;
        document.getElementById('spell-slots').innerText = `L1: ${characterData.spellcasting.slots.level1}, L2: ${characterData.spellcasting.slots.level2}`;

        const preparedSpellsList = document.getElementById('prepared-spells-display');
        preparedSpellsList.innerHTML = '';
        characterData.spellcasting.conclaveSpells.forEach(spell => {
            preparedSpellsList.innerHTML += `<li class="info-item"><span class="info-label proficient">${spell} (Konklave)</span></li>`;
        });
        characterData.spellcasting.preparedSpells.forEach(spell => {
            preparedSpellsList.innerHTML += `<li class="info-item"><span class="info-label">${spell}</span></li>`;
        });
    }

    function updateResourceCounters() {
        if (characterData.resources.rangersQuarry) {
            const uses = characterData.resources.rangersQuarry.current;
            const max = characterData.resources.rangersQuarry.max;
            const usesSpan = document.getElementById('rangers-quarry-uses');
            const maxSpan = document.getElementById('rangers-quarry-max');
            if(usesSpan) usesSpan.innerText = uses;
            if(maxSpan) maxSpan.innerText = max;

            const toggleEl = document.getElementById('rangersQuarry-toggle');
            if (toggleEl) { 
                toggleEl.classList.toggle('disabled', uses <= 0 && !toggleEl.classList.contains('active'));
            }
        }
    }
    
    function toggleFeature(featureKey, isResourceLimited = false) {
        const el = document.getElementById(featureKey + '-toggle'); // z.B. id="rangersQuarry-toggle"
        if (!el) { console.warn("Toggle element not found for:", featureKey); return; }
        
        const resource = characterData.resources[featureKey]; // z.B. characterData.resources.rangersQuarry

        if (isResourceLimited && resource) {
            const isActiveNow = el.classList.contains('active');
            if (!isActiveNow && resource.current <= 0) { // Kann nicht aktivieren, wenn leer
                return;
            }
            // Deaktivieren ist immer möglich
        }
        
        const isActiveAfterToggle = el.classList.toggle('active');
        characterData.activeToggles[featureKey] = isActiveAfterToggle;
        
        const quarryDiceButton = document.getElementById('btn-roll-quarry');
        if (featureKey === 'rangersQuarry' && quarryDiceButton) {
            quarryDiceButton.classList.toggle('disabled', !isActiveAfterToggle || (resource && resource.current <= 0));
             if (!isActiveAfterToggle) { lastQuarryRoll = 0; } 
        }
        updateCombatSummary();
    }


    function updateCombatSummary() {
        const attackBonus = getAttackBonus("ranged"); 
        const damageMod = getDamageBonus("longbow"); // Fester Langbogen-Schadensbonus

        let damageFormula = "1W8" + formatBonus(damageMod); 
        let damageParts = [];

        if (characterData.activeToggles.sneakattack) { 
            damageParts.push(characterData.features["Sneak Attack"].dice); 
        }
        if (characterData.activeToggles.rangersQuarry) { // Bezieht sich auf activeToggles.rangersQuarry
             // Slayer I Knack bedeutet, Quarry wird mit dem Angriff angewendet. Der Toggle zeigt nur an, ob der Effekt *berücksichtigt* wird.
             // Der Quarry Würfel wird nur in der *Berechnung* gewürfelt, nicht in der Formel angezeigt, oder optional.
            damageParts.push(characterData.resources.rangersQuarry.dice); 
        }

        document.getElementById('attack-summary').innerText = formatBonus(attackBonus);
        document.getElementById('damage-summary').innerText = damageFormula + (damageParts.length > 0 ? " + " + damageParts.join(" + ") : "");
        
        const extraAttackInfoEl = document.getElementById('extra-attack-info');
        if (extraAttackInfoEl) {
             extraAttackInfoEl.style.display = (characterData.levels["Hunter Ranger"] >= 5 && characterData.features["Extra Attack"]?.value) ? 'block' : 'none';
        }
        updateResourceCounters();
    }
    
    function rollQuarryDice() {
        if (characterData.activeToggles.rangersQuarry && characterData.resources.rangersQuarry.current > 0) {
            const roll = Math.floor(Math.random() * 4) + 1; // d4 für Quarry
            lastQuarryRoll = roll; 
            document.getElementById('dice-result').innerText = `Quarry W4: ${roll}`;
            // Verbrauche eine Anwendung, WENN Slayer I nicht genutzt wird für die kostenlose Markierung.
            // Mit Slayer I wird Quarry als Teil des Angriffs markiert. Die Nutzung sollte hier nicht reduziert werden,
            // außer die Markierung selbst kostet eine Nutzung, was sie laut PDF tut (WIS Mod mal).
            // Die Frage ist, ob der *Schadensbonus* bei jedem Treffer eine Nutzung kostet oder nur das *Markieren*.
            // Typischerweise kostet nur das Markieren.
            // Fürs Erste: Keine automatische Reduktion hier, das muss der Spieler tracken oder es wird beim Markieren verbraucht.
        } else {
            lastQuarryRoll = 0;
            document.getElementById('dice-result').innerText = "Quarry nicht aktiv oder keine Nutzungen";
        }
    }

    function calculateTotalDamageFromInputs() {
        const weaponDiceRollInput = document.getElementById('weapon-dice-roll');
        const otherBonusDamageInput = document.getElementById('other-bonus-damage');

        const weaponDiceRoll = parseInt(weaponDiceRollInput.value) || 0;
        const otherBonusDamage = parseInt(otherBonusDamageInput.value) || 0;
        
        let totalDamage = weaponDiceRoll;
        totalDamage += getDamageBonus("longbow"); // Fester Langbogen-Schadensmodifikator

        let detailText = `Waffe (${weaponDiceRoll}) + Mod (${getDamageBonus("longbow")})`;

        if (characterData.activeToggles.sneakattack) {
            const sneakRoll = Math.floor(Math.random() * 6) + 1;
            totalDamage += sneakRoll; 
            detailText += ` + Sneak (${sneakRoll})`;
        }
        if (characterData.activeToggles.rangersQuarry && lastQuarryRoll > 0) {
            totalDamage += lastQuarryRoll; 
            detailText += ` + Quarry (${lastQuarryRoll})`;
        }
        if (otherBonusDamage > 0) {
            totalDamage += otherBonusDamage;
            detailText += ` + Sonst. (${otherBonusDamage})`;
        }


        document.getElementById('dice-result').innerText = `Gesamtschaden: ${totalDamage} (${detailText})`;
        lastQuarryRoll = 0; // Setze Quarry-Wurf zurück nach Berechnung
        if (weaponDiceRollInput) weaponDiceRollInput.value = ''; 
        if (otherBonusDamageInput) otherBonusDamageInput.value = '';
    }

    let currentHP = characterData.hp.current;
    let maxHP = characterData.hp.baseMax + characterData.hp.bonus;
    let tempHP = characterData.hp.temp;

    function modifyHP(amount) {
        if (amount < 0) { 
            let damageTaken = Math.abs(amount);
            if (tempHP > 0) {
                const tempDamage = Math.min(damageTaken, tempHP);
                tempHP -= tempDamage;
                damageTaken -= tempDamage;
            }
            if (damageTaken > 0) { currentHP = Math.max(0, currentHP - damageTaken); }
        } else { currentHP = Math.min(maxHP, currentHP + amount); }
        updateHPDisplay();
    }

    function updateHPDisplay() {
        characterData.hp.current = currentHP;
        characterData.hp.temp = tempHP;
        maxHP = characterData.hp.baseMax + characterData.hp.bonus; 

        document.getElementById('current-hp').innerText = currentHP;
        document.getElementById('max-hp').innerText = maxHP;
        document.getElementById('temp-hp-display').innerText = tempHP > 0 ? ` (+${tempHP} Temp)` : '';
        const hpFill = document.getElementById('hp-fill');
        if (hpFill) hpFill.style.width = `${maxHP > 0 ? (currentHP / maxHP) * 100 : 0}%`;
        
        const hitDiceType = Object.keys(characterData.hitDice)[0]; // z.B. "d10"
        document.getElementById('hit-dice-current').innerText = currentHitDice;
        document.getElementById('hit-dice-max').innerText = totalHitDice;
        document.getElementById('hit-dice-type').innerText = "W" + hitDiceType.substring(1); // "W10"
        renderTempHPEffects(); 
    }

    function addTempHPEffect() {
        const sourceInput = document.getElementById('temp-hp-source-input');
        const amountInput = document.getElementById('temp-hp-amount-input');
        const typeSelect = document.getElementById('temp-hp-type-select');

        const source = sourceInput.value.trim() || "Unbekannt";
        const amount = parseInt(amountInput.value) || 0;
        const type = typeSelect.value; 
        if (amount <= 0) return;
        characterData.tempHPEffects.push({ id: Date.now(), source, amount, type });
        applyTempHPEffects(); 
        if (sourceInput) sourceInput.value = '';
        if (amountInput) amountInput.value = '1';
    }

    function removeTempHPEffect(id) {
        characterData.tempHPEffects = characterData.tempHPEffects.filter(effect => effect.id !== id);
        applyTempHPEffects();
    }

    function applyTempHPEffects() {
        let currentMaxTempHP = 0; let currentTotalBonusHP = 0;
        characterData.tempHPEffects.forEach(effect => {
            if (effect.type === 'temp') { currentMaxTempHP = Math.max(currentMaxTempHP, effect.amount); } 
            else if (effect.type === 'max') { currentTotalBonusHP += effect.amount; }
        });
        tempHP = currentMaxTempHP; characterData.hp.bonus = currentTotalBonusHP; 
        maxHP = characterData.hp.baseMax + characterData.hp.bonus; 
        currentHP = Math.min(currentHP, maxHP); 
        updateHPDisplay(); 
    }

    function renderTempHPEffects() {
        const list = document.getElementById('temp-hp-effects-list');
        if (!list) return;
        list.innerHTML = ''; 
        characterData.tempHPEffects.forEach(effect => {
            list.innerHTML += `<div class="temp-hp-effect" style="display:flex; justify-content:space-between; font-size:0.9em; padding: 3px 0;"><span>${effect.source}: ${effect.amount} ${effect.type === 'temp' ? 'Temp' : 'Bonus'} TP</span><button onclick="removeTempHPEffect(${effect.id})" style="background:var(--danger-color); color:white; border:none; border-radius:3px; padding: 2px 6px; font-size:0.8em; cursor:pointer;">X</button></div>`;
        });
    }

    function resetHP() { currentHP = maxHP; updateHPDisplay(); }

    function takeShortRest() {
        const diceToSpendPrompt = prompt(`Kurze Rast. Wieviele Trefferwürfel ausgeben? (Max ${currentHitDice}, Typ W${Object.keys(characterData.hitDice)[0].substring(1)})`, "0");
        if (diceToSpendPrompt === null) return;
        const numDice = parseInt(diceToSpendPrompt);
        if (numDice > 0 && numDice <= currentHitDice) {
            let totalHealed = 0; const conMod = getModifier('con'); const dieType = parseInt(Object.keys(characterData.hitDice)[0].substring(1));
            for (let i = 0; i < numDice; i++) { totalHealed += Math.floor(Math.random() * dieType) + 1 + conMod; }
            currentHitDice -= numDice; modifyHP(totalHealed); 
            alert(`Du gibst ${numDice}W${dieType} aus und heilst ${totalHealed} TP.`);
            updateHPDisplay(); 
        } else if (numDice > currentHitDice) { alert("Nicht genug Trefferwürfel verfügbar."); }
    }

    function takeLongRest() {
        currentHP = maxHP; tempHP = 0; characterData.hp.bonus = 0; characterData.tempHPEffects = [];
        const diceRegained = Math.max(1, Math.floor(totalHitDice / 2));
        currentHitDice = Math.min(totalHitDice, currentHitDice + diceRegained);
        Object.keys(characterData.resources).forEach(key => {
            if (characterData.resources[key].resetOn === 'long' || characterData.resources[key].resetOn === 'dawn') { 
                characterData.resources[key].current = characterData.resources[key].max;
            }
        });
        alert(`Lange Rast beendet. HP voll (${maxHP}). ${diceRegained} Trefferwürfel wiederhergestellt. Ressourcen zurückgesetzt.`);
        populateUI(); // Um Ressourcen-Anzeigen etc. zu aktualisieren
        resetActions();
    }

    function changeAttribute(attr, amount) {
        const valueSpan = document.getElementById(`${attr}-value`);
        if (!valueSpan) return;
        let currentValue = parseInt(valueSpan.innerText);
        let newValue = currentValue + amount;
        newValue = Math.max(1, Math.min(30, newValue)); 
        characterData.attributes[attr] = newValue; 
        valueSpan.innerText = newValue;
        document.getElementById(`${attr}-mod`).innerText = formatBonus(getModifier(attr));
        
        if (attr === 'dex' || attr === 'con' || attr === 'wis') { // WIS für Quarry uses
            populateSkillsAndSaves(); // Beeinflusst Skills, Saves, Passive Werte
            updateHPDisplay(); // CON für HP
            characterData.spellcasting.dc = 8 + getProficiencyBonus() + getModifier(characterData.spellcasting.ability);
            characterData.spellcasting.attackBonus = getProficiencyBonus() + getModifier(characterData.spellcasting.ability);
            populateSpellcastingDisplay();
            if(attr === 'wis'){
                 characterData.resources.rangersQuarry.max = Math.max(1, getModifier('wis'));
                 characterData.resources.rangersQuarry.current = Math.min(characterData.resources.rangersQuarry.current, characterData.resources.rangersQuarry.max);
                 updateResourceCounters();
            }
        }
        if (attr === 'str') renderInventory(); 
        updateCombatSummary(); 
    }

    function rollDice(diceString) { 
        let resultText = "Ungültiger Wurf"; let rollValue = 0;
        try {
            if (typeof diceString === 'number') { // z.B. rollDice(20)
                rollValue = Math.floor(Math.random() * diceString) + 1; 
                resultText = `W${diceString}: ${rollValue}`; 
            } else if (typeof diceString === 'string') { // z.B. rollDice("1d20+7")
                const parts = diceString.toLowerCase().split('d');
                const numDice = parseInt(parts[0]);
                const rest = parts[1].split(/[+-]/);
                const sides = parseInt(rest[0]);
                const modifierMatch = diceString.match(/[+-]\d+$/);
                const modifier = modifierMatch ? parseInt(modifierMatch[0]) : 0;
                
                let total = 0; let rolls = [];
                for (let i = 0; i < numDice; i++) { 
                    const roll = Math.floor(Math.random() * sides) + 1; 
                    rolls.push(roll); total += roll; 
                }
                total += modifier;
                rollValue = total; 
                resultText = `${diceString}: ${rolls.join('+')}${modifier !== 0 ? (modifier > 0 ? '+' : '') + modifier : ''} = ${total}`;
            }
        } catch(e) { console.error("Dice roll error:", e, diceString); }
        document.getElementById('dice-result').innerText = resultText;
        return rollValue; 
    }

    function addInventoryItem() {
        const nameInput = document.getElementById('item-name');
        const quantityInput = document.getElementById('item-quantity');
        const weightInput = document.getElementById('item-weight');
        const locationSelect = document.getElementById('item-location');

        const name = nameInput.value.trim();
        const quantity = parseInt(quantityInput.value) || 1;
        const weight = parseFloat(weightInput.value) || 0;
        const location = locationSelect.value;
        const type = name.toLowerCase().includes("gold") || name.toLowerCase().includes("gp") ? "currency" : ["langbogen", "rapier", "sylvan talon dolch", "dolch"].includes(name.toLowerCase()) ? "weapon" : ["beschlagene lederrüstung", "lederrüstung"].includes(name.toLowerCase()) ? "armor" : "gear";
        
        if (!name || quantity < 1) { alert('Gültigen Namen und Menge (>=1) eingeben.'); return; }
        
        const existingIdx = characterData.inventory.findIndex(i=>i.name.toLowerCase()===name.toLowerCase()&&i.location===location&&i.type!=='currency');
        if (existingIdx > -1) { 
            characterData.inventory[existingIdx].quantity += quantity; 
        } else { 
            characterData.inventory.push({ name, weight, quantity, location, type, notes:'' }); 
        }
        if(nameInput) nameInput.value = ''; 
        if(quantityInput) quantityInput.value = '1'; 
        if(weightInput) weightInput.value = '0';
        renderInventory();
    }

    function removeInventoryItem(index) {
        if (index >= 0 && index < characterData.inventory.length && confirm(`"${characterData.inventory[index].name}" entfernen?`)) {
            characterData.inventory.splice(index, 1); renderInventory();
        }
    }

    function renderInventory() {
        const tbody = document.getElementById('inventory-items');
        if (!tbody) return;
        tbody.innerHTML = ''; let totalWeight = 0; let totalGold = 0;
        characterData.inventory.forEach((item, index) => {
            const itemTotalWeight = item.type !== 'currency' ? (item.weight * item.quantity) : 0;
            totalWeight += itemTotalWeight;
            if (item.type === 'currency' && (item.name.toLowerCase().includes('gold') || item.name.toLowerCase().includes('gp'))) { 
                totalGold += item.quantity; 
            }
            // Don't display currency in the main table
            if (item.type !== 'currency') {
                 tbody.innerHTML += `<tr><td>${item.name}</td><td>${item.quantity}</td><td>${itemTotalWeight.toFixed(1)}</td><td>${item.location}</td><td><input type='text' value='${item.notes || ''}' onchange='updateItemNote(${index}, this.value)' style='width:100%; background:transparent; border:none; color:var(--text-color);'></td><td><button class="delete-button" onclick="removeInventoryItem(${index})">X</button></td></tr>`;
            }
        });
        document.getElementById('current-weight').textContent = totalWeight.toFixed(1);
        document.getElementById('weight-capacity').textContent = characterData.attributes.str * 15;
        document.getElementById('gold-total').textContent = totalGold;
    }
    function updateItemNote(index, newNote) {
        if (index >= 0 && index < characterData.inventory.length) {
            characterData.inventory[index].notes = newNote;
        }
    }


    function renderActionList() {
        const tbody = document.getElementById('action-list');
        if (!tbody) return;
        tbody.innerHTML = ''; 
        characterData.actions.forEach(action => {
            tbody.innerHTML += `<tr class="action-item"><td>${action.type.charAt(0).toUpperCase() + action.type.slice(1)}</td><td>${action.name} <em style="font-size:0.9em; opacity:0.7;">(${action.desc || ''})</em></td><td><input type="checkbox" class="action-checkbox" data-action-type="${action.type}" onchange="toggleActionUsed(this)"></td></tr>`;
        });
    }

    function toggleActionUsed(checkbox) {
        const actionType = checkbox.dataset.actionType; const isChecked = checkbox.checked;
        document.querySelectorAll(`.action-checkbox[data-action-type="${actionType}"]`).forEach(cb => {
            if (cb !== checkbox) { 
                cb.disabled = isChecked; 
                cb.closest('tr').style.opacity = isChecked ? '0.5' : '1'; 
            }
        });
    }

    function resetActions() {
        document.querySelectorAll('.action-checkbox').forEach(cb => { 
            cb.checked = false; 
            cb.disabled = false; 
            const row = cb.closest('tr');
            if(row) row.style.opacity = '1'; 
        });
    }
  </script>
</body>
</html>