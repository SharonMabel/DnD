<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DM Helper - D&D Campaign Manager</title>
  <style>
       @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Raleway:wght@300;400;600&display=swap');

:root {
  --primary: #1a1a1a;
  --secondary: #121212;
  --accent: #c0c0c0;
  --accent-dark: #707070;
  --accent-glow: #e0e0e0;
  --text: #e0e0e0;
  --text-muted: #909090;
  --danger: #a83232; /* Rot für Monster */
  --success: #32a852; /* Grün für Spieler */
  --info: #3264a8;   /* Blau für Verbündete */
  --neutral-npc: #808080; /* Grau für NPCs */
  --warning: #a88c32;
  --border-radius: 8px;
  --shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
  --border: 1px solid rgba(192, 192, 192, 0.3);
  --font-title: 'Cinzel', serif;
  --font-body: 'Raleway', sans-serif;
}

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body, input, select, button, textarea {
    transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease, transform 0.3s ease;
}

body {
  font-family: var(--font-body);
  background-color: var(--primary);
  color: var(--text);
  line-height: 1.6;
  overflow-x: hidden;
  background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiPjxkZWZzPjxwYXR0ZXJuIGlkPSJwYXR0ZXJuIiBwYXR0ZXJuVW5pdHM9InVzZXJTcGFjZU9uVXNlIiB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHBhdHRlcm5UcmFuc2Zvcm09InJvdGF0ZSg0NSkiPjxyZWN0IHg9IjAiIHk9IjAiIHdpZHRoPSIyMCIgaGVpZGh0PSI0MCIgZmlsbD0idHJhbnNwYXJlbnQiLz48cmVjdCB4PSIwIiB5PSIwIiB3aWR0aD0iMSIgaGVpZHRoPSI0MCIgZmlsbD0icmdiYSg2MCw2MCw2MCwwLjA1KSIvPjwvcGF0dGVybj48L2RlZnM+PHJlY3QgeD0iMCIgeT0iMCIgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0idXJsKCNwYXR0ZXJuKSIvPjwvc3ZnPg==');
  background-attachment: fixed;
}

header { background: var(--secondary); padding: 15px 20px; border-bottom: var(--border); box-shadow: var(--shadow); text-align: center; position: relative; }
h1, h2, h3, h4 { font-family: var(--font-title); color: var(--accent); text-shadow: 0 2px 4px rgba(0,0,0,0.3); letter-spacing: 1px; }
h1 { font-size: 1.8rem; } h2 { font-size: 1.5rem; margin-bottom: 15px; }
h3 { font-size: 1.3rem; margin-bottom: 10px; } h4 { font-size: 1.1rem; margin-bottom: 8px; color: var(--accent-glow); }
.container { max-width: 1200px; margin: 0 auto; padding: 10px; }
.tabs { display: flex; justify-content: center; margin-bottom: 20px; border-radius: var(--border-radius); background: var(--secondary); padding: 2px; box-shadow: var(--shadow); border: var(--border); }
.tab { flex: 1; padding: 10px 15px; text-align: center; cursor: pointer; font-weight: bold; border-radius: calc(var(--border-radius) - 2px); font-family: var(--font-title); }
.tab:hover { background-color: rgba(192,192,192,0.1); }
.tab.active { background: linear-gradient(to bottom, rgba(192,192,192,0.3), rgba(192,192,192,0.1)); color: var(--accent-glow); box-shadow: 0 0 10px rgba(192,192,192,0.2); }
.tab-content { display: none; animation: fadeIn 0.5s ease; }
.tab-content.active { display: block; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

.btn { background: linear-gradient(to bottom, rgba(192,192,192,0.3), rgba(192,192,192,0.1)); color: var(--text); border: var(--border); border-radius: var(--border-radius); padding: 8px 15px; cursor: pointer; font-family: var(--font-title); font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; margin: 5px; min-width: 80px; display: inline-flex; align-items: center; justify-content: center; }
.btn:hover { background: linear-gradient(to bottom, rgba(192,192,192,0.4), rgba(192,192,192,0.2)); box-shadow: 0 0 15px rgba(192,192,192,0.3); transform: translateY(-2px); }
.btn:active { transform: translateY(1px); box-shadow: none; }
.btn-sm { padding: 5px 10px; font-size: 0.8rem; min-width: 60px; } .btn-lg { padding: 12px 20px; font-size: 1.1rem; min-width: 120px; }
.btn-primary { background: linear-gradient(to bottom, rgba(var(--info), 0.6), rgba(var(--info), 0.3)); } /* Geändert für Konsistenz */
.btn-danger { background: linear-gradient(to bottom, rgba(var(--danger), 0.6), rgba(var(--danger), 0.3)); }
.btn-success { background: linear-gradient(to bottom, rgba(var(--success), 0.6), rgba(var(--success), 0.3)); }
.btn-warning { background: linear-gradient(to bottom, rgba(var(--warning), 0.6), rgba(var(--warning), 0.3)); }

.search-container { display: flex; gap: 10px; margin-bottom: 20px; }
.search-input { flex-grow: 1; background: var(--secondary); border: var(--border); border-radius: var(--border-radius); color: var(--text); padding: 10px 15px; font-size: 1rem; }
.search-input:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 2px rgba(192,192,192,0.2); }
.filter-container { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: var(--border-radius); border: var(--border); }
.filter-group { display: flex; align-items: center; gap: 5px; } .filter-label { font-size: 0.9rem; font-weight: bold; color: var(--accent); }
.filter-select { background: var(--secondary); border: var(--border); border-radius: var(--border-radius); color: var(--text); padding: 5px 10px; font-size: 0.9rem; min-width: 120px; }
.monster-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; margin-top: 20px; }
.monster-card { background: var(--secondary); border-radius: var(--border-radius); border: var(--border); padding: 15px; box-shadow: var(--shadow); position: relative; overflow: hidden; cursor: pointer; }
.monster-card:hover { transform: translateY(-5px); box-shadow: 0 8px 16px rgba(0,0,0,0.5); border-color: var(--accent); }
.monster-card.selected { border-color: var(--success) !important; box-shadow: 0 0 15px rgba(50,168,82,0.7); }
.monster-name { font-family: var(--font-title); font-size: 1.2rem; font-weight: bold; color: var(--accent); margin-bottom: 10px; text-shadow: 0 1px 2px rgba(0,0,0,0.5); display: flex; justify-content: space-between; align-items: center; }
.monster-type { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 5px; }
.monster-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; margin: 10px 0; }
.monster-stat { text-align: center; padding: 5px; border-radius: var(--border-radius); background: rgba(0,0,0,0.2); }
.monster-stat-label { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; }
.monster-stat-value { font-size: 1.1rem; font-weight: bold; color: var(--accent); }
.monster-actions { margin-top: 10px; border-top: 1px solid rgba(192,192,192,0.1); padding-top: 10px; display: flex; justify-content: space-between; }
.monster-badge { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 0.7rem; font-weight: bold; background: rgba(50,100,168,0.3); color: var(--text); margin-right: 5px; }

.battle-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: var(--border-radius); border: var(--border); }
.round-tracker { display: flex; align-items: center; gap: 10px; }
.round-number { font-size: 1.8rem; font-weight: bold; font-family: var(--font-title); color: var(--accent); min-width: 50px; text-align: center; }
.battle-actions { display: flex; gap: 10px; flex-wrap: wrap; justify-content: flex-end; }

.initiative-list { background: var(--secondary); border-radius: var(--border-radius); border: var(--border); box-shadow: var(--shadow); margin-bottom: 20px; max-height: calc(100vh - 380px); /* Mehr Platz für Notizen etc. */ overflow-y: auto; }
.initiative-item { padding: 10px; border-bottom: 1px solid rgba(192,192,192,0.1); display: flex; flex-wrap: wrap; justify-content: space-between; align-items: flex-start; /* Bessere Ausrichtung mit mehr Inhalt */ }
.initiative-item:last-child { border-bottom: none; }
/* Farbcodierung für Typen */
.initiative-item.player { border-left: 4px solid var(--success); }
.initiative-item.monster { border-left: 4px solid var(--danger); }
.initiative-item.ally { border-left: 4px solid var(--info); }
.initiative-item.npc { border-left: 4px solid var(--neutral-npc); }

.initiative-item.active { background: linear-gradient(to right, rgba(192,192,192,0.15), rgba(192,192,192,0)); }
/* Die spezifische Typ-Farbe soll die .active-Farbe nicht komplett überschreiben, daher wird die aktive Farbe nur als Hintergrund gesetzt */
.initiative-item.active.player { background: linear-gradient(to right, rgba(var(--success),0.25), rgba(var(--success),0.05)); border-left: 4px solid var(--success); }
.initiative-item.active.monster { background: linear-gradient(to right, rgba(var(--danger),0.25), rgba(var(--danger),0.05)); border-left: 4px solid var(--danger); }
.initiative-item.active.ally { background: linear-gradient(to right, rgba(var(--info),0.25), rgba(var(--info),0.05)); border-left: 4px solid var(--info); }
.initiative-item.active.npc { background: linear-gradient(to right, rgba(var(--neutral-npc),0.25), rgba(var(--neutral-npc),0.05)); border-left: 4px solid var(--neutral-npc); }


.initiative-main-info { display: flex; align-items: center; flex-grow: 1; flex-basis: 60%; /* Mehr Platz für Name und Stats */ }
.initiative-item-drag { cursor: grab; padding: 0 8px 0 0; color: var(--text-muted); align-self: center; }
.initiative-name-type-container { flex-grow: 1; min-width: 130px; margin-right: 10px; }
.initiative-name { font-weight: bold; font-size: 1.1rem; color: var(--accent); }
.initiative-type-display { font-size: 0.8rem; color: var(--text-muted); display: block; }
.initiative-info-stats { display: flex; gap: 8px; align-items: center; flex-wrap: nowrap; }
.initiative-stat { display: flex; align-items: center; gap: 4px; }
.initiative-stat-label { font-size: 0.75rem; color: var(--text-muted); min-width: 20px; }
.initiative-value-input { background: var(--primary); border: 1px solid var(--accent-dark); border-radius: 4px; color: var(--text); padding: 4px 6px; font-size: 0.9rem; text-align: center; }
.initiative-value-input[data-field="initiative"] { width: 45px; }
.initiative-value-input[data-field="hp"] { width: 55px; }
.initiative-value-input[data-field="ac"] { width: 45px; }
.initiative-controls { display: flex; align-items: center; gap: 3px; margin-left: 3px;}
.initiative-btn { width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.3); border: 1px solid rgba(192,192,192,0.3); border-radius: 50%; color: var(--text); font-size: 1rem; cursor: pointer; }
.initiative-btn:hover { background: rgba(192,192,192,0.2); transform: scale(1.1); }
.initiative-btn:active { transform: scale(0.95); }

.initiative-side-actions { display: flex; flex-direction: column; align-items: flex-end; margin-left: 10px; flex-shrink: 0; /* Verhindert Schrumpfen */}
.initiative-remove-btn { padding: 5px 8px; font-size: 0.9rem; min-width: auto; margin-top: 5px; background: rgba(var(--danger),0.4); }
.initiative-remove-btn:hover { background: rgba(var(--danger),0.6); }

.initiative-status-and-notes { flex-basis: 100%; margin-top: 8px; } /* Volle Breite für Umbruch */
.initiative-status { display: flex; flex-wrap: wrap; gap: 5px; align-items: center; margin-bottom: 8px; }
.status-badge { width: 12px; height: 12px; border-radius: 50%; background: var(--text-muted); cursor: pointer; position: relative; } /* Etwas größer */
.status-badge.active { width: 14px; height: 14px; box-shadow: 0 0 6px currentColor; }
.status-badge[data-status="poisoned"]{background-color:var(--success);} .status-badge[data-status="charmed"]{background-color:#e91e63;} .status-badge[data-status="frightened"]{background-color:#9c27b0;} .status-badge[data-status="stunned"]{background-color:#ffc107;} .status-badge[data-status="paralyzed"]{background-color:#607d8b;} .status-badge[data-status="invisible"]{background-color:#00bcd4;} .status-badge[data-status="concentrating"]{background-color:#3f51b5;} .status-badge[data-status="blessed"]{background-color:#ffeb3b;}
.status-tooltip { position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); background: var(--secondary); color: var(--text); padding: 5px 10px; border-radius: var(--border-radius); font-size: 0.8rem; white-space: nowrap; z-index: 10; opacity: 0; pointer-events: none; box-shadow: var(--shadow); margin-bottom: 3px; }
.status-badge:hover .status-tooltip { opacity: 1; transform: translateX(-50%) translateY(-5px); }

.creature-notes-textarea {
    background: rgba(0,0,0,0.2); border: 1px solid var(--accent-dark); border-radius: 4px; color: var(--text);
    padding: 8px; font-size: 0.9rem; width: 100%; min-height: 50px; /* Größeres Feld */
    resize: vertical; /* Erlaubt nur vertikales Ändern der Größe */
}


.add-creature-form { background: var(--secondary); border-radius: var(--border-radius); border: var(--border); box-shadow: var(--shadow); padding: 20px; margin-bottom: 20px; }
.form-row { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
.form-group { display: flex; flex-direction: column; flex: 1; min-width: 120px; }
.form-label { font-size: 0.8rem; margin-bottom: 5px; color: var(--text-muted); }
.form-input { background: var(--primary); border: var(--border); border-radius: var(--border-radius); color: var(--text); padding: 8px 12px; font-size: 0.9rem; }
.form-input:focus { outline: none; border-color: var(--accent); }

.environment-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 15px; margin: 20px 0; } /* Etwas breiter für Touch */
.environment-card { background: var(--secondary); border-radius: var(--border-radius); border: var(--border); padding: 15px; box-shadow: var(--shadow); position: relative; cursor: pointer; }
.environment-card.active { border-color: var(--accent); box-shadow: 0 0 10px rgba(192,192,192,0.3); }
.environment-name { font-weight: bold; font-size: 1rem; color: var(--accent); margin-bottom: 10px; }
.environment-desc { font-size: 0.9rem; color: var(--text-muted); margin-bottom: 10px; }
.active-environment-effects-display { margin-bottom: 15px; padding: 10px; background: rgba(0,0,0,0.1); border-radius: var(--border-radius); border: var(--border); }
#current-battle-env-list { list-style: none; padding-left: 0; font-size: 0.9em; }
#current-battle-env-list li { padding: 3px 0; border-bottom: 1px dashed rgba(192,192,192,0.2); }
#current-battle-env-list li:last-child { border-bottom: none; }

.stats-container{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:20px;margin:20px 0}.stats-card{background:var(--secondary);border-radius:var(--border-radius);border:var(--border);padding:20px;box-shadow:var(--shadow)}.stats-title{font-family:var(--font-title);font-size:1.2rem;color:var(--accent);margin-bottom:15px;border-bottom:1px solid rgba(192,192,192,.2);padding-bottom:10px}.stats-list{list-style:none}.stats-item{display:flex;justify-content:space-between;margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid rgba(192,192,192,.1)}.stats-item:last-child{border-bottom:none}.stats-label{color:var(--text-muted)}.stats-value{font-weight:700;color:var(--accent)}
.modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.8);display:flex;justify-content:center;align-items:center;z-index:1000;opacity:0;pointer-events:none;transition:opacity .3s ease,transform .3s ease}.modal-overlay.active{opacity:1;pointer-events:all}.modal{background:var(--secondary);border-radius:var(--border-radius);border:var(--border);max-width:90%;width:600px;max-height:90vh;overflow-y:auto;box-shadow:0 0 30px rgba(0,0,0,.5);padding:20px;position:relative;transform:translateY(-20px)}.modal-overlay.active .modal{transform:translateY(0)}.modal-close{position:absolute;top:10px;right:10px;width:30px;height:30px;background:rgba(0,0,0,.3);border:none;color:var(--text);font-size:1.2rem;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center}.modal-close:hover{background:rgba(168,50,50,.6);transform:rotate(90deg)}.modal-header{border-bottom:1px solid rgba(192,192,192,.2);padding-bottom:15px;margin-bottom:15px}.modal-title{font-size:1.4rem;color:var(--accent);font-family:var(--font-title)}.modal-body{margin-bottom:20px}.modal-footer{border-top:1px solid rgba(192,192,192,.2);padding-top:15px;display:flex;justify-content:flex-end;gap:10px}
.group-container{margin:20px 0}.group-list{background:var(--secondary);border-radius:var(--border-radius);border:var(--border);box-shadow:var(--shadow);margin-bottom:20px}.group-item{padding:15px;border-bottom:1px solid rgba(192,192,192,.1);display:flex;justify-content:space-between;align-items:center}.group-item:last-child{border-bottom:none}.group-name{font-weight:700;font-size:1.1rem;color:var(--accent)}.group-details{font-size:.9rem;color:var(--text-muted)}.group-actions{display:flex;gap:10px}

/* Quantität-Modal spezifische Stile */
#quantity-modal-input { margin: 10px 0; width: 100%; }


@media(max-width:1024px){.initiative-item{padding:10px;flex-wrap:wrap}.initiative-main-info{flex-basis:100%;margin-bottom:8px}.initiative-name-type-container{min-width:120px;margin-bottom:5px}.initiative-name{font-size:1rem}.initiative-info-stats{gap:8px;justify-content:space-around;width:100%}.initiative-stat{gap:3px}.initiative-value-input{padding:4px 6px;font-size:.85rem}.initiative-value-input[data-field=initiative]{width:45px}.initiative-value-input[data-field=hp]{width:50px}.initiative-value-input[data-field=ac]{width:40px}.initiative-btn{width:30px;height:30px;font-size:1rem}.initiative-side-actions{flex-basis:100%;margin-top:8px;flex-direction:row;justify-content:flex-end;align-items:center;margin-left:0}.initiative-status-and-notes{margin-top:10px;width:100%}.creature-notes-textarea{font-size:.85rem}.initiative-remove-btn{margin-top:0;margin-left:10px}}
@media(max-width:768px){.tabs{flex-wrap:wrap}.monster-grid{grid-template-columns:repeat(auto-fill,minmax(240px,1fr))}.stats-container{grid-template-columns:1fr}.battle-header{flex-direction:column;gap:10px}.environment-grid{grid-template-columns:repeat(auto-fill,minmax(180px,1fr))}.initiative-main-info{flex-direction:column;align-items:flex-start}.initiative-name-type-container{flex-basis:auto;width:100%}.initiative-info-stats{width:100%;justify-content:space-between;margin-top:8px}.initiative-side-actions{width:100%;justify-content:space-between;margin-top:8px}.initiative-status{justify-content:flex-start}}
@media(max-width:480px){.battle-actions .btn{flex-grow:1;font-size:.8rem}.initiative-info-stats{flex-direction:column;align-items:stretch}.initiative-stat{justify-content:space-between}.creature-notes-textarea{font-size:.8rem;min-height:40px}.initiative-side-actions{align-items:flex-end}}

  </style>
</head>
<body>
    <header><h1>DM Helper</h1></header>
    <div class="container">
      <div class="tabs">
        <div class="tab active" data-tab="battle">Kampf</div>
        <div class="tab" data-tab="monsters">Monster</div>
        <div class="tab" data-tab="environment">Umgebung</div>
        <div class="tab" data-tab="stats">Statistiken</div>
      </div>

      <div id="battle" class="tab-content active">
        <div class="battle-header">
          <div class="round-tracker"><div class="round-number" id="round-count">1</div><div>Runde</div></div>
          <div class="battle-actions">
            <button class="btn btn-primary" id="next-turn">Nächster</button>
            <button class="btn" id="next-round">Nächste Runde</button>
            <button class="btn btn-danger" id="end-battle">Kampf beenden</button>
          </div>
        </div>

        <div class="add-creature-form">
            <h3>Kampfteilnehmer hinzufügen</h3>
            <div class="form-row">
              <div class="form-group"><label class="form-label">Name</label><input type="text" class="form-input" id="creature-name" placeholder="Name"></div>
              <div class="form-group"><label class="form-label">Initiative</label><input type="number" class="form-input" id="creature-initiative" placeholder="Wert (oder W20)"></div>
              <div class="form-group"><label class="form-label">HP</label><input type="number" class="form-input" id="creature-hp" placeholder="Trefferpunkte"></div>
              <div class="form-group"><label class="form-label">AC</label><input type="number" class="form-input" id="creature-ac" placeholder="Rüstungsklasse"></div>
              <div class="form-group"><label class="form-label">Typ</label><select class="form-input" id="creature-type"><option value="monster">Monster</option><option value="player">Spieler</option><option value="ally">Verbündeter</option><option value="npc">NPC</option></select></div>
            </div>
            <button class="btn btn-success" id="add-creature">Hinzufügen</button>
            <button class="btn" id="add-from-monster">Aus Monsterliste</button>
            <button class="btn" id="add-from-group">Aus Gruppe</button>
          </div>
          <div class="active-environment-effects-display" id="active-env-effects-in-battle">
            <h4>Aktive Umgebungseffekte:</h4>
            <ul id="current-battle-env-list"></ul>
          </div>
          <div class="initiative-list" id="initiative-list"></div>
        </div>
      <div class="initiative-list" id="initiative-list">
        </div>
    </div>

    <div id="monsters" class="tab-content">
        <div class="search-container">
          <input type="text" class="search-input" id="monster-search" placeholder="Monster suchen...">
          <button class="btn" id="clear-search">Zurücksetzen</button>
        </div>
  
        <div class="filter-container">
          <div class="filter-group">
            <label class="filter-label">CR:</label>
            <select class="filter-select" id="cr-filter">
              <option value="">Alle</option>
              <option value="0-1">0-1</option>
              <option value="2-5">2-5</option>
              <option value="6-10">6-10</option>
              <option value="11-15">11-15</option>
              <option value="16-20">16-20</option>
              <option value="21+">21+</option>
            </select>
          </div>
          <div class="filter-group">
            <label class="filter-label">Typ:</label>
            <select class="filter-select" id="type-filter">
              <option value="">Alle</option>
              <option value="aberration">Aberration</option>
              <option value="beast">Bestie</option>
              <option value="celestial">Himmlisch</option>
              <option value="construct">Konstrukt</option>
              <option value="dragon">Drache</option>
              <option value="elemental">Elementar</option>
              <option value="fey">Feenwesen</option>
              <option value="fiend">Unhold</option>
              <option value="giant">Riese</option>
              <option value="humanoid">Humanoid</option>
              <option value="monstrosity">Monstrosität</option>
              <option value="ooze">Schleim</option>
              <option value="plant">Pflanze</option>
              <option value="undead">Untot</option>
            </select>
          </div>
          <div class="filter-group">
            <button class="btn" id="save-group">Als Gruppe speichern</button>
            <button class="btn" id="manage-groups">Gruppen verwalten</button>
          </div>
        </div>
  
        <div class="monster-grid" id="monster-grid">
          </div>
      </div>
  
      <div id="environment" class="tab-content">
        <h2>Umgebungseffekte</h2>
        <p>Füge Umgebungseffekte hinzu, die sich auf den aktuellen Kampf auswirken können.</p>
        
        <div class="environment-grid">
          <div class="environment-card" data-effect="darkness">
            <h3 class="environment-name">Dunkelheit</h3>
            <p class="environment-desc">Kreaturen ohne Dunkelsicht haben Nachteil auf Wahrnehmungs- und Angriffswürfe.</p>
            <button class="btn btn-sm toggle-effect">Aktivieren</button>
          </div>
          
          <div class="environment-card" data-effect="difficult_terrain">
            <h3 class="environment-name">Schwieriges Gelände</h3>
            <p class="environment-desc">Die Bewegung kostet doppelt so viele Fuß wie normal.</p>
            <button class="btn btn-sm toggle-effect">Aktivieren</button>
          </div>
          
          <div class="environment-card" data-effect="extreme_heat">
            <h3 class="environment-name">Extreme Hitze</h3>
            <p class="environment-desc">Am Ende jeder Runde: CON-Rettungswurf (DC 10) oder 1 Grad Erschöpfung.</p>
            <button class="btn btn-sm toggle-effect">Aktivieren</button>
          </div>
          
          <div class="environment-card" data-effect="underwater">
            <h3 class="environment-name">Unterwasser</h3>
            <p class="environment-desc">Wesen ohne Unterwasseratmung können nur begrenzt Zeit unter Wasser verbringen.</p>
            <button class="btn btn-sm toggle-effect">Aktivieren</button>
          </div>
          
          <div class="environment-card" data-effect="magical_darkness">
            <h3 class="environment-name">Magische Dunkelheit</h3>
            <p class="environment-desc">Normale Dunkelsicht funktioniert nicht. Selbst Wesen mit Dunkelsicht können nicht sehen.</p>
            <button class="btn btn-sm toggle-effect">Aktivieren</button>
          </div>
          
          <div class="environment-card" data-effect="magical_silence">
            <h3 class="environment-name">Magische Stille</h3>
            <p class="environment-desc">Verbal-Komponenten von Zaubern können nicht gesprochen werden.</p>
            <button class="btn btn-sm toggle-effect">Aktivieren</button>
          </div>
          
          <div class="environment-card" data-effect="antimagic_field">
            <h3 class="environment-name">Antimagiefeld</h3>
            <p class="environment-desc">Zauber und magische Effekte sind in diesem Bereich unterdrückt.</p>
            <button class="btn btn-sm toggle-effect">Aktivieren</button>
          </div>
          
          <div class="environment-card" data-effect="fog">
            <h3 class="environment-name">Dichter Nebel</h3>
            <p class="environment-desc">Schwer verhülltes Gebiet, bietet volle Deckung über 5 Fuß.</p>
            <button class="btn btn-sm toggle-effect">Aktivieren</button>
          </div>
          
          <div class="environment-card" data-effect="poisonous_gas">
            <h3 class="environment-name">Giftige Gase</h3>
            <p class="environment-desc">CON-Rettungswurf (DC 13) zu Beginn jedes Zuges oder 1W10 Giftschaden.</p>
            <button class="btn btn-sm toggle-effect">Aktivieren</button>
          </div>
          
          <div class="environment-card" data-effect="slippery_ice">
            <h3 class="environment-name">Rutschiges Eis</h3>
            <p class="environment-desc">DEX-Rettungswurf (DC 10) oder hinfallen, wenn sich bewegt wird.</p>
            <button class="btn btn-sm toggle-effect">Aktivieren</button>
          </div>
          
          <div class="environment-card" data-effect="wild_magic">
            <h3 class="environment-name">Wilde Magie</h3>
            <p class="environment-desc">Bei jedem Zauber W20: Bei 1 tritt ein Effekt der Wilden Magie ein.</p>
            <button class="btn btn-sm toggle-effect">Aktivieren</button>
          </div>
          
          <div class="environment-card" data-effect="hallowed_ground">
            <h3 class="environment-name">Geheiligter Boden</h3>
            <p class="environment-desc">Untote und Unheilige haben Nachteil auf Angriffs- und Attributswürfe.</p>
            <button class="btn btn-sm toggle-effect">Aktivieren</button>
          </div>
        </div>
        
        <h3>Eigenen Effekt hinzufügen</h3>
        <div class="add-creature-form"> <div class="form-row">
            <div class="form-group">
              <label class="form-label">Name</label>
              <input type="text" class="form-input" id="effect-name" placeholder="Effektname">
            </div>
            <div class="form-group">
              <label class="form-label">Beschreibung</label>
              <input type="text" class="form-input" id="effect-desc" placeholder="Effektbeschreibung">
            </div>
          </div>
          <button class="btn btn-success" id="add-effect">Hinzufügen</button>
        </div>
      </div>
  
      <div id="stats" class="tab-content">
        <h2>Kampfstatistiken</h2>
        <p>Hier werden Statistiken zum aktuellen oder letzten Kampf angezeigt.</p>
        
        <div class="stats-container">
          <div class="stats-card">
            <h3 class="stats-title">Allgemeine Infos</h3>
            <ul class="stats-list">
              <li class="stats-item">
                <span class="stats-label">Kampfdauer</span>
                <span class="stats-value" id="stat-combat-duration">0 Runden</span>
              </li>
              <li class="stats-item">
                <span class="stats-label">Teilnehmer</span>
                <span class="stats-value" id="stat-participants">0</span>
              </li>
              <li class="stats-item">
                <span class="stats-label">Initiative Durchschnitt</span>
                <span class="stats-value" id="stat-avg-initiative">0</span>
              </li>
              <li class="stats-item">
                <span class="stats-label">Status</span>
                <span class="stats-value" id="stat-status">Aktiv</span>
              </li>
            </ul>
          </div>
          
          <div class="stats-card">
            <h3 class="stats-title">Schaden & Heilung</h3>
            <ul class="stats-list">
              <li class="stats-item">
                <span class="stats-label">Verursachter Schaden (Spieler)</span>
                <span class="stats-value" id="stat-player-damage">0</span>
              </li>
              <li class="stats-item">
                <span class="stats-label">Verursachter Schaden (Monster)</span>
                <span class="stats-value" id="stat-monster-damage">0</span>
              </li>
              <li class="stats-item">
                <span class="stats-label">Heilung gewirkt</span>
                <span class="stats-value" id="stat-healing">0</span>
              </li>
              <li class="stats-item">
                <span class="stats-label">Höchster Schaden (Einzelangriff)</span>
                <span class="stats-value" id="stat-highest-damage">0</span>
              </li>
            </ul>
          </div>
          
          <div class="stats-card">
            <h3 class="stats-title">Kampfverlauf</h3>
            <ul class="stats-list">
              <li class="stats-item">
                <span class="stats-label">Besiegte Monster</span>
                <span class="stats-value" id="stat-defeated-monsters">0</span>
              </li>
              <li class="stats-item">
                <span class="stats-label">Bewusstlose Spieler</span>
                <span class="stats-value" id="stat-unconscious-players">0</span>
              </li>
              <li class="stats-item">
                <span class="stats-label">Kritische Treffer (Spieler)</span>
                <span class="stats-value" id="stat-player-crits">0</span>
              </li>
              <li class="stats-item">
                <span class="stats-label">Kritische Treffer (Monster)</span>
                <span class="stats-value" id="stat-monster-crits">0</span>
              </li>
            </ul>
          </div>
        </div>
        
        <button class="btn btn-lg" id="export-stats">Statistiken exportieren</button>
      </div>
    </div>
  
    <div class="modal-overlay" id="monster-details-modal">
      <div class="modal">
        <button class="modal-close">&times;</button>
        <div class="modal-header">
          <h2 class="modal-title" id="modal-monster-name">Monstername</h2>
        </div>
        <div class="modal-body" id="modal-monster-details">
          </div>
        <div class="modal-footer">
          <button class="btn" id="modal-add-to-battle">Zum Kampf hinzufügen</button>
          <button class="btn" id="modal-close-btn">Schließen</button>
        </div>
      </div>
    </div>
  
    <div class="modal-overlay" id="save-group-modal">
      <div class="modal">
        <button class="modal-close">&times;</button>
        <div class="modal-header">
          <h2 class="modal-title">Monster-Gruppe speichern</h2>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">Gruppenname</label>
            <input type="text" class="form-input" id="group-name" placeholder="Name der Gruppe">
          </div>
          <div class="form-group">
            <label class="form-label">Beschreibung</label>
            <input type="text" class="form-input" id="group-desc" placeholder="Kurze Beschreibung der Gruppe">
          </div>
          <div id="group-monsters-list">
            </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-success" id="save-group-btn">Speichern</button>
          <button class="btn" id="cancel-group-btn">Abbrechen</button>
        </div>
      </div>
    </div>
  
    <div class="modal-overlay" id="manage-groups-modal">
      <div class="modal">
        <button class="modal-close">&times;</button>
        <div class="modal-header">
          <h2 class="modal-title">Monster-Gruppen verwalten</h2>
        </div>
        <div class="modal-body">
          <div id="groups-list">
            </div>
        </div>
        <div class="modal-footer">
          <button class="btn" id="close-groups-btn">Schließen</button>
        </div>
      </div>
    </div>
  
    <div class="modal-overlay" id="end-battle-modal">
      <div class="modal">
        <button class="modal-close">&times;</button>
        <div class="modal-header">
          <h2 class="modal-title">Kampf beenden</h2>
        </div>
        <div class="modal-body">
          <p>Bist du sicher, dass du den aktuellen Kampf beenden möchtest? Es werden Statistiken erstellt und die Initiative-Liste wird zurückgesetzt.</p>
        </div>
        <div class="modal-footer">
          <button class="btn btn-danger" id="confirm-end-battle">Kampf beenden</button>
          <button class="btn" id="cancel-end-battle">Abbrechen</button>
        </div>
      </div>
    </div>

    <div class="modal-overlay" id="monster-quantity-modal">
        <div class="modal">
            <button class="modal-close">&times;</button>
            <div class="modal-header">
                <h2 class="modal-title">Anzahl hinzufügen</h2>
            </div>
            <div class="modal-body">
                <p>Wie viele <strong id="quantity-monster-name">Monster</strong> möchtest du hinzufügen?</p>
                <input type="number" class="form-input" id="quantity-modal-input" placeholder="Anzahl (Standard: 1)" min="1">
            </div>
            <div class="modal-footer">
                <button class="btn btn-success" id="confirm-quantity-btn">Weiter</button>
                <button class="btn" id="cancel-quantity-btn">Abbrechen</button>
            </div>
        </div>
    </div>
  
    <script src="srd_monster_data_output.js"></script> <script>
      let state = {
        activeBattleIndex: -1,
        monsters: [], // Wird von srd_monster_data_output.js gefüllt
        filteredMonsters: [],
        savedGroups: [],
        monsterNameCounters: {}, // Für die Nummerierung von Monstern
        activeBattle: {
          round: 1,
          initiative: [],
          activeEffects: [], // Hier werden aktive Umgebungseffekte gespeichert
          stats: {
            playerDamage: 0, monsterDamage: 0, healing: 0, highestDamage: 0,
            defeatedMonsters: 0, unconsciousPlayers: 0, playerCrits: 0, monsterCrits: 0
          }
        }
      };
  
      // Globale Variable für eindeutige IDs, die beim Laden initialisiert wird
      let nextGeneratedId = Date.now(); 
      let monsterToAddWithQuantity = null; // Speichert das Monsterobjekt für das Quantitätsmodal
      
      function generateUniqueId() {
          return nextGeneratedId++;
      }
  
      // UI Elemente abrufen
      const tabs = document.querySelectorAll('.tab');
      const tabContents = document.querySelectorAll('.tab-content');
      const monsterGrid = document.getElementById('monster-grid');
      const monsterSearch = document.getElementById('monster-search');
      const crFilter = document.getElementById('cr-filter');
      const typeFilter = document.getElementById('type-filter');
      const clearSearchBtn = document.getElementById('clear-search');
      const initiativeList = document.getElementById('initiative-list');
      const roundCounter = document.getElementById('round-count');
      const nextTurnBtn = document.getElementById('next-turn');
      const nextRoundBtn = document.getElementById('next-round');
      const endBattleBtn = document.getElementById('end-battle');
      const addCreatureBtn = document.getElementById('add-creature');
      const addFromMonsterBtn = document.getElementById('add-from-monster');
      const creatureNameInput = document.getElementById('creature-name');
      const creatureInitiativeInput = document.getElementById('creature-initiative');
      const creatureHpInput = document.getElementById('creature-hp');
      const creatureAcInput = document.getElementById('creature-ac');
      const creatureTypeSelect = document.getElementById('creature-type');
      const addEffectBtn = document.getElementById('add-effect');
      const effectNameInput = document.getElementById('effect-name');
      const effectDescInput = document.getElementById('effect-desc');
      const saveGroupBtn = document.getElementById('save-group');
      const manageGroupsBtn = document.getElementById('manage-groups');
      
      const monsterDetailsModal = document.getElementById('monster-details-modal');
      const saveGroupModal = document.getElementById('save-group-modal');
      const manageGroupsModal = document.getElementById('manage-groups-modal');
      const endBattleModal = document.getElementById('end-battle-modal');
      const monsterQuantityModal = document.getElementById('monster-quantity-modal');

      const modalCloseButtons = document.querySelectorAll('.modal-close, #modal-close-btn, #cancel-group-btn, #close-groups-btn, #cancel-end-battle, #cancel-quantity-btn');
      const confirmEndBattleBtn = document.getElementById('confirm-end-battle');
      const saveGroupModalBtn = document.getElementById('save-group-btn'); 
      const exportStatsBtn = document.getElementById('export-stats');
      const currentBattleEnvList = document.getElementById('current-battle-env-list'); // Für Anzeige im Kampf-Tab
      const confirmQuantityBtn = document.getElementById('confirm-quantity-btn');
      const quantityModalInput = document.getElementById('quantity-modal-input');
      const quantityMonsterName = document.getElementById('quantity-monster-name');


      function init() {
        if (typeof monsterData !== 'undefined') { // Sicherstellen, dass die externen Monsterdaten geladen wurden
            state.monsters = [...monsterData];
            state.filteredMonsters = [...monsterData];
        } else {
            console.error("Monsterdaten (monsterData) wurden nicht geladen. Stelle sicher, dass 'srd_monster_data_output.js' korrekt eingebunden ist und die Variable monsterData definiert.");
            state.monsters = [];
            state.filteredMonsters = [];
        }
        loadState(); 
        renderMonsterGrid();
        renderInitiativeList();
        renderActiveEnvironmentEffects(); 
        renderActiveEffectsInBattleView(); 
        updateStats();
        setupEventListeners();
      }
      
      function saveState() {
        try {
          localStorage.setItem('dmHelper', JSON.stringify(state));
        } catch (e) { console.error("Error saving state:", e); }
      }

      function loadState() {
        const savedState = localStorage.getItem('dmHelper');
        if (savedState) {
            try {
                const parsedState = JSON.parse(savedState);
                
                state.savedGroups = Array.isArray(parsedState.savedGroups) ? parsedState.savedGroups : [];
                state.monsterNameCounters = parsedState.monsterNameCounters || {};
                
                if (parsedState.activeBattle) {
                    state.activeBattle = {
                        round: parsedState.activeBattle.round || 1,
                        initiative: Array.isArray(parsedState.activeBattle.initiative) ? parsedState.activeBattle.initiative : [],
                        activeEffects: Array.isArray(parsedState.activeBattle.activeEffects) ? parsedState.activeBattle.activeEffects : [],
                        stats: parsedState.activeBattle.stats || { playerDamage: 0, monsterDamage: 0, healing: 0, highestDamage: 0, defeatedMonsters: 0, unconsciousPlayers: 0, playerCrits: 0, monsterCrits: 0 }
                    };
                } else {
                    state.activeBattle = { round: 1, initiative: [], activeEffects: [], stats: { playerDamage: 0, monsterDamage: 0, healing: 0, highestDamage: 0, defeatedMonsters: 0, unconsciousPlayers: 0, playerCrits: 0, monsterCrits: 0 } };
                }
                state.activeBattleIndex = typeof parsedState.activeBattleIndex === 'number' ? parsedState.activeBattleIndex : -1;
                nextGeneratedId = parsedState.nextGeneratedId || Date.now();

            } catch (e) {
                console.error('Error loading saved state from localStorage. Resetting relevant parts.', e);
                state.savedGroups = [];
                state.monsterNameCounters = {};
                state.activeBattle = { round: 1, initiative: [], activeEffects: [], stats: { playerDamage: 0, monsterDamage: 0, healing: 0, highestDamage: 0, defeatedMonsters: 0, unconsciousPlayers: 0, playerCrits: 0, monsterCrits: 0 } };
                state.activeBattleIndex = -1;
                nextGeneratedId = Date.now();
            }
        }
        state.filteredMonsters = [...state.monsters];
      }

      function setupEventListeners() {
        tabs.forEach(tab => {
          tab.addEventListener('click', () => {
            const tabId = tab.dataset.tab;
            tabs.forEach(t => t.classList.remove('active'));
            tabContents.forEach(tc => tc.classList.remove('active'));
            tab.classList.add('active');
            document.getElementById(tabId).classList.add('active');
          });
        });
  
        monsterSearch.addEventListener('input', filterMonsters);
        crFilter.addEventListener('change', filterMonsters);
        typeFilter.addEventListener('change', filterMonsters);
        clearSearchBtn.addEventListener('click', clearFilters);
  
        nextTurnBtn.addEventListener('click', nextTurn);
        nextRoundBtn.addEventListener('click', nextRound);
        endBattleBtn.addEventListener('click', () => endBattleModal.classList.add('active'));
        confirmEndBattleBtn.addEventListener('click', endBattle);
  
        addCreatureBtn.addEventListener('click', addCreatureToBattle);
        addFromMonsterBtn.addEventListener('click', () => {
          tabs.forEach(t => t.classList.remove('active'));
          tabContents.forEach(tc => tc.classList.remove('active'));
          document.querySelector('.tab[data-tab="monsters"]').classList.add('active');
          document.getElementById('monsters').classList.add('active');
        });
         document.getElementById('add-from-group').addEventListener('click', () => {
            manageGroupsModal.classList.add('active');
            renderSavedGroups();
        });
  
        document.querySelectorAll('.environment-card .toggle-effect').forEach(button => {
            const card = button.closest('.environment-card');
            button.addEventListener('click', (e) => {
                e.stopPropagation(); 
                const effectId = card.dataset.effect;
                const effectName = card.querySelector('.environment-name').textContent;
                const effectDesc = card.querySelector('.environment-desc').textContent;
                toggleEnvironmentEffect(effectId, effectName, effectDesc); 
            });
        });

        addEffectBtn.addEventListener('click', addCustomEffect);
  
        modalCloseButtons.forEach(btn => {
          btn.addEventListener('click', () => {
            btn.closest('.modal-overlay').classList.remove('active');
          });
        });
  
        saveGroupBtn.addEventListener('click', () => {
          saveGroupModal.classList.add('active');
          renderGroupPreview();
        });
        manageGroupsBtn.addEventListener('click', () => {
          manageGroupsModal.classList.add('active');
          renderSavedGroups();
        });
        saveGroupModalBtn.addEventListener('click', saveMonsterGroup);
        exportStatsBtn.addEventListener('click', exportStatistics);

        confirmQuantityBtn.addEventListener('click', () => {
            const quantity = parseInt(quantityModalInput.value) || 1;
            if (monsterToAddWithQuantity) {
                addMonsterToBattle(monsterToAddWithQuantity, quantity);
            }
            monsterQuantityModal.classList.remove('active');
            monsterToAddWithQuantity = null; 
            quantityModalInput.value = ''; 
        });
      }
      
      function openQuantityModal(monster) {
        monsterToAddWithQuantity = monster;
        quantityMonsterName.textContent = monster.name || "Dieses Monster";
        quantityModalInput.value = ''; // Reset input
        monsterQuantityModal.classList.add('active');
        quantityModalInput.focus();
      }

      function renderMonsterGrid() {
        monsterGrid.innerHTML = '';
        if (!state.filteredMonsters || state.filteredMonsters.length === 0) {
          monsterGrid.innerHTML = '<p style="padding:20px; text-align:center;">Keine Monster gefunden.</p>';
          return;
        }
        state.filteredMonsters.forEach(monster => {
          if (!monster || !monster.id) { 
              console.warn("Fehlerhaftes Monsterobjekt übersprungen:", monster);
              return;
          }
          const card = document.createElement('div');
          card.className = 'monster-card';
          if (monster.isSelectedForGroup) card.classList.add('selected');
          card.dataset.id = monster.id;
          
          card.innerHTML = `
            <div class="monster-name">
              ${monster.name || 'Unbenannt'} <span class="monster-badge">${monster.cr || 'N/A'}</span>
            </div>
            <div class="monster-type">${monster.type || 'Unbekannt'} ${monster.alignment || ''}</div>
            <div class="monster-stats">
              <div class="monster-stat"><div class="monster-stat-label">AC</div><div class="monster-stat-value">${monster.ac || 'N/A'}</div></div>
              <div class="monster-stat"><div class="monster-stat-label">HP</div><div class="monster-stat-value">${monster.hp || 'N/A'}</div></div>
              <div class="monster-stat"><div class="monster-stat-label">Speed</div><div class="monster-stat-value">${(String(monster.speed || 'N/A')).split(' ')[0]}</div></div>
            </div>
            <div class="monster-actions">
              <button class="btn btn-sm btn-primary" data-action="add">Zum Kampf</button>
              <button class="btn btn-sm" data-action="details">Details</button>
            </div>`;
          
          card.querySelector('[data-action="add"]').addEventListener('click', (e) => { e.stopPropagation(); openQuantityModal(monster); });
          card.querySelector('[data-action="details"]').addEventListener('click', (e) => { e.stopPropagation(); showMonsterDetails(monster); });
          card.addEventListener('click', (e) => {
            if (e.target.closest('.btn')) return;
            card.classList.toggle('selected');
            monster.isSelectedForGroup = card.classList.contains('selected');
            if (saveGroupModal.classList.contains('active')) renderGroupPreview();
          });
          monsterGrid.appendChild(card);
        });
      }
  
      function filterMonsters() {
        const searchTerm = monsterSearch.value.toLowerCase();
        const crValue = crFilter.value;
        const typeValue = typeFilter.value.toLowerCase();
        
        state.filteredMonsters = state.monsters.filter(monster => {
          if (!monster || !monster.name) return false;
          const nameMatch = monster.name.toLowerCase().includes(searchTerm);
          const typeTextMatch = monster.type && monster.type.toLowerCase().includes(searchTerm);
          const alignmentMatch = monster.alignment && monster.alignment.toLowerCase().includes(searchTerm);
          const matchesSearch = searchTerm === '' || nameMatch || typeTextMatch || alignmentMatch;
          
          let matchesCR = true;
          if (crValue) {
            let crNum;
            if (monster.cr === "—" || typeof monster.cr === 'undefined' || monster.cr === null || String(monster.cr).trim() === "") crNum = -1;
            else if (String(monster.cr).includes('/')) {
                const parts = String(monster.cr).split('/');
                if (parts.length === 2 && !isNaN(parseFloat(parts[0])) && !isNaN(parseFloat(parts[1])) && parseFloat(parts[1]) !== 0) crNum = parseFloat(parts[0]) / parseFloat(parts[1]);
                else crNum = -2;
            } else crNum = parseFloat(monster.cr);
            if (isNaN(crNum)) crNum = -2;

            const [minStr, maxStr] = crValue.split('-');
            const minNum = parseFloat(minStr);
            if (crNum < -1 && crValue !== "") matchesCR = false; 
            else if (maxStr) matchesCR = crNum >= minNum && crNum <= parseFloat(maxStr);
            else matchesCR = crNum >= minNum;
          }
          const matchesType = typeValue === '' || (monster.type && monster.type.toLowerCase().includes(typeValue));
          return matchesSearch && matchesCR && matchesType;
        });
        renderMonsterGrid();
      }
  
      function clearFilters() {
        monsterSearch.value = ''; crFilter.value = ''; typeFilter.value = '';
        state.filteredMonsters = [...state.monsters]; renderMonsterGrid();
      }
  
      function showMonsterDetails(monster) {
        const modalTitle = document.getElementById('modal-monster-name');
        const modalBody = document.getElementById('modal-monster-details');
        modalTitle.textContent = monster.name || "Unbekanntes Monster";
        
        let featuresHTML = "";
        if (monster.features && monster.features.length > 0) {
            featuresHTML = `
            <div style="margin: 15px 0;">
              <h4 style="border-bottom: 1px solid rgba(192,192,192,0.2); padding-bottom: 5px; margin-bottom: 8px;">Eigenschaften</h4>
              <ul style="list-style-type: none; padding-left: 0;">${monster.features.map(feature => `<li style="margin-bottom: 5px;">• ${feature}</li>`).join('')}</ul>
            </div>`;
        }
        let actionsHTML = "";
        if (monster.actions && monster.actions.length > 0) {
             actionsHTML = `
            <div style="margin: 15px 0;">
              <h4 style="border-bottom: 1px solid rgba(192,192,192,0.2); padding-bottom: 5px; margin-bottom: 8px;">Aktionen</h4>
              <ul style="list-style-type: none; padding-left: 0;">${monster.actions.map(action => `<li style="margin-bottom: 5px;">• ${action}</li>`).join('')}</ul>
            </div>`;
        }

        modalBody.innerHTML = `
          <div class="monster-type">${monster.type || 'N/A'} ${monster.alignment || ''}</div>
          <div class="monster-stats" style="margin: 15px 0;">
            <div class="monster-stat"><div class="monster-stat-label">AC</div><div class="monster-stat-value">${monster.ac || 'N/A'}</div></div>
            <div class="monster-stat"><div class="monster-stat-label">HP</div><div class="monster-stat-value">${monster.hp || 'N/A'}</div></div>
            <div class="monster-stat"><div class="monster-stat-label">CR</div><div class="monster-stat-value">${monster.cr || 'N/A'}</div></div>
          </div>
          <div style="margin-bottom: 10px;"><strong>Bewegung:</strong> ${monster.speed || 'N/A'}</div>
          <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 5px; margin: 15px 0;">
            ${Object.entries(monster.attributes || {}).map(([key, value]) => `
                <div class="monster-stat">
                    <div class="monster-stat-label">${key.toUpperCase()}</div>
                    <div class="monster-stat-value">${value !== undefined ? value : 'N/A'}</div>
                </div>`).join('')}
          </div>
          ${monster.saves && Object.keys(monster.saves).length > 0 ? `<div style="margin-bottom: 10px;"><strong>Rettungswürfe:</strong> ${Object.entries(monster.saves).map(([key, val]) => `${key.toUpperCase()} +${val}`).join(', ')}</div>` : ''}
          <div style="margin-bottom: 10px;"><strong>Fertigkeiten:</strong> ${monster.skills || 'Keine'}</div>
          <div style="margin-bottom: 10px;"><strong>Schadensresistenzen:</strong> ${monster.damage_res || 'Keine'}</div>
          <div style="margin-bottom: 10px;"><strong>Schadensimmunitäten:</strong> ${monster.damage_imm || 'Keine'}</div>
          <div style="margin-bottom: 10px;"><strong>Zustandsimmunitäten:</strong> ${monster.condition_imm || 'Keine'}</div>
          <div style="margin-bottom: 10px;"><strong>Sinne:</strong> ${monster.senses || 'Keine'}</div>
          <div style="margin-bottom: 10px;"><strong>Sprachen:</strong> ${monster.languages || 'Keine'}</div>
          ${featuresHTML}
          ${actionsHTML}
          ${monster.legendary_actions && monster.legendary_actions.length > 0 ? `
            <div style="margin: 15px 0;">
              <h4 style="border-bottom: 1px solid rgba(192,192,192,0.2); padding-bottom: 5px; margin-bottom: 8px;">Legendäre Aktionen</h4>
              <ul style="list-style-type: none; padding-left: 0;">${monster.legendary_actions.map(action => `<li style="margin-bottom: 5px;">• ${action}</li>`).join('')}</ul>
            </div>` : ''}
          ${monster.spellcasting ? `<div style="margin:15px 0;"><h4 style="border-bottom: 1px solid rgba(192,192,192,0.2); padding-bottom: 5px;">Zauber</h4><p>Kann Zauber wirken. Details siehe Quelle.</p></div>` : ''}
          ${monster.details ? `<div style="margin:15px 0;"><h4 style="border-bottom: 1px solid rgba(192,192,192,0.2); padding-bottom: 5px;">Details</h4><p>${monster.details}</p></div>` : ''}
        `;
        const newAddToBattleBtn = document.getElementById('modal-add-to-battle').cloneNode(true); 
        document.getElementById('modal-add-to-battle').parentNode.replaceChild(newAddToBattleBtn, document.getElementById('modal-add-to-battle'));
        newAddToBattleBtn.addEventListener('click', () => { 
            openQuantityModal(monster); 
            monsterDetailsModal.classList.remove('active'); 
        });
        monsterDetailsModal.classList.add('active');
      }

      function addCreatureToBattle() {
        const name = creatureNameInput.value.trim();
        const initiative = creatureInitiativeInput.value === '' ? (Math.floor(Math.random() * 20) + 1) : parseInt(creatureInitiativeInput.value);
        const hp = parseInt(creatureHpInput.value) || 10;
        const ac = parseInt(creatureAcInput.value) || 10;
        const type = creatureTypeSelect.value;
        if (!name) { alert('Bitte gib einen Namen ein.'); return; }
        const newCreature = {
            id: generateUniqueId(), name, initiative, currentHp: hp, maxHp: hp, ac, type, statuses: [], notes: ""
        };
        state.activeBattle.initiative.push(newCreature);
        sortInitiative(newCreature.id); renderInitiativeList(); updateStats();
        creatureNameInput.value = ''; creatureInitiativeInput.value = ''; creatureHpInput.value = ''; creatureAcInput.value = '';
        saveState();
      }

      function addMonsterToBattle(monster, quantity = 1) {
        const baseName = monster.name;
        if (!state.monsterNameCounters[baseName]) {
            state.monsterNameCounters[baseName] = 0;
        }

        for (let i = 0; i < quantity; i++) {
            state.monsterNameCounters[baseName]++;
            const currentMonsterCount = state.monsterNameCounters[baseName];
            const monsterName = quantity > 1 || currentMonsterCount > 1 ? `${baseName} ${currentMonsterCount}` : baseName;
            
            const dexMod = monster.attributes && typeof monster.attributes.dex === 'number' ? Math.floor((monster.attributes.dex - 10) / 2) : 0;
            const initiative = Math.floor(Math.random() * 20) + 1 + dexMod;
            const newCreature = {
                id: generateUniqueId(), name: monsterName, initiative, currentHp: monster.hp, maxHp: monster.hp,
                ac: monster.ac, type: 'monster', monsterId: monster.id, statuses: [], notes: "", originalName: baseName
            };
            state.activeBattle.initiative.push(newCreature);
            sortInitiative(newCreature.id); 
        }
        renderInitiativeList(); updateStats();
        tabs.forEach(t => t.classList.remove('active')); tabContents.forEach(tc => tc.classList.remove('active'));
        document.querySelector('.tab[data-tab="battle"]').classList.add('active');
        document.getElementById('battle').classList.add('active');
        saveState();
      }


      function sortInitiative(focusedCreatureId = null) {
        let activeCreatureIdToPreserve = focusedCreatureId;
        if (!activeCreatureIdToPreserve && state.activeBattleIndex >= 0 && state.activeBattle.initiative[state.activeBattleIndex]) {
            activeCreatureIdToPreserve = state.activeBattle.initiative[state.activeBattleIndex].id;
        }
        state.activeBattle.initiative.sort((a, b) => b.initiative - a.initiative);
        if (activeCreatureIdToPreserve) {
            const newActiveIndex = state.activeBattle.initiative.findIndex(c => c.id === activeCreatureIdToPreserve);
            state.activeBattleIndex = (newActiveIndex !== -1) ? newActiveIndex : (state.activeBattle.initiative.length > 0 ? 0 : -1);
        } else if (state.activeBattle.initiative.length > 0) {
            state.activeBattleIndex = 0;
        } else { state.activeBattleIndex = -1; }
      }
      
      function findCreatureAndIndex(creatureId) {
        const idToCompare = parseInt(String(creatureId)); 
        const index = state.activeBattle.initiative.findIndex(c => c.id === idToCompare);
        return index !== -1 ? { creature: state.activeBattle.initiative[index], index } : null;
      }

      function handleIniInputChange(creatureId, newIniString) {
        const newIni = parseInt(newIniString);
        if (isNaN(newIni)) return;
        const data = findCreatureAndIndex(creatureId);
        if (!data) return;
        data.creature.initiative = newIni;
        sortInitiative(data.creature.id); renderInitiativeList(); updateStats(); saveState();
      }

      function handleHpInputChange(creatureId, newHp) {
        if (isNaN(newHp)) return;
        const data = findCreatureAndIndex(creatureId);
        if (!data) return;
        const { creature } = data;
        const oldHp = creature.currentHp;
        creature.currentHp = Math.max(0, newHp);
        const diff = creature.currentHp - oldHp;
        if (diff < 0) {
            if (creature.type === 'monster' || creature.type === 'npc') state.activeBattle.stats.playerDamage += Math.abs(diff);
            else state.activeBattle.stats.monsterDamage += Math.abs(diff);
            if (creature.currentHp === 0 && oldHp > 0 && (creature.type === 'player' || creature.type === 'ally')) state.activeBattle.stats.unconsciousPlayers++;
            if (Math.abs(diff) > state.activeBattle.stats.highestDamage) state.activeBattle.stats.highestDamage = Math.abs(diff);
            if ((creature.type === 'monster' || creature.type === 'npc') && creature.currentHp === 0 && oldHp > 0) state.activeBattle.stats.defeatedMonsters++;
        } else if (diff > 0) {
            state.activeBattle.stats.healing += diff;
            if (creature.currentHp > 0 && oldHp === 0 && (creature.type === 'player' || creature.type === 'ally')) state.activeBattle.stats.unconsciousPlayers = Math.max(0, state.activeBattle.stats.unconsciousPlayers - 1);
        }
        if (creature.currentHp > creature.maxHp) creature.currentHp = creature.maxHp;
        renderInitiativeList(); updateStats(); saveState();
      }

      function handleAcInputChange(creatureId, newAc) {
        if (isNaN(newAc)) return;
        const data = findCreatureAndIndex(creatureId);
        if (!data) return;
        data.creature.ac = Math.max(0, newAc);
        renderInitiativeList(); saveState();
      }

      function modifyCreatureHP(creatureId, amount) { 
        const data = findCreatureAndIndex(creatureId);
        if (!data) return;
        handleHpInputChange(creatureId, data.creature.currentHp + amount);
      }
      
      function removeCreatureFromBattle(creatureIdToRemove) {
        const indexToRemove = state.activeBattle.initiative.findIndex(c => c.id === creatureIdToRemove);
        if (indexToRemove === -1) return;

        const removedCreature = state.activeBattle.initiative[indexToRemove];

        const wasActive = state.activeBattleIndex === indexToRemove;
        let idToPreserveFocus = null;
        if (!wasActive && state.activeBattleIndex !== -1 && state.activeBattle.initiative[state.activeBattleIndex]) {
             idToPreserveFocus = state.activeBattle.initiative[state.activeBattleIndex].id;
        }
        
        state.activeBattle.initiative.splice(indexToRemove, 1);

        // Update monster counter if the removed creature was a numbered monster
        if (removedCreature.type === 'monster' && removedCreature.originalName && state.monsterNameCounters[removedCreature.originalName]) {
            // This logic is tricky: if we remove "Goblin 2" out of 3, we don't just decrement the counter.
            // For simplicity, we'll just let the counter be as is. New additions will continue from the highest number.
            // A more complex solution would involve re-numbering or tracking available numbers.
        }


        if (state.activeBattle.initiative.length === 0) {
            state.activeBattleIndex = -1;
        } else {
            if (idToPreserveFocus) { 
                const newIdx = state.activeBattle.initiative.findIndex(c => c.id === idToPreserveFocus);
                state.activeBattleIndex = (newIdx !== -1) ? newIdx : 0;
            } else if (wasActive) { 
                state.activeBattleIndex = Math.min(indexToRemove, state.activeBattle.initiative.length - 1);
                if (state.activeBattleIndex < 0) state.activeBattleIndex = 0; 
            } else if (indexToRemove < state.activeBattleIndex) { 
                 state.activeBattleIndex--;
            }
            if (state.activeBattleIndex >= state.activeBattle.initiative.length) { 
                state.activeBattleIndex = state.activeBattle.initiative.length -1;
            }
        }
        sortInitiative(state.activeBattle.initiative[state.activeBattleIndex]?.id); 
        renderInitiativeList(); updateStats(); saveState();
      }

      function toggleCreatureStatus(creatureId, status) {
        const data = findCreatureAndIndex(creatureId);
        if (!data) return;
        const { creature } = data;
        if (!creature.statuses) creature.statuses = [];
        const statusIndex = creature.statuses.indexOf(status);
        if (statusIndex > -1) creature.statuses.splice(statusIndex, 1);
        else creature.statuses.push(status);
        renderInitiativeList(); saveState();
      }

      function renderInitiativeList() {
        initiativeList.innerHTML = '';
        if (state.activeBattle.initiative.length === 0) {
            initiativeList.innerHTML = '<div style="padding: 20px; text-align:center;">Keine Kampfteilnehmer.</div>';
            updateStats(); return;
        }
        state.activeBattle.initiative.forEach((creature, index) => {
            const item = document.createElement('div');
            item.className = `initiative-item ${creature.type || 'unknown'} ${index === state.activeBattleIndex ? 'active' : ''}`;
            item.dataset.creatureId = creature.id;

            const hpPercentage = creature.maxHp > 0 ? (creature.currentHp / creature.maxHp) * 100 : (creature.currentHp > 0 ? 100 : 0);
            let hpColor = '#4CAF50';
            if (creature.currentHp <= 0) hpColor = '#757575'; else if (hpPercentage < 25) hpColor = '#F44336';
            else if (hpPercentage < 50) hpColor = '#FF9800'; else if (hpPercentage < 75) hpColor = '#FFC107';

            const statusTooltips = {poisoned:"Vergiftet",charmed:"Verzaubert",frightened:"Verängstigt",stunned:"Betäubt",paralyzed:"Gelähmt",invisible:"Unsichtbar",concentrating:"Konzentriert",blessed:"Gesegnet"};
            const statusBadgeHTML = Object.keys(statusTooltips).map(key => `<div class="status-badge ${creature.statuses && creature.statuses.includes(key) ? 'active':''}" data-status="${key}" title="${statusTooltips[key]}"><span class="status-tooltip">${statusTooltips[key]}</span></div>`).join('');

            item.innerHTML = `
                <div class="initiative-main-info">
                    <div class="initiative-item-drag">⋮</div>
                    <div class="initiative-name-type-container">
                        <div class="initiative-name">${creature.name}</div>
                        <small class="initiative-type-display">Typ: ${creature.type}</small>
                    </div>
                    <div class="initiative-info-stats">
                        <div class="initiative-stat">
                            <label for="ini-${creature.id}" class="initiative-stat-label">Ini</label>
                            <input type="number" id="ini-${creature.id}" class="form-input initiative-value-input" value="${creature.initiative}" data-field="initiative" data-creature-id="${creature.id}">
                        </div>
                        <div class="initiative-stat">
                            <label for="hp-${creature.id}" class="initiative-stat-label">HP</label>
                            <input type="number" id="hp-${creature.id}" class="form-input initiative-value-input" value="${creature.currentHp}" data-field="hp" data-creature-id="${creature.id}" style="color: ${hpColor};">
                            <div class="initiative-controls">
                                <button class="initiative-btn" data-action="hp-dmg" data-creature-id="${creature.id}" title="Schaden">-</button>
                                <button class="initiative-btn" data-action="hp-heal" data-creature-id="${creature.id}" title="Heilen">+</button>
                            </div>
                        </div>
                        <div class="initiative-stat">
                            <label for="ac-${creature.id}" class="initiative-stat-label">AC</label>
                            <input type="number" id="ac-${creature.id}" class="form-input initiative-value-input" value="${creature.ac}" data-field="ac" data-creature-id="${creature.id}">
                        </div>
                    </div>
                    <div class="initiative-side-actions">
                         <button class="btn btn-sm initiative-remove-btn" data-action="remove-creature" data-creature-id="${creature.id}" title="Entfernen">×</button>
                    </div>
                </div>
                <div class="initiative-status-and-notes">
                    <div class="initiative-status">${statusBadgeHTML}</div>
                    <textarea class="form-input creature-notes-textarea" placeholder="Notizen für ${creature.name}..." data-creature-id="${creature.id}">${creature.notes || ''}</textarea>
                </div>
            `;
            
            item.querySelectorAll('.initiative-value-input').forEach(input => {
                input.addEventListener('change', (e) => {
                    const field = e.target.dataset.field;
                    const value = e.target.value; 
                    const creatureId = parseInt(e.target.dataset.creatureId);
                    if (field === 'hp') handleHpInputChange(creatureId, parseInt(value));
                    else if (field === 'ac') handleAcInputChange(creatureId, parseInt(value));
                    else if (field === 'initiative') handleIniInputChange(creatureId, parseInt(value));
                });
                input.addEventListener('focus', () => { 
                  const creatureId = parseInt(input.dataset.creatureId);
                  const focusedIndex = state.activeBattle.initiative.findIndex(c => c.id === creatureId);
                  if(focusedIndex !== -1) state.activeBattleIndex = focusedIndex;
                });
            });
            item.querySelector('[data-action="hp-dmg"]').addEventListener('click', (e) => { e.stopPropagation(); modifyCreatureHP(parseInt(e.target.dataset.creatureId), -1); });
            item.querySelector('[data-action="hp-heal"]').addEventListener('click', (e) => { e.stopPropagation(); modifyCreatureHP(parseInt(e.target.dataset.creatureId), 1); });
            item.querySelectorAll('.status-badge').forEach(badge => badge.addEventListener('click', (e) => { e.stopPropagation(); toggleCreatureStatus(parseInt(badge.closest('.initiative-item').dataset.creatureId), badge.dataset.status); }));
            
            const notesTextarea = item.querySelector('.creature-notes-textarea');
            notesTextarea.addEventListener('change', (e) => {
                const creatureId = parseInt(e.target.dataset.creatureId);
                const foundCreature = state.activeBattle.initiative.find(c => c.id === creatureId);
                if (foundCreature) { foundCreature.notes = e.target.value; saveState(); }
            });
            notesTextarea.addEventListener('focus', (e) => { 
                const creatureId = parseInt(e.target.dataset.creatureId);
                const focusedIndex = state.activeBattle.initiative.findIndex(c => c.id === creatureId);
                if(focusedIndex !== -1) state.activeBattleIndex = focusedIndex;
            });

            item.querySelector('[data-action="remove-creature"]').addEventListener('click', (e) => { e.stopPropagation(); removeCreatureFromBattle(parseInt(e.target.dataset.creatureId)); });
            initiativeList.appendChild(item);
        });
        updateStats();
      }
      
      function nextTurn() {
        if (state.activeBattle.initiative.length === 0) return;
        state.activeBattleIndex++;
        if (state.activeBattleIndex >= state.activeBattle.initiative.length) {
            state.activeBattleIndex = 0;
        }
        renderInitiativeList(); saveState();
      }

      function nextRound() {
        if (state.activeBattle.initiative.length === 0) { alert("Füge zuerst Kämpfer hinzu."); return; }
        state.activeBattle.round++;
        roundCounter.textContent = state.activeBattle.round;
        state.activeBattleIndex = 0; 
        renderInitiativeList(); updateStats(); saveState();
      }

      function endBattle() {
        updateStats(); 
        const oldActiveEffects = [...state.activeBattle.activeEffects]; 
        state.activeBattle = {
            round: 1, initiative: [], activeEffects: [], 
            stats: { playerDamage:0, monsterDamage:0, healing:0, highestDamage:0, defeatedMonsters:0, unconsciousPlayers:0, playerCrits:0, monsterCrits:0 }
        };
        state.monsterNameCounters = {}; // Reset monster counters
        state.activeBattleIndex = -1;
        roundCounter.textContent = '1';
        renderInitiativeList();
        document.querySelectorAll('.environment-card').forEach(card => {
            card.classList.remove('active');
            const btn = card.querySelector('.toggle-effect');
            if(btn) btn.textContent = 'Aktivieren';
        });
        renderActiveEffectsInBattleView(); 
        endBattleModal.classList.remove('active');
        tabs.forEach(t => t.classList.remove('active')); tabContents.forEach(tc => tc.classList.remove('active'));
        document.querySelector('.tab[data-tab="stats"]').classList.add('active');
        document.getElementById('stats').classList.add('active');
        saveState();
      }

      function updateStats() {
        const totalParticipants = state.activeBattle.initiative.length;
        const avgInitiative = totalParticipants > 0 ? (state.activeBattle.initiative.reduce((sum, c) => sum + (c.initiative || 0), 0) / totalParticipants) : 0;
        document.getElementById('stat-combat-duration').textContent = `${state.activeBattle.round} Runden`;
        document.getElementById('stat-participants').textContent = totalParticipants;
        document.getElementById('stat-avg-initiative').textContent = avgInitiative.toFixed(1);
        document.getElementById('stat-status').textContent = totalParticipants > 0 ? 'Aktiv' : 'Beendet/Inaktiv';
        document.getElementById('stat-player-damage').textContent = state.activeBattle.stats.playerDamage;
        document.getElementById('stat-monster-damage').textContent = state.activeBattle.stats.monsterDamage;
        document.getElementById('stat-healing').textContent = state.activeBattle.stats.healing;
        document.getElementById('stat-highest-damage').textContent = state.activeBattle.stats.highestDamage;
        document.getElementById('stat-defeated-monsters').textContent = state.activeBattle.stats.defeatedMonsters;
        document.getElementById('stat-unconscious-players').textContent = state.activeBattle.stats.unconsciousPlayers;
        document.getElementById('stat-player-crits').textContent = state.activeBattle.stats.playerCrits;
        document.getElementById('stat-monster-crits').textContent = state.activeBattle.stats.monsterCrits;
      }

      function exportStatistics() {
        const statsToExport = {
            battleEnded: new Date().toLocaleString(), totalRounds: state.activeBattle.round, totalParticipants: state.activeBattle.initiative.length,
            initiativeDetails: state.activeBattle.initiative.map(c => ({name:c.name, type:c.type, ini:c.initiative, finalHp:c.currentHp, maxHp:c.maxHp, notes:c.notes})),
            damageByPlayers: state.activeBattle.stats.playerDamage, damageByMonsters: state.activeBattle.stats.monsterDamage,
            totalHealing: state.activeBattle.stats.healing, highestSingleDamage: state.activeBattle.stats.highestDamage,
            monstersDefeated: state.activeBattle.stats.defeatedMonsters, playersUnconscious: state.activeBattle.stats.unconsciousPlayers,
            activeEnvironmentEffects: state.activeBattle.activeEffects.map(ef => ef.name)
        };
        const statsText = JSON.stringify(statsToExport, null, 2);
        const blob = new Blob([statsText], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = `kampfstatistik_${new Date().toISOString().replace(/:/g,'-').split('.')[0]}.json`;
        document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
      }

      function toggleEnvironmentEffect(effectId, effectName, effectDesc) {
        const effectIndex = state.activeBattle.activeEffects.findIndex(e => e.id === effectId);
        if (effectIndex > -1) {
            state.activeBattle.activeEffects.splice(effectIndex, 1);
        } else {
            state.activeBattle.activeEffects.push({ id: effectId, name: effectName, description: effectDesc });
        }
        saveState();
        renderActiveEnvironmentEffects(); 
        renderActiveEffectsInBattleView(); 
      }
      
      function renderActiveEnvironmentEffects() { 
        document.querySelectorAll('.environment-card').forEach(card => {
            const effectId = card.dataset.effect;
            const toggleBtn = card.querySelector('.toggle-effect');
            if (state.activeBattle.activeEffects.some(e => e.id === effectId)) {
                card.classList.add('active');
                if(toggleBtn) toggleBtn.textContent = 'Deaktivieren';
            } else {
                card.classList.remove('active');
                if(toggleBtn) toggleBtn.textContent = 'Aktivieren';
            }
        });
      }

      function renderActiveEffectsInBattleView() { 
        if (!currentBattleEnvList) return;
        currentBattleEnvList.innerHTML = '';
        if (state.activeBattle.activeEffects.length === 0) {
            currentBattleEnvList.innerHTML = '<li>Keine aktiven Effekte.</li>';
            return;
        }
        state.activeBattle.activeEffects.forEach(effect => {
            const listItem = document.createElement('li');
            listItem.textContent = `• ${effect.name || 'Unbenannter Effekt'}`;
            if(effect.description) listItem.title = effect.description; 
            currentBattleEnvList.appendChild(listItem);
        });
      }

      function addCustomEffect() {
        const name = effectNameInput.value.trim();
        const desc = effectDescInput.value.trim();
        if (!name) { alert('Bitte gib einen Namen für den Effekt ein.'); return; }
        const effectId = `custom_${generateUniqueId()}`;
        
        const card = document.createElement('div');
        card.className = 'environment-card'; card.dataset.effect = effectId;
        card.innerHTML = `<h3 class="environment-name">${name}</h3><p class="environment-desc">${desc}</p><button class="btn btn-sm toggle-effect">Aktivieren</button>`;
        
        const toggleBtn = card.querySelector('.toggle-effect');
        toggleBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            toggleEnvironmentEffect(effectId, name, desc);
        });
        document.querySelector('#environment .environment-grid').appendChild(card); 
        effectNameInput.value = ''; effectDescInput.value = '';
      }

      function renderGroupPreview() {
        const selectedMonsterElements = Array.from(document.querySelectorAll('.monster-card.selected'));
        const groupList = document.getElementById('group-monsters-list');
        groupList.innerHTML = '';
        if (selectedMonsterElements.length === 0) {
            groupList.innerHTML = '<p>Keine Monster ausgewählt.</p>'; return;
        }
        const ul = document.createElement('ul');
        ul.style.listStyleType = 'none'; ul.style.paddingLeft = '0';
        selectedMonsterElements.forEach(cardElement => {
            const monster = state.monsters.find(m => String(m.id) === cardElement.dataset.id);
            if (monster) {
                const li = document.createElement('li');
                li.style.padding = '5px 0'; li.style.borderBottom = '1px solid rgba(255,255,255,0.1)';
                li.textContent = `${monster.name} (CR ${monster.cr || 'N/A'})`;
                ul.appendChild(li);
            }
        });
        groupList.appendChild(ul);
      }

      function saveMonsterGroup() {
        const name = document.getElementById('group-name').value.trim();
        if (!name) { alert('Bitte gib einen Namen für die Gruppe ein.'); return; }
        const selectedMonsterIds = Array.from(document.querySelectorAll('.monster-card.selected')).map(card => parseInt(card.dataset.id));
        if (selectedMonsterIds.length === 0) { alert('Keine Monster ausgewählt.'); return; }
        const newGroup = {
            id: generateUniqueId(), name, description: document.getElementById('group-desc').value.trim(),
            monsters: selectedMonsterIds 
        };
        state.savedGroups.push(newGroup); saveState();
        saveGroupModal.classList.remove('active');
        document.getElementById('group-name').value = ''; document.getElementById('group-desc').value = '';
        document.querySelectorAll('.monster-card.selected').forEach(card => card.classList.remove('selected'));
      }

      function renderSavedGroups() {
        const groupsListContainer = document.getElementById('groups-list');
        groupsListContainer.innerHTML = '';
        if (state.savedGroups.length === 0) { groupsListContainer.innerHTML = '<p>Keine Gruppen.</p>'; return; }
        state.savedGroups.forEach(group => {
            const monsterDetails = group.monsters.map(id => {
                const monster = state.monsters.find(m => m.id === id);
                return monster ? `${monster.name} (CR ${monster.cr || 'N/A'})` : 'Unbekannt';
            }).join(', ');
            const groupItem = document.createElement('div'); groupItem.className = 'group-item';
            groupItem.innerHTML = `<div><div class="group-name">${group.name}</div><div class="group-details">${group.description || ''}</div><div class="group-details" style="font-size:0.8em;">${group.monsters.length} Monster: ${monsterDetails}</div></div><div class="group-actions"><button class="btn btn-sm btn-primary" data-action="add-group">Zu Kampf</button><button class="btn btn-sm btn-danger" data-action="delete-group">Löschen</button></div>`;
            groupItem.querySelector('[data-action="add-group"]').addEventListener('click', () => { addGroupToBattle(group); manageGroupsModal.classList.remove('active'); });
            groupItem.querySelector('[data-action="delete-group"]').addEventListener('click', () => deleteGroup(group.id));
            groupsListContainer.appendChild(groupItem);
        });
      }

      function addGroupToBattle(group) {
        if (!group || !group.monsters) return;
        // For groups, we can decide if we want individual quantity prompts or add them all as single units.
        // For now, let's add them as single units, respecting the numbering.
        group.monsters.forEach(monsterId => {
            const monster = state.monsters.find(m => m.id === monsterId);
            if (monster) {
                 // Create a deep copy to avoid modifying the original monster data from state.monsters
                const monsterCopy = JSON.parse(JSON.stringify(monster));
                addMonsterToBattle(monsterCopy, 1); // Add 1 of each monster from the group
            }
        });
        tabs.forEach(t => t.classList.remove('active')); tabContents.forEach(tc => tc.classList.remove('active'));
        document.querySelector('.tab[data-tab="battle"]').classList.add('active'); document.getElementById('battle').classList.add('active');
      }

      function deleteGroup(groupId) {
        if (confirm('Sicher, dass du diese Gruppe löschen willst?')) {
            state.savedGroups = state.savedGroups.filter(g => g.id !== groupId);
            saveState(); renderSavedGroups();
        }
      }
      
      init();
    </script>
</body>
</html>